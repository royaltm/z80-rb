<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Z80::MathInt::Macros - ruby-Z80</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-add24_16">#add24_16</a>
    
    <li ><a href="#method-i-adda_to">#adda_to</a>
    
    <li ><a href="#method-i-bcdtoa">#bcdtoa</a>
    
    <li ><a href="#method-i-cmp_i16n">#cmp_i16n</a>
    
    <li ><a href="#method-i-cmp_i16r">#cmp_i16r</a>
    
    <li ><a href="#method-i-cmp_i8">#cmp_i8</a>
    
    <li ><a href="#method-i-divmod">#divmod</a>
    
    <li ><a href="#method-i-divmod16">#divmod16</a>
    
    <li ><a href="#method-i-divmod16_8">#divmod16_8</a>
    
    <li ><a href="#method-i-divmod24_8">#divmod24_8</a>
    
    <li ><a href="#method-i-divmod32_16">#divmod32_16</a>
    
    <li ><a href="#method-i-divmod32_8">#divmod32_8</a>
    
    <li ><a href="#method-i-divmod8">#divmod8</a>
    
    <li ><a href="#method-i-int">#int</a>
    
    <li ><a href="#method-i-leading_zeros">#leading_zeros</a>
    
    <li ><a href="#method-i-mul">#mul</a>
    
    <li ><a href="#method-i-mul16">#mul16</a>
    
    <li ><a href="#method-i-mul16_32">#mul16_32</a>
    
    <li ><a href="#method-i-mul16_signed">#mul16_signed</a>
    
    <li ><a href="#method-i-mul16_signed9">#mul16_signed9</a>
    
    <li ><a href="#method-i-mul8">#mul8</a>
    
    <li ><a href="#method-i-mul8_24">#mul8_24</a>
    
    <li ><a href="#method-i-mul8_24a">#mul8_24a</a>
    
    <li ><a href="#method-i-mul8_c">#mul8_c</a>
    
    <li ><a href="#method-i-mul8_signed">#mul8_signed</a>
    
    <li ><a href="#method-i-mul_const">#mul_const</a>
    
    <li ><a href="#method-i-mul_const8_24">#mul_const8_24</a>
    
    <li ><a href="#method-i-mul_const8_24a">#mul_const8_24a</a>
    
    <li ><a href="#method-i-mul_const_ex">#mul_const_ex</a>
    
    <li ><a href="#method-i-mul_signed">#mul_signed</a>
    
    <li ><a href="#method-i-mul_signed9">#mul_signed9</a>
    
    <li ><a href="#method-i-mul_signed9_24">#mul_signed9_24</a>
    
    <li ><a href="#method-i-neg16">#neg16</a>
    
    <li ><a href="#method-i-neg_int">#neg_int</a>
    
    <li ><a href="#method-i-rnd">#rnd</a>
    
    <li ><a href="#method-i-sign_extend">#sign_extend</a>
    
    <li ><a href="#method-i-sll8_16">#sll8_16</a>
    
    <li ><a href="#method-i-sub_from">#sub_from</a>
    
    <li ><a href="#method-i-trailing_zeros">#trailing_zeros</a>
    
    <li ><a href="#method-i-twos_complement16_by_sgn">#twos_complement16_by_sgn</a>
    
    <li ><a href="#method-i-utobcd">#utobcd</a>
    
    <li ><a href="#method-i-utobcd_step">#utobcd_step</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Z80::MathInt::Macros">
  <h1 id="module-Z80::MathInt::Macros" class="module">
    module Z80::MathInt::Macros
  </h1>

  <section class="description">
    
<h1 id="module-Z80::MathInt::Macros-label-Z80-3A-3AMathInt+Macros"><a href="../MathInt.html"><code>Z80::MathInt</code></a> <a href="Macros.html"><code>Macros</code></a><span><a href="#module-Z80::MathInt::Macros-label-Z80-3A-3AMathInt+Macros">&para;</a> <a href="#top">&uarr;</a></span></h1>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-add24_16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add24_16</span><span
            class="method-args">(th8=c, tl16=hl, tt=de, signed:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that adds a 16-bit integer in <code>tt</code> to a 24-bit integer in <code>th8</code>|<code>tl16</code>. Returns the result in <code>a</code>|<code>tl16</code>.</p>
<dl class="rdoc-list note-list"><dt><code>th8</code>
<dd>
<p>An 8-bit register holding the highest 8 bits of the value to be added to, must not be the <code>accumulator</code>.</p>
</dd><dt><code>tl16</code>
<dd>
<p>A 16-bit register holding the lowest 16 bits of the value to be added to (<code>hl</code>, <code>ix</code> or <code>iy</code>).</p>
</dd><dt><code>tt</code>
<dd>
<p>A 16-bit register holding the value to be added (<code>bc</code>, <code>de</code> or <code>sp</code>).</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>signed</code>
<dd>
<p><code>true</code> if the 16-bit value being added is a twos complement signed integer.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>tl16</code>, preserves: <code>th8</code>.</p>

<p>T-states: 27 signed / 19 unsigned</p>
          
          

          
          <div class="method-source-code" id="add24_16-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 504</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add24_16</span>(<span class="ruby-identifier">th8</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">tl16</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>=<span class="ruby-identifier">de</span>, <span class="ruby-value">signed:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">tlh</span>, <span class="ruby-identifier">tll</span> = <span class="ruby-identifier">tl16</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>, <span class="ruby-identifier">sp</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">ix</span>, <span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tl16</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">tlh</span>, <span class="ruby-identifier">tll</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">th8</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;add24_16: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">th</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">tl16</span>, <span class="ruby-identifier">tt</span>
            <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">th8</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adda_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adda_to</span><span
            class="method-args">(th, tl, oh:th, ol:tl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that adds an 8-bit accumulator value to a 16-bit value in a <code>th</code>|<code>tl</code> register pair.</p>
<dl class="rdoc-list note-list"><dt><code>th</code>
<dd>
<p>An 8-bit register containing MSB bits of the 16-bit value.</p>
</dd><dt><code>tl</code>
<dd>
<p>An 8-bit register containing LSB bits of the 16-bit value.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>oh</code>
<dd>
<p>An output MSB 8-bit register, <code>th</code> by default.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ol</code>
<dd>
<p>An output LSB 8-bit register, <code>tl</code> by default.</p>
</dd></dl>
</li></ul>

<p>As a side effect: <code>a</code> equals <code>oh</code> when the routine ends.</p>

<h4 id="method-i-adda_to-label-Note-3A">Note:<span><a href="#method-i-adda_to-label-Note-3A">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Although this method is often a more convenient way to add an 8-bit unsigned integer to a 16-bit pair of registers, it sets flags in the following way:</p>

<pre>ZF: (tt + a) &amp; 0xFF00 == 0
CF: (((tt + a) &amp; 0xFF) + (((tt + a) &amp; 0xFF00) &gt;&gt; 8)) &gt; 0xFF</pre>

<p>Modifies: <code>af</code>, <code>oh</code>, <code>ol</code>.</p>

<p>T-states: 16|20</p>
          
          

          
          <div class="method-source-code" id="adda_to-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 443</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">adda_to</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-value">oh:</span><span class="ruby-identifier">th</span>, <span class="ruby-value">ol:</span><span class="ruby-identifier">tl</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">oh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ol</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ol</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-keyword">or</span>  [<span class="ruby-identifier">th</span>,<span class="ruby-identifier">tl</span>,<span class="ruby-identifier">ol</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;adda_to: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ol</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">th</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">ol</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">oh</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">oh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bcdtoa" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bcdtoa</span><span
            class="method-args">(buffer=hl, size=b, skip_leading0:false, preserve_in:nil, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that reads BCD digits from the memory buffer, one at a time, into the accumulator.</p>

<p>As a side effect the buffer will be zeroed after execution of this routine unless <code>preserve_in</code> is set.</p>

<p>Provide a <code>block</code> of code which will receive digits. The block will be inserted twice. On the first digit CF=1, on subsequent CF=0. Alternatively set <code>skip_leading0:</code> to <code>true</code>. In this instance CF will be always 0 and the block will not be evaluated if the first digit is 0. The <code>block</code> should produce a relatively small code (&lt; 60 bytes).</p>
<dl class="rdoc-list note-list"><dt><code>buffer</code>
<dd>
<p>A memory address of the beginning of the BCD data as an integer, a label, a pointer or <code>hl</code>.</p>
</dd><dt><code>size</code>
<dd>
<p>The size in bytes of the BCD data as an integer, a label, a pointer or an 8-bit register.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>skip_leading0</code>
<dd>
<p>If true the <code>block</code> will not be executed on the first digit if it&#39;s 0.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>preserve_in</code>
<dd>
<p>An optional register: <code>c</code>, <code>d</code> or <code>e</code> which will preserve the current value of the processed byte of the buffer.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>The code in <code>block</code> must preserve <code>hl</code>, <code>b</code> and <code>preserve_in</code> registers if set.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>b</code> and optionally <code>preserve_in</code>.</p>

<p>Example:</p>

<pre class="ruby">    <span class="ruby-identifier">bcdtoa</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">b</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">pr1</span>  <span class="ruby-comment"># skip zero check if not first</span>
      <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>   <span class="ruby-comment"># skip leading 0</span>
<span class="ruby-identifier">pr1</span>   <span class="ruby-identifier">add</span> <span class="ruby-value">?0</span>.<span class="ruby-identifier">ord</span>
      <span class="ruby-identifier">rst</span> <span class="ruby-value">0x10</span>     <span class="ruby-comment"># print a character</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># or</span>
    <span class="ruby-identifier">bcdtoa</span>(<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">b</span>, <span class="ruby-value">skip_leading0:</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">add</span> <span class="ruby-value">?0</span>.<span class="ruby-identifier">ord</span>
      <span class="ruby-identifier">rst</span> <span class="ruby-value">0x10</span>     <span class="ruby-comment"># print a character</span>
    <span class="ruby-keyword">end</span>
</pre>
          
          

          
          <div class="method-source-code" id="bcdtoa-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3833</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bcdtoa</span>(<span class="ruby-identifier">buffer</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">size</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">skip_leading0:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">preserve_in:</span><span class="ruby-keyword">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">buffer</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">buffer</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>) <span class="ruby-keyword">and</span>
                               (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">size</span>.<span class="ruby-identifier">bit8?</span>)) <span class="ruby-keyword">and</span>
                               (<span class="ruby-operator">!</span><span class="ruby-identifier">preserve_in</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">c</span>,<span class="ruby-identifier">d</span>,<span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">preserve_in</span>))
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">size</span>)
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">size</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">b</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">size</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">buffer</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">buffer</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_leading0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">preserve_in</span>, [<span class="ruby-identifier">hl</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">preserve_in</span>
                <span class="ruby-identifier">rld</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">noskip0</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">skip0</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">scf</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">loop_a</span>      <span class="ruby-identifier">label</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">preserve_in</span>, [<span class="ruby-identifier">hl</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">preserve_in</span>
                <span class="ruby-identifier">rld</span>
    <span class="ruby-identifier">noskip0</span>     <span class="ruby-identifier">ns</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
    <span class="ruby-identifier">skip0</span>       <span class="ruby-identifier">rld</span>
                <span class="ruby-identifier">ns</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">preserve_in</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">preserve_in</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loop_a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cmp_i16n" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cmp_i16n</span><span
            class="method-args">(th, tl, value, lt:nil, gt:nil, eq:nil, jump_rel:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Compares a bitwise concatenated pair of 8-bit values <code>th</code>|<code>tl</code> with a <code>value</code> as twos complement signed 16-bit integers.</p>

<p>Provide <code>value</code> as an integer or a label.</p>

<p>Options:</p>
<ul><li>
<p><code>lt</code>: provide a label to jump to or <code>:ret</code> when <code>th</code>|<code>tl</code> &lt; <code>value</code>.</p>
</li><li>
<p><code>gt</code>: provide a label to jump to or <code>:ret</code> when <code>th</code>|<code>tl</code> &gt; <code>value</code>.</p>
</li><li>
<p><code>eq</code>: provide a label to jump to or <code>:ret</code> when <code>th</code>|<code>tl</code> = <code>value</code>.</p>
</li><li>
<p><code>jump_rel</code>: set to <code>true</code> to use relative jumps wherever applicable.</p>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>At least <code>lt</code> or <code>gt</code> must be provided. Only two of: <code>lt</code>, <code>gt</code> and <code>eq</code> may be specified.</p>
</dd></dl>

<p>Modifies: <code>af</code>.</p>
          
          

          
          <div class="method-source-code" id="cmp_i16n-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 192</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cmp_i16n</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">value</span>, <span class="ruby-value">lt:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">gt:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">eq:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">jump_rel:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">cmp_i16r</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>, <span class="ruby-identifier">value</span>, <span class="ruby-value">lt:</span><span class="ruby-identifier">lt</span>, <span class="ruby-value">gt:</span><span class="ruby-identifier">gt</span>, <span class="ruby-value">eq:</span><span class="ruby-identifier">eq</span>, <span class="ruby-value">jump_rel:</span><span class="ruby-identifier">jump_rel</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cmp_i16r" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cmp_i16r</span><span
            class="method-args">(th, tl, sh, sl, lt:nil, gt:nil, eq:nil, jump_rel:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Compares a bitwise concatenated pair of 8-bit values <code>th</code>|<code>tl</code> with another pair <code>sh</code>|<code>sl</code> as twos complement signed 16-bit integers.</p>

<p>Options:</p>
<ul><li>
<p><code>lt</code>: provide a label to jump to or <code>:ret</code> when <code>th</code>|<code>tl</code> &lt; <code>sh</code>|<code>sl</code>.</p>
</li><li>
<p><code>gt</code>: provide a label to jump to or <code>:ret</code> when <code>th</code>|<code>tl</code> &gt; <code>sh</code>|<code>sl</code>.</p>
</li><li>
<p><code>eq</code>: provide a label to jump to or <code>:ret</code> when <code>th</code>|<code>tl</code> = <code>sh</code>|<code>sl</code>.</p>
</li><li>
<p><code>jump_rel</code>: set to <code>true</code> to use relative jumps wherever applicable.</p>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>At least <code>lt</code> or <code>gt</code> must be provided. Only two of: <code>lt</code>, <code>gt</code> and <code>eq</code> may be specified.</p>
</dd></dl>

<p>Modifies: <code>af</code>.</p>
          
          

          
          <div class="method-source-code" id="cmp_i16r-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 209</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cmp_i16r</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>, <span class="ruby-value">lt:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">gt:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">eq:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">jump_rel:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;only th can be the accumulator&quot;</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">tl</span>, <span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lt, gt or eq should be labels if specified&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">lt</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">lt</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span> <span class="ruby-keyword">or</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lt</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lt</span>))) <span class="ruby-keyword">and</span>
                                                                             (<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">gt</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span> <span class="ruby-keyword">or</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">gt</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">gt</span>))) <span class="ruby-keyword">and</span>
                                                                             (<span class="ruby-identifier">eq</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">eq</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span> <span class="ruby-keyword">or</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">eq</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">eq</span>)))
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;specify at least one of: lt or gt&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gt</span> <span class="ruby-keyword">or</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">lt</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">gt</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;specify at most two of: lt, gt or eq&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">gt</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">eq</span>
    <span class="ruby-identifier">gte</span> = <span class="ruby-identifier">gt</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eq</span>
    <span class="ruby-identifier">jump</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-identifier">cond</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">jump_rel</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cond</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">jr_ok?</span>)
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">th</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">sh</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>                          <span class="ruby-comment"># 8bit optimization</span>
                    <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">sh</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">Z</span>, <span class="ruby-identifier">equal_msb</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sh</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>                      <span class="ruby-comment"># 8bit optimization</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NV</span>, <span class="ruby-identifier">no_xor</span>         <span class="ruby-comment"># VF: 0, no XORing</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-value">0x80</span>               <span class="ruby-comment"># SF: SF ^ VF</span>
            <span class="ruby-identifier">no_xor</span>  <span class="ruby-identifier">label</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">M</span>, <span class="ruby-identifier">lt</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">P</span>, <span class="ruby-identifier">gt</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gt</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">lt</span> <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">gt</span>
        <span class="ruby-identifier">equal_msb</span>   <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">cp</span>   <span class="ruby-identifier">sl</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">gte</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">NC</span>, <span class="ruby-identifier">gte</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">gt</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">C</span>, <span class="ruby-identifier">lt</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">gt</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eq</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">NC</span>, <span class="ruby-identifier">gt</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eq</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">eq</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">C</span>, <span class="ruby-identifier">lt</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cmp_i8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cmp_i8</span><span
            class="method-args">(va, vb, lt:nil, gt:nil, eq:nil, jump_rel:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Compares <code>va</code> with <code>vb</code> as twos complement signed 8-bit integers.</p>

<p>Provide <code>va</code> and <code>vb</code> as an 8-bit registers, integers or labels.</p>

<p>Options:</p>
<ul><li>
<p><code>lt</code>: provide a label to jump to or <code>:ret</code> when <code>va</code> &lt; <code>vb</code>.</p>
</li><li>
<p><code>gt</code>: provide a label to jump to or <code>:ret</code> when <code>va</code> &gt; <code>vb</code>.</p>
</li><li>
<p><code>eq</code>: provide a label to jump to or <code>:ret</code> when <code>va</code> = <code>vb</code>.</p>
</li><li>
<p><code>jump_rel</code>: set to <code>true</code> to use relative jumps wherever applicable.</p>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>At least <code>lt</code> or <code>gt</code> must be provided. Only two of: <code>lt</code>, <code>gt</code> and <code>eq</code> may be specified.</p>
</dd></dl>

<p>Modifies: <code>af</code>.</p>
          
          

          
          <div class="method-source-code" id="cmp_i8-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 144</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cmp_i8</span>(<span class="ruby-identifier">va</span>, <span class="ruby-identifier">vb</span>, <span class="ruby-value">lt:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">gt:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">eq:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">jump_rel:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;only va can be the accumulator&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">vb</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lt, gt or eq should be labels if specified&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">lt</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">lt</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span> <span class="ruby-keyword">or</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lt</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lt</span>))) <span class="ruby-keyword">and</span>
                                                                             (<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">gt</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span> <span class="ruby-keyword">or</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">gt</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">gt</span>))) <span class="ruby-keyword">and</span>
                                                                             (<span class="ruby-identifier">eq</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">eq</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span> <span class="ruby-keyword">or</span> (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">eq</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">eq</span>)))
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;specify at least one of: lt or gt&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gt</span> <span class="ruby-keyword">or</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">lt</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">gt</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;specify at most two of: lt, gt or eq&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">gt</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">eq</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">va</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">va</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">vb</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">eq</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">Z</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">jump_rel</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eq</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eq</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NV</span>, <span class="ruby-identifier">skip_xor</span>       <span class="ruby-comment"># VF: 0, no XORing</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-value">0x80</span>               <span class="ruby-comment"># SF: SF ^ VF</span>
        <span class="ruby-identifier">skip_xor</span>    <span class="ruby-identifier">label</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">lt</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">M</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">lt</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-constant">M</span>, <span class="ruby-identifier">lt</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">gt</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ret</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">P</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">gt</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-constant">P</span>, <span class="ruby-identifier">gt</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod</span><span
            class="method-args">(k, m, clrrem:true, check0:true, check0_far:false, check1:true, k_leq_m:nil, modulo:false, ignore_cf:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of unsigned 8-bit: <code>k</code> / <code>m</code>. Returns a quotient in <code>k</code> and a remainder in <code>accumulator</code>.</p>

<p>This routine can be chained one after another to divide arbitrary size dividends. Just preserve the <code>a</code> and <code>m</code> registers and pass <code>false</code> to <code>clrrem:</code> on subsequent routines. Start with the most significant byte of the dividend:</p>

<pre class="ruby"><span class="ruby-identifier">ns</span> <span class="ruby-value">:divide24_8</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span> <span class="ruby-comment"># divide (l|de)/c</span>
  <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">l</span>, <span class="ruby-identifier">c</span>, <span class="ruby-value">check0:</span><span class="ruby-identifier">eoc</span>, <span class="ruby-value">check1:</span><span class="ruby-identifier">eoc</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">true</span>
  <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">d</span>, <span class="ruby-identifier">c</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">false</span>
  <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">e</span>, <span class="ruby-identifier">c</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">false</span>
  <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-comment"># clear CF</span>
<span class="ruby-keyword">end</span>
</pre>
<dl class="rdoc-list note-list"><dt><code>k</code>
<dd>
<p>A dividend as an 8-bit register except: <code>a</code>, <code>b</code>.</p>
</dd><dt><code>m</code>
<dd>
<p>A divisor as an 8-bit register except: <code>a</code>, <code>b</code>, <code>k</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>clrrem</code>
<dd>
<p>Clears a reminder (<code>accumulator</code>). If this is <code>false</code>, <code>check0</code>, <code>check1</code> and <code>k_leq_m</code> options are being ignored.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the <code>accumulator</code> is being altered. <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>. It may also be a label (within the relative jump range) to indicate where to jump if <code>m</code> is 0.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check0_far</code>
<dd>
<p>Allow to specify far (outside the relative jump range) <code>check0</code> label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor equals to 1, a hot path optimization. It may also be a label to indicate where to jump if <code>m</code> equals 1.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_leq_m</code>
<dd>
<p>Short circuits if a dividend is equal to or less than a divisor, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ignore_cf</code>
<dd>
<p>Removes instruction to clear CF if <code>check0</code> is also set. This can be used if <code>check0</code> is provided as a label instead of checking the state of the CF flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:size</code>, <code>:time</code>, <code>:unroll</code>, <code>:time_alt</code>, <code>:unroll_alt</code>. The <code>:time_alt</code> and <code>:unroll_alt</code> use undocumented <code>sll</code> instruction.</p>
</dd></dl>
</li></ul>

<h4 id="method-i-divmod-label-Optimization+options-3A">Optimization options:<span><a href="#method-i-divmod-label-Optimization+options-3A">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre>bytes|~avg T-states|max T-states

 options       check       check       check        check          check      no clrrem
optimize        all       0 &amp; km       0 &amp; 1        0 only         none       remainder=0
:size        36|~221|400  34|~216|396  24|~367|389  19|~357|380  13|~336|358  14|~388|410
:time        49|~215|447  47|~210|453  39|~336|436  33|~331|442  27|~310|420  29|~358|460
:time_alt    51|~214|423  49|~209|425  41|~338|412  35|~332|414  30|~316|396  32|~364|436
:unroll     119|~172|301 117|~166|297 110|~256|290 104|~250|286 104|~250|286  80|~282|304
:unroll_alt 164|~161|296 162|~155|298 155|~236|285 149|~230|287 144|~213|269 140|~261|309</pre>

<p>Uses: <code>af</code>, <code>b</code>, <code>k</code>, preserves: <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2945</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check0_far:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">k_leq_m:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span>
        <span class="ruby-identifier">check0</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">k_leq_m</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;divmod: invalid arguments&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">c</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">k</span>) <span class="ruby-keyword">and</span>
                                                            [<span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">c</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">m</span>
    <span class="ruby-identifier">opt_alt</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">optimize</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:time_alt</span>
        <span class="ruby-identifier">optimize</span> = <span class="ruby-value">:time</span>
        <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:unroll_alt</span>
        <span class="ruby-identifier">optimize</span> = <span class="ruby-value">:unroll</span>
        <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:size</span>, <span class="ruby-value">:time</span>, <span class="ruby-value">:unroll</span> <span class="ruby-keyword">then</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;divmod: optimize should be :size, :time, :time_alt, :unroll or :unroll_alt&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_leq_m</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">k_leq_m</span> = (<span class="ruby-identifier">optimize</span> <span class="ruby-operator">!=</span> <span class="ruby-value">:size</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
            <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span>
            <span class="ruby-identifier">check0_far</span> = (<span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:unroll</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">opt_alt</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">k_leq_m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span> 
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">check0_far</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fw_check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">k_leq_m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">divstrt</span>  <span class="ruby-comment"># division by m &gt; 1</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear rest</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># division by 1</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">divone</span>    <span class="ruby-comment"># division by m == 1</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_leq_m</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">k</span>            <span class="ruby-comment"># m &lt; k ?</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">divstrt</span>   <span class="ruby-comment"># m &lt; k</span>
                <span class="ruby-identifier">kislqm</span>  <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">kiseqm</span>    <span class="ruby-comment"># k == m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">k</span>         <span class="ruby-comment"># k &lt;  m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">k</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">kiseqm</span>  <span class="ruby-identifier">label</span>            <span class="ruby-comment"># k == m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">k</span>, <span class="ruby-value">1</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">divone</span>  <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span> 
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                    <span class="ruby-identifier">divone</span>  <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>
                        <span class="ruby-keyword">end</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">kislqm</span>   <span class="ruby-comment"># m &gt;= k</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:unroll</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrrem</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                <span class="ruby-value">7</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>      <span class="ruby-comment"># align highest set bit at CF</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">define_label</span>(<span class="ruby-node">&quot;iter#{i}&quot;</span>).<span class="ruby-identifier">found1</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_leq_m</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">iter7</span>  <span class="ruby-comment"># k == 0x80</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">iter7</span>.<span class="ruby-identifier">found1</span>
            <span class="ruby-identifier">fw_check0</span>   <span class="ruby-identifier">label</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>    <span class="ruby-comment"># k == 0</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_leq_m</span>
                <span class="ruby-identifier">kislqm</span>  <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">kiseqm</span>   <span class="ruby-comment"># k == m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">k</span>        <span class="ruby-comment"># k &lt;  m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">k</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
            <span class="ruby-identifier">fw_check0</span>   <span class="ruby-identifier">label</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">kiseqm</span>  <span class="ruby-identifier">label</span>           <span class="ruby-comment"># k == m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">k</span>, <span class="ruby-value">1</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span> 
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                <span class="ruby-identifier">divone</span>  <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>      <span class="ruby-comment"># clear rest</span>
            <span class="ruby-identifier">fw_check0</span>   <span class="ruby-identifier">label</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">check1</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span> <span class="ruby-comment"># division by 1</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">fw_check0</span>   <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">check1</span>)
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">opt_alt</span>
                <span class="ruby-value">8</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ns</span> <span class="ruby-value">:&quot;iter#{i}&quot;</span> <span class="ruby-keyword">do</span>
                            <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">found1</span>  <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-value">:&quot;fits#{i+1}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-value">:&quot;fits#{i+1}&quot;</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span> <span class="ruby-comment"># clear carry, shift quotient into position</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">modulo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">quitccf</span> <span class="ruby-comment"># clear carry</span>
                <span class="ruby-keyword">else</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-keyword">end</span>
                (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">7</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ns</span> <span class="ruby-value">:&quot;fits#{i}&quot;</span> <span class="ruby-keyword">do</span>
                            <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">sll</span> <span class="ruby-identifier">k</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-value">:&quot;fits#{i+1}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">!=</span> <span class="ruby-value">7</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-value">:&quot;iter#{i+1}&quot;</span>
                        <span class="ruby-keyword">else</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits8</span>
                            <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span> <span class="ruby-comment"># clear carry, shift quotient into position</span>
                            <span class="ruby-keyword">if</span> <span class="ruby-identifier">modulo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span>
                                <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">quitccf</span> <span class="ruby-comment"># clear carry</span>
                            <span class="ruby-keyword">else</span>
                                <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                            <span class="ruby-keyword">end</span>
                        <span class="ruby-keyword">end</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">fits8</span>   <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>
                    <span class="ruby-identifier">quitccf</span> <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">modulo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span> <span class="ruby-comment"># clear carry</span>
                            <span class="ruby-identifier">sll</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span> <span class="ruby-comment"># clear carry, shift quotient into position</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-value">8</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">isolate</span> <span class="ruby-value">:&quot;iter#{i}&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">skipadd</span><span class="ruby-operator">|</span>
                            <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">found1</span>  <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">skipadd</span>
                    <span class="ruby-identifier">fits</span>    <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span> <span class="ruby-comment"># clear carry</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span> <span class="ruby-comment"># optimize != :unroll</span>
            <span class="ruby-identifier">divstrt</span>     <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrrem</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">findhi</span>  <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>            <span class="ruby-comment"># align highest set bit at CF</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">found1</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">findhi</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_leq_m</span> <span class="ruby-comment"># k == 0</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_leq_m</span>
                <span class="ruby-identifier">kislqm</span>  <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">kiseqm</span>   <span class="ruby-comment"># k == m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">k</span>        <span class="ruby-comment"># k &lt;  m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">k</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">kiseqm</span>  <span class="ruby-identifier">label</span>           <span class="ruby-comment"># k == m</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">k</span>, <span class="ruby-value">1</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>       <span class="ruby-comment"># clear rest</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                        <span class="ruby-keyword">end</span>
                    <span class="ruby-keyword">end</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                <span class="ruby-identifier">divone</span>  <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear rest</span>
            <span class="ruby-identifier">fw_check0</span>   <span class="ruby-identifier">label</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">check1</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>       <span class="ruby-comment"># division by 1</span>
                    <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">fw_check0</span>   <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0_far</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">check1</span>)
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span>
                        <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>            <span class="ruby-comment"># carry &lt;- k &lt;- 0 (quotient)</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span> <span class="ruby-comment"># a &gt;= 256</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># a &gt;= m</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># b = 7</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">fits</span>    <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a = a - m (rest)</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">opt_alt</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">modulo</span>
                        <span class="ruby-identifier">sll</span> <span class="ruby-identifier">k</span>            <span class="ruby-comment"># carry &lt;- k &lt;- 1 (quotient)</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">found1</span>      <span class="ruby-comment"># loop</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span> <span class="ruby-comment"># k &lt;- 1 (quotient)</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">opt_alt</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">modulo</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">quitccf</span>      <span class="ruby-comment"># quit with clear carry</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">loopfit</span> <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>            <span class="ruby-comment"># carry &lt;- k &lt;- 0</span>
                <span class="ruby-identifier">found1</span>  <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span> <span class="ruby-comment"># a &gt;= 256</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a - m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># a &gt;= m</span>
                <span class="ruby-identifier">nfits</span>   <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">opt_alt</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">modulo</span>
                        <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>            <span class="ruby-comment"># clear carry, shift quotient into position</span>
                <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span>
                <span class="ruby-identifier">quitccf</span> <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span>           <span class="ruby-comment"># clear carry only when check0</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                <span class="ruby-identifier">loopfit</span> <span class="ruby-identifier">sla</span> <span class="ruby-identifier">k</span>            <span class="ruby-comment"># carry &lt;- k &lt;- 0</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">modulo</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">clrrem</span>
                        <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">fits</span>    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrrem</span> <span class="ruby-comment"># a &gt;= 256</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">nfits</span>
                <span class="ruby-identifier">fits</span>    <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span> <span class="ruby-comment"># k &lt;- 1 (quotient)</span>
                <span class="ruby-identifier">nfits</span>   <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span> <span class="ruby-comment"># clear carry</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod16</span><span
            class="method-args">(x=ixl, check0:true, check1:true, modulo:false, quick8:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of unsigned 16-bit: <code>hl</code> / <code>de</code>. Returns a quotient in <code>hl</code> and a remainder in <code>bc</code>.</p>
<dl class="rdoc-list note-list"><dt><code>x</code>
<dd>
<p>A temporary 8-bit register, one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the <code>accumulator</code> is being altered.  <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor is 1, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>quick8</code>
<dd>
<p>Checks if a divisor fits in 8 bits and in this instance uses a different, optimized for 8-bit division code. <code>quick8</code> can also be set to <code>:divmod8</code> to use <a href="Macros.html#method-i-divmod8"><code>Macros.divmod8</code></a> (smaller code) instead of stacked <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> for an 8-bit division.</p>
</dd></dl>
</li></ul>

<p>Uses: <code>af</code>, <code>bc</code>, <code>hl</code>, <code>x</code>, preserves: <code>de</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod16-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3313</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod16</span>(<span class="ruby-identifier">x</span>=<span class="ruby-identifier">ixl</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">quick8:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>, <span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">x</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ora</span> <span class="ruby-identifier">d</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div16strt</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">quick8</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">quick8</span> <span class="ruby-operator">==</span> <span class="ruby-value">:divmod8</span>
                            <span class="ruby-identifier">divmod8</span> <span class="ruby-identifier">e</span>, <span class="ruby-value">check0:</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qcheck0</span>), <span class="ruby-value">check1:</span>(<span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qcheck1</span>), <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>
                <span class="ruby-keyword">else</span>
                            <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">e</span>, <span class="ruby-value">check0:</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qcheck0</span>), <span class="ruby-value">check1:</span>(<span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qcheck1</span>), <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">true</span>
                            <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">l</span>, <span class="ruby-identifier">e</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>
                            <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">qcheck0</span>     <span class="ruby-identifier">label</span>
                <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                <span class="ruby-identifier">qcheck1</span>     <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>)
                <span class="ruby-identifier">qcheck0</span>     <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check0</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">check0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">divone</span>     <span class="ruby-comment"># division by m == 1</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">div16strt</span>           <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0 hi remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = 0 lo remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">findhi</span>              <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># align highest set bit at CF</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">found</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">findhi</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># hl == 0, bc == 0</span>
        <span class="ruby-identifier">loopfit</span>             <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
        <span class="ruby-identifier">found</span>               <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">c</span>            <span class="ruby-comment"># carry &lt;- c &lt;- carry</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a - d</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitshi</span>   <span class="ruby-comment"># a &gt;= d</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">quick8</span>
            <span class="ruby-identifier">divone</span>          <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">bc</span>, <span class="ruby-value">0</span>         <span class="ruby-comment"># clear rest</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>        <span class="ruby-comment"># division by 1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">fitshi</span>              <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">fitslo</span>   <span class="ruby-comment"># a &gt; d, ignore e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a == d: c - e</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitslo</span>   <span class="ruby-comment"># a &gt;= e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitslo</span>              <span class="ruby-identifier">sub</span> <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">sbc</span> <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a -= d</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
        <span class="ruby-identifier">over</span>                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># bc = remainder</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod16_8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod16_8</span><span
            class="method-args">(kh, kl, m, check0:true, check0_far:false, check1:true, k_leq_m:nil, modulo:false, ignore_cf:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of unsigned 16-bit: <code>kh</code>|<code>kl</code> / 8-bit <code>m</code>. Returns a quotient in <code>kh</code>|<code>kl</code> and a remainder in <code>accumulator</code>.</p>

<p>This routine utilizes a stacked up <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> routines.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>, <code>kl</code>
<dd>
<p>A dividend as two unique 8-bit registers except: <code>a</code>, <code>b</code>.</p>
</dd><dt><code>m</code>
<dd>
<p>A divisor as an 8-bit register except: <code>a</code>, <code>b</code> and none of <code>kh</code>, <code>kl</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the <code>accumulator</code> is being altered. <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>. It may also be a label (within the relative jump range) to indicate where to jump if <code>m</code> equals 0.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check0_far</code>
<dd>
<p>Allow to specify far (outside the relative jump range) <code>check0</code> label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor equals 1, a hot path optimization. It may also be a label to indicate where to jump if <code>m</code> equals 1.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_leq_m</code>
<dd>
<p>Short circuits if <code>kh</code> is equal or less than a divisor, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ignore_cf</code>
<dd>
<p>Removes instruction to clear CF if <code>check0</code> is also set. This can be used if <code>check0</code> is provided as a label instead of checking the state of the CF flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:size</code>, <code>:time</code>, <code>:unroll</code>, <code>:time_alt</code>, <code>:unroll_alt</code>. See <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> for details.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>A <a href="Macros.html#method-i-divmod8"><code>Macros.divmod8</code></a> presents a slower (up to 12%) but a significantly smaller (x1.5) alternative.</p>
</dd></dl>

<p>Uses: <code>af</code>, <code>b</code>, <code>kh</code>, <code>kl</code>, preserves: <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod16_8-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3283</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod16_8</span>(<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check0_far:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">k_leq_m:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
            <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span>
            <span class="ruby-identifier">check0_far</span> = (<span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:unroll</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:unroll_alt</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">kh</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">check0:</span><span class="ruby-identifier">check0</span>, <span class="ruby-value">check0_far:</span><span class="ruby-identifier">check0_far</span>, <span class="ruby-value">check1:</span><span class="ruby-identifier">check1</span>, <span class="ruby-value">k_leq_m:</span><span class="ruby-identifier">k_leq_m</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">true</span>
        <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span> <span class="ruby-comment"># clear CF unless ignored</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod24_8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod24_8</span><span
            class="method-args">(kh, km, kl, m, check0:true, check0_far:false, check1:true, k_leq_m:nil, modulo:false, ignore_cf:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of unsigned 24-bit: <code>kh</code>|<code>km</code>|<code>kl</code> / 8-bit <code>m</code>. Returns a quotient in <code>kh</code>|<code>km</code>|<code>kl</code> and a remainder in <code>accumulator</code>.</p>

<p>This routine utilizes a stacked up <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> routines.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>, <code>km</code>, <code>kl</code>
<dd>
<p>A dividend as three unique 8-bit registers except: <code>a</code>, <code>b</code>.</p>
</dd><dt><code>m</code>
<dd>
<p>A divisor as an 8-bit register except: <code>a</code>, <code>b</code> and none of <code>kh</code>, <code>km</code>, <code>kl</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the <code>accumulator</code> is being altered. <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>. It may also be a label (within the relative jump range) to indicate where to jump if <code>m</code> equals 0.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check0_far</code>
<dd>
<p>Allow to specify far (outside the relative jump range) <code>check0</code> label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor equals 1, a hot path optimization. It may also be a label to indicate where to jump if <code>m</code> equals 1.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_leq_m</code>
<dd>
<p>Short circuits if <code>kh</code> is equal or less than a divisor, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ignore_cf</code>
<dd>
<p>Removes instruction to clear CF if <code>check0</code> is also set. This can be used if <code>check0</code> is provided as a label instead of checking the state of the CF flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:size</code>, <code>:time</code>, <code>:unroll</code>, <code>:time_alt</code>, <code>:unroll_alt</code>. See <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> for details.</p>
</dd></dl>
</li></ul>

<p>Uses: <code>af</code>, <code>b</code>, <code>kh</code>, <code>km</code>, <code>kl</code>, preserves: <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod24_8-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3416</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod24_8</span>(<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">km</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check0_far:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">k_leq_m:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">km</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
            <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span>
            <span class="ruby-identifier">check0_far</span> = (<span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:unroll</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:unroll_alt</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">kh</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">check0:</span><span class="ruby-identifier">check0</span>, <span class="ruby-value">check0_far:</span><span class="ruby-identifier">check0_far</span>, <span class="ruby-value">check1:</span><span class="ruby-identifier">check1</span>, <span class="ruby-value">k_leq_m:</span><span class="ruby-identifier">k_leq_m</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>, <span class="ruby-value">ignore_cf:</span><span class="ruby-keyword">true</span>
        <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">km</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>
        <span class="ruby-identifier">divmod</span> <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">clrrem:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ignore_cf</span> <span class="ruby-comment"># clear CF unless ignored</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod32_16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod32_16</span><span
            class="method-args">(x:ixl, check0:true, check1:true, modulo:false, quick8:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of unsigned 32-bit: <code>hl</code>|<code>hl&#39;</code> / <code>de</code>. Returns a quotient in <code>hl</code>|<code>hl&#39;</code> and a remainder in <code>bc</code>.</p>
<dl class="rdoc-list note-list"><dt><code>x</code>
<dd>
<p>A temporary 8-bit register, one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the register <code>a</code> is being altered. <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor is 1, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>quick8</code>
<dd>
<p>Checks if a divisor fits in 8 bits and in this instance uses a different, optimized code.</p>
</dd></dl>
</li></ul>

<p>Uses: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>hl</code>, <code>hl&#39;</code>, <code>de&#39;</code>, <code>x</code>, preserves: <code>de</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod32_16-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3517</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod32_16</span>(<span class="ruby-value">x:</span><span class="ruby-identifier">ixl</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">quick8:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>, <span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">x</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ora</span> <span class="ruby-identifier">d</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div32strt</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">quick8</span>
                            <span class="ruby-identifier">divmod32_8</span> <span class="ruby-identifier">e</span>, <span class="ruby-value">check0:</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qcheck0</span>), <span class="ruby-value">check1:</span>(<span class="ruby-identifier">check1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qcheck1</span>), <span class="ruby-value">modulo:</span><span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">qcheck0</span>     <span class="ruby-identifier">label</span>
                <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                <span class="ruby-identifier">qcheck1</span>     <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>)
                <span class="ruby-identifier">qcheck0</span>     <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check0</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">check0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">div32strt</span> <span class="ruby-comment"># division by m &gt; 1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">bc</span>, <span class="ruby-value">0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>        <span class="ruby-comment"># division by 1</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">div32strt</span>           <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0 hi remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = 0 lo remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit1</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">c</span>            <span class="ruby-comment"># carry &lt;- c &lt;- carry</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a - d</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitshi1</span>  <span class="ruby-comment"># a &gt;= d</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">divlo16</span>
        <span class="ruby-identifier">fitshi1</span>             <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">fitslo1</span>  <span class="ruby-comment"># a &gt; d, ignore e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a == d: c - e</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitslo1</span>  <span class="ruby-comment"># a &gt;= e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span> 
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">divlo16</span>
        <span class="ruby-identifier">fitslo1</span>             <span class="ruby-identifier">sub</span> <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c = c - e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">sbc</span> <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a -= d</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>

        <span class="ruby-identifier">divlo16</span>             <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">exx</span>              <span class="ruby-comment"># hl&#39; &lt;-&gt; hl</span>
                            <span class="ruby-identifier">pop</span> <span class="ruby-identifier">de</span>           <span class="ruby-comment"># de&#39; = de</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">x</span>         <span class="ruby-comment"># c&#39; = c</span>

                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit2</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl&#39; &lt;- 0</span>
                            <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">c</span>            <span class="ruby-comment"># carry &lt;- c&#39; &lt;- carry</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fitshi2c</span>  <span class="ruby-comment"># a &gt; d</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a - d&#39;</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitshi2</span>  <span class="ruby-comment"># a &gt;= d&#39;</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitshi2</span>             <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">fitslo2</span>  <span class="ruby-comment"># a &gt; d, ignore e</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a == d: c - e</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fitslo2</span>  <span class="ruby-comment"># a &gt;= e</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fitshi2c</span>            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
        <span class="ruby-identifier">fitslo2</span>             <span class="ruby-identifier">sub</span> <span class="ruby-identifier">e</span>            <span class="ruby-comment"># a = c&#39; - e&#39;</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># c&#39; = c&#39; - e&#39;</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>
                            <span class="ruby-identifier">sbc</span> <span class="ruby-identifier">d</span>            <span class="ruby-comment"># a -= d&#39;</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl&#39; &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># clear carry only when check0</span>
        <span class="ruby-identifier">over</span>                <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">c</span>
                            <span class="ruby-identifier">exx</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># bc = remainder</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">x</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod32_8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod32_8</span><span
            class="method-args">(m=c, mt:c, check0:true, check1:true, modulo:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of unsigned 32-bit: <code>hl</code>|<code>hl&#39;</code> / <code>m</code>. Returns a quotient in <code>hl</code>|<code>hl&#39;</code> and a remainder in <code>a</code>.</p>
<dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>A divisor, one of: <code>c</code>, <code>d</code> or <code>e</code>.</p>
</dd><dt><code>mt&#39;</code>
<dd>
<p>A temporary register from the alternative set: <code>c&#39;</code>, <code>d&#39;</code> or <code>e&#39;</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the register <code>a</code> is being altered. <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor is 1, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>A stacked <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> presents a faster (9-16%) but a significantly larger (x2) alternative.</p>
</dd></dl>

<p>Uses: <code>af</code>, <code>af&#39;</code>, <code>b</code>, <code>b&#39;</code>, <code>hl</code>, <code>hl&#39;</code>, <code>mt&#39;</code>, preserves: <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod32_8-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3448</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod32_8</span>(<span class="ruby-identifier">m</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">mt:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">c</span>, <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">check0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">divstrt</span>  <span class="ruby-comment"># division by m &gt; 1</span>
                            <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear rest</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>       <span class="ruby-comment"># division by 1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">divstrt</span>             <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit1</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits1</span>     <span class="ruby-comment"># a &gt; m</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a - m</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits1</span>    <span class="ruby-comment"># a &gt;= m</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">divlo16</span>
        <span class="ruby-identifier">fits1</span>               <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a = a - m (rest)</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit1</span>    <span class="ruby-comment"># loop</span>

        <span class="ruby-identifier">divlo16</span>             <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                            <span class="ruby-identifier">exx</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">mt</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                            <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">loopfit2</span>            <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
                            <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits2</span>     <span class="ruby-comment"># a &gt; m</span>
                            <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">mt</span>           <span class="ruby-comment"># a - m</span>
                            <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits2</span>    <span class="ruby-comment"># a &gt;= m</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>    <span class="ruby-comment"># clear carry only when check0</span>
                            <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">over</span>
        <span class="ruby-identifier">fits2</span>               <span class="ruby-identifier">sub</span> <span class="ruby-identifier">mt</span>           <span class="ruby-comment"># a = a - m (rest)</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                            <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                            <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit2</span>    <span class="ruby-comment"># loop</span>
                            <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># clear carry only when check0</span>
        <span class="ruby-identifier">over</span>                <span class="ruby-identifier">exx</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-divmod8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">divmod8</span><span
            class="method-args">(m=c, check0:true, check1:true, modulo:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs an euclidean division of an unsigned 16-bit <code>hl</code> / 8-bit <code>m</code>. Returns a quotient in <code>hl</code> and a remainder in <code>a</code>.</p>
<dl class="rdoc-list note-list"><dt><code>m</code>
<dd>
<p>A divisor, one of: <code>c</code>, <code>d</code> or <code>e</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>check0</code>
<dd>
<p>Checks if a divisor is 0, in this instance CF=1 indicates an error  and nothing except the register <code>a</code> is being altered. <code>CF</code> should be ignored if <code>check0</code> is <code>false</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check1</code>
<dd>
<p>Checks if a divisor is 1, a hot path optimization.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>modulo</code>
<dd>
<p>Calculates a remainder only.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>A stacked <a href="Macros.html#method-i-divmod"><code>Macros.divmod</code></a> presents a faster (up to 12%) but a significantly larger (x1.5) alternative.</p>
</dd></dl>

<p>Uses: <code>af</code>, <code>b</code>, <code>hl</code>, preserves: <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="divmod8-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3213</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">divmod8</span>(<span class="ruby-identifier">m</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">check0:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check1:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">modulo:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">c</span>, <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">check1</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">check0</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">check1</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-value">1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">check0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># division by 0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">divone</span>    <span class="ruby-comment"># division by m == 1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">divstrt</span>         <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">16</span>
        <span class="ruby-identifier">findhi</span>          <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># align highest set bit at CF</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">found</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">findhi</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>          <span class="ruby-comment"># hl == 0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check1</span>
            <span class="ruby-identifier">divone</span>      <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear rest</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">check1</span>       <span class="ruby-comment"># division by 1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">loopfit</span>         <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># carry &lt;- hl &lt;- 0</span>
        <span class="ruby-identifier">found</span>           <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- a &lt;- carry</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">fits</span>      <span class="ruby-comment"># a &gt;= 256</span>
                        <span class="ruby-identifier">cp</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a - m</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># a &gt;= m</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">quitccf</span>      <span class="ruby-comment"># clear carry only when check0</span>
        <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">fits</span>            <span class="ruby-identifier">sub</span> <span class="ruby-identifier">m</span>            <span class="ruby-comment"># a = a - m (rest)</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">modulo</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span>            <span class="ruby-comment"># hl &lt;- 1 (quotient)</span>
        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopfit</span>     <span class="ruby-comment"># loop</span>
        <span class="ruby-identifier">quitccf</span>         <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check0</span> <span class="ruby-comment"># clear carry only when check0</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-int" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">int</span><span
            class="method-args">(bitsize, value, byteorder: :lsb)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Packs an integer of an arbitrary size and adds it to the <a href="../Program.html#attribute-i-code"><code>Program.code</code></a> at <a href="../Program.html#method-i-pc"><code>Program.pc</code></a>. Returns an unnamed relative label. The label&#39;s type is one of the structures created in the <a href="Integers.html"><code>Integers</code></a> module. The type depends on the <code>bitsize</code> provided.</p>

<p>Provided <code>bitsize</code> must be a multiple of 8. Integer data is being packed in the least significant byte first order, unless <code>byteorder:</code> <code>:msb</code> option is given. In this instance it is being packed in the most significant byte first order.</p>
          
          

          
          <div class="method-source-code" id="int-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 102</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">int</span>(<span class="ruby-identifier">bitsize</span>, <span class="ruby-identifier">value</span>, <span class="ruby-value">byteorder:</span> <span class="ruby-value">:lsb</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;int bitsize must be &gt; 0&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitsize</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">bitsize</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;int bitsize must be multiple of 8&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">bitsize</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">7</span>).<span class="ruby-identifier">zero?</span>
    <span class="ruby-identifier">bytesize</span> = <span class="ruby-identifier">bitsize</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">3</span>
    <span class="ruby-identifier">klass_name</span> = <span class="ruby-node">&quot;Int#{bitsize}&quot;</span>
    <span class="ruby-identifier">int_klass</span> = <span class="ruby-keyword">if</span> <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-constant">MathInt</span><span class="ruby-operator">::</span><span class="ruby-constant">Integers</span>.<span class="ruby-identifier">const_defined?</span>(<span class="ruby-identifier">klass_name</span>)
        <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-constant">MathInt</span><span class="ruby-operator">::</span><span class="ruby-constant">Integers</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">klass_name</span>)
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">klass</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-constant">Label</span>) <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">value</span>  <span class="ruby-identifier">byte</span> <span class="ruby-identifier">bytesize</span>
            <span class="ruby-identifier">bytes</span>  <span class="ruby-identifier">value</span> <span class="ruby-identifier">byte</span>, <span class="ruby-identifier">bytesize</span>
            <span class="ruby-identifier">words</span>  <span class="ruby-identifier">value</span> <span class="ruby-identifier">word</span>, <span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">zero?</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-constant">MathInt</span><span class="ruby-operator">::</span><span class="ruby-constant">Integers</span>.<span class="ruby-identifier">const_set</span> <span class="ruby-identifier">klass_name</span>, <span class="ruby-identifier">klass</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">bytes</span> = []
    <span class="ruby-identifier">bytesize</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">byteorder</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:lsb</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">bytes</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">value</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-value">:msb</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">bytes</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">value</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>)
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;byteorder must be :lsb or :msb&quot;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">value</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">8</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">data</span> <span class="ruby-identifier">int_klass</span>, <span class="ruby-identifier">bytes</span>.<span class="ruby-identifier">pack</span>(<span class="ruby-string">&#39;c*&#39;</span>.<span class="ruby-identifier">freeze</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-leading_zeros" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">leading_zeros</span><span
            class="method-args">(m, bitsize:8)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the number of leading zeros in the binary representation of <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="leading_zeros-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 71</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">leading_zeros</span>(<span class="ruby-identifier">m</span>, <span class="ruby-value">bitsize:</span><span class="ruby-value">8</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;leading_zeros: m is not an integer&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">m</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;leading_zeros: m is out of range&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;=</span> (<span class="ruby-value">1</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">bitsize</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">bitsize</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
    <span class="ruby-identifier">zshift</span> = <span class="ruby-value">0</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">bitsize</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
    <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-identifier">zshift</span>)).<span class="ruby-identifier">zero?</span>
        <span class="ruby-identifier">zshift</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">zshift</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul</span><span
            class="method-args">(k=d, m=a, tt:de, clrhl:true, signed_k:false, kbit9_carry:false, tl_is_zero:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of an 8(9)-bit integer <code>k</code> * 8-bit unsigned <code>m</code>. Returns the result as a 16-bit integer in <code>hl</code>.</p>

<p>Optionally the result can be added to an existing value in <code>hl</code>.</p>

<p>As a side-effect accumulator is always cleared to 0 and <code>m</code> and <code>k</code> are left unmodified if they are not an: <code>accumulator</code> nor part of <code>tt</code>.</p>
<dl class="rdoc-list note-list"><dt><code>k</code>
<dd>
<p>A multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier as an immediate value or an 8-bit register.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p><code>true</code> if the result should replace the <code>hl</code> content, <code>false</code> if the result should be added.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed_k</code>
<dd>
<p>If the multiplicand (<code>k</code>) represents a twos complement signed integer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>kbit9_carry</code>
<dd>
<p>If the multiplicand (<code>k</code>) is 9-bit, where MSB (9th) bit is read from CARRY flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tl_is_zero</code>
<dd>
<p>Whether <code>tl</code> (LSB of <code>tt</code>) register has been already cleared.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>What is more important: <code>:time</code> or <code>:size</code>?</p>
</dd></dl>
</li></ul>

<p>Uses: <code>af</code>, <code>hl</code>, <code>tt</code>, optionally preserves: <code>k</code>, <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="mul-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1143</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul</span>(<span class="ruby-identifier">k</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">kbit9_carry:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">tl_is_zero:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul: optimize should be :time or :size&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-value">:size</span>, <span class="ruby-value">:time</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">optimize</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">srx</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
        <span class="ruby-identifier">proc</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sra</span> <span class="ruby-identifier">t</span>}
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">proc</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">srl</span> <span class="ruby-identifier">t</span>}
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">l</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tl_is_zero</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tl_is_zero</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kbit9_carry</span>
                <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd9</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
        <span class="ruby-identifier">noadd9</span>  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cont9</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">th</span>]
                <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd8</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
        <span class="ruby-identifier">noadd8</span>  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">th</span>]
        <span class="ruby-identifier">cont9</span>   <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul16</span><span
            class="method-args">(kh=h, kl=l, m=a, tt:de, mbit9_carry:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer <code>kh</code>|<code>kl</code> * 8(9)-bit unsigned <code>m</code>. Returns the result in <code>hl</code>.</p>

<p>This routine is so far the most optimized of the similar routines: <a href="Macros.html#method-i-mul8"><code>Macros.mul8</code></a> or <a href="Macros.html#method-i-mul"><code>Macros.mul</code></a>. However, there is no way to accumulate results using this code.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>An 8-bit multiplier or the lowest 8-bits of a multiplier.</p>
</dd></dl>

<p>If <code>mbit9_carry</code> option is <code>true</code> the CF flag should contain the most significant bit (bit 9th) of a 9-bit unsigned multiplier.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code> unless <code>optimize</code> is <code>:compact</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>mbit9_carry</code>
<dd>
<p>If the multiplier (<code>m</code>) is 9-bit, where MSB (9th bit) is read from CARRY flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:compact</code>, <code>:size</code>, <code>:time</code> or <code>:unroll</code>.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Optimization <code>:compact</code> is both a smaller and slightly faster alternative to <code>:size</code>, however it requires the loop register <code>b</code>, thus preventing <code>bc</code> to be used as +tt.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>tt</code>, optionally <code>b</code> if <code>optimize</code> is <code>:compact</code>.</p>
          
          

          
          <div class="method-source-code" id="mul16-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 835</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul16</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">mbit9_carry:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16: tt must be +de+ if optimize is :compact&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">bc</span> <span class="ruby-operator">&amp;&amp;</span>
                                                                        <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:compact</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>  <span class="ruby-keyword">unless</span>  <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">optimize</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:time</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">tl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">th</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">start9</span>    <span class="ruby-comment"># bit9 of m</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">scf</span>               <span class="ruby-comment"># terminator</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">cont1</span>
                <span class="ruby-identifier">loop0</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop0</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">cont1</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># m == 0</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                <span class="ruby-identifier">start9</span>  <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">doadd1</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                <span class="ruby-identifier">cont1</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">doadd1</span>  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>       <span class="ruby-comment"># hl + tt</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">doadd1</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:compact</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">9</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cont1</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                <span class="ruby-identifier">cont1</span>   <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">skip1</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>       <span class="ruby-comment"># hl + tt</span>
                <span class="ruby-identifier">skip1</span>   <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:size</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">start8</span>   <span class="ruby-comment"># bit9 of m</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">start8</span>      <span class="ruby-identifier">scf</span>               <span class="ruby-comment"># terminator</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cont2</span>
                <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                <span class="ruby-identifier">cont1</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                <span class="ruby-identifier">cont2</span>   <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">doadd1</span>  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>       <span class="ruby-comment"># hl + tt</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cont1</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:unroll</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">tl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">th</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">iter0</span>     <span class="ruby-comment"># bit9 of m</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-value">7</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-value">:&quot;iter#{i+1}&quot;</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># m == 0</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">eoc</span>
            (<span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span> <span class="ruby-keyword">then</span> <span class="ruby-value">0</span> <span class="ruby-keyword">else</span> <span class="ruby-value">1</span> <span class="ruby-keyword">end</span><span class="ruby-operator">..</span><span class="ruby-value">7</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ns</span> <span class="ruby-value">:&quot;iter#{i}&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">doadd</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16: optimize should be :compact, :size, :time or :unroll&quot;</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul16_32" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul16_32</span><span
            class="method-args">(mm=bc, tt:bc, clrhlhl:true, signed_hl:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer (<code>hl</code>) by an unsigned 16-bit integer <code>mm</code> (<code>bc</code> or <code>de</code>). Returns the 32-bit integer result in <code>hl</code>|<code>hl&#39;</code>.</p>
<dl class="rdoc-list note-list"><dt><code>mm</code>
<dd>
<p>A 16bit multiplier register (<code>bc</code> or <code>de</code>).</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16bit tempoarary register (<code>bc&#39;</code> or <code>de&#39;</code>) of the alternative set.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhlhl</code>
<dd>
<p>If <code>hl</code>|<code>hl&#39;</code> should be cleared, if <code>false</code> acts like: <code>hl</code>|<code>hl&#39;</code> += <code>hl</code> * <code>mm</code>; also it may be a 32-bit constant, in this instance acts like: <code>hl</code>|<code>hl&#39;</code> = <code>clrhlhl</code> + <code>hl</code> * <code>mm</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed_hl</code>
<dd>
<p>If the multiplicand (<code>hl</code>) represents a twos complement signed integer (-32768..32767).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>What is more important: <code>:time</code> (117 bytes) or <code>:size</code> (51 bytes)?</p>
</dd></dl>
</li></ul>

<p>Uses: <code>af</code>, <code>af&#39;</code>, <code>hl</code>, <code>hl&#39;</code>, <code>mm</code>, <code>tt&#39;</code>.</p>

<p>T-states: (+2 if <code>clrhlhl</code> is an integer)</p>

<pre>     optimize:  time   size
0xFFFF*0xFFFF:  1346   1674
     0*0     :   102   1136
0xFFFF*0     :   102   1136
     0*0xFFFF:  1346   1674
0xFFFF*1     :   604   1169
     1*0xFFFF:  1346   1674
0xFFFF*0xAAAA:  1085   1410</pre>
          
          

          
          <div class="method-source-code" id="mul16_32-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2743</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul16_32</span>(<span class="ruby-identifier">mm</span>=<span class="ruby-identifier">bc</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">bc</span>, <span class="ruby-value">clrhlhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">signed_hl:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">mm</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>)
    <span class="ruby-identifier">mh</span>, <span class="ruby-identifier">ml</span> = <span class="ruby-identifier">mm</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">srx</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_hl</span>
        <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">x</span>) { <span class="ruby-identifier">sra</span> <span class="ruby-identifier">x</span> }
    <span class="ruby-keyword">else</span>
        <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">x</span>) { <span class="ruby-identifier">srl</span> <span class="ruby-identifier">x</span> }
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">scf</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># carry &lt;- ml &lt;- 1</span>
                        <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>       <span class="ruby-comment"># a&#39; = ml, CF&#39; = carry, ZF = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">mh</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">mh</span>, <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">clrhlhl</span>)
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">clrhlhl</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">16</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">clrhlhl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># hl = 0</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">mh</span>]
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">exx</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">clrhlhl</span>)
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">clrhlhl</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFFFF</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tt</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># th&#39;|tl&#39; = 0</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">clrhlhl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># hl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">scf</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># carry &lt;- mh &lt;- 1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">doadd1</span>
            <span class="ruby-identifier">shadd0</span>      <span class="ruby-identifier">exx</span>
            <span class="ruby-identifier">shadd1</span>      <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">mh</span>]          <span class="ruby-comment"># mh -&gt; ml -&gt; th&#39;</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># carry &lt;- mh|ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo</span>
            <span class="ruby-identifier">backloop</span>    <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">shadd0</span>
            <span class="ruby-identifier">doadd1</span>      <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">shadd1</span>

            <span class="ruby-identifier">multlo</span>      <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>       <span class="ruby-comment"># a = ml, ZF = a == 0</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">backloop</span>
                        <span class="ruby-identifier">exx</span>

        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>

                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">ora</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a&#39; ?= 0</span>
                        <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>       <span class="ruby-comment"># a&#39; = ml, ZF&#39; = a&#39; == 0</span>
                        <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a  = 0</span>
                        <span class="ruby-identifier">exx</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">clrhlhl</span>)
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">clrhlhl</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFFFF</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">clrhlhl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># hl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># th&#39;|tl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ora</span> <span class="ruby-identifier">mh</span>           <span class="ruby-comment"># a |= mh</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo0</span>   <span class="ruby-comment"># mh &lt;&gt; 0</span>

                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">mh</span>, <span class="ruby-identifier">h</span>        <span class="ruby-comment"># mh|ml = hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">clrhlhl</span>)
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">clrhlhl</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">16</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">clrhlhl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># hl = 0</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">scf</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- mh &lt;- 1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd1</span>

            <span class="ruby-identifier">shadd1</span>      <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">mh</span>]          <span class="ruby-comment"># mh -&gt; ml -&gt; th&#39;</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- mh</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd1</span>

            <span class="ruby-identifier">noadd1</span>      <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">mh</span>]          <span class="ruby-comment"># mh -&gt; ml -&gt; mh&#39;</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">ml</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">multlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd1</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">noadd1</span>

            <span class="ruby-identifier">multlo0</span>     <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">h</span>        <span class="ruby-comment"># mh = 0, ml = h, th&#39; = l, tl&#39; = 0</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>        <span class="ruby-comment"># hl = 0</span>

            <span class="ruby-identifier">multlo</span>      <span class="ruby-identifier">ex</span>  <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>       <span class="ruby-comment"># a = ml, ZF = a == 0</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd2</span>

            <span class="ruby-identifier">shadd2</span>      <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">ml</span>]          <span class="ruby-comment"># ml -&gt; mh&#39; -&gt; ml&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">finlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd2</span>

            <span class="ruby-identifier">noadd2</span>      <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">ml</span>]          <span class="ruby-comment"># ml -&gt; mh&#39; -&gt; ml&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>            <span class="ruby-comment"># carry &lt;- ml</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">finlo</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">shadd2</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">noadd2</span>

            <span class="ruby-identifier">finlo</span>       <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">ml</span>]          <span class="ruby-comment"># ml -&gt; mh&#39; -&gt; ml&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>    <span class="ruby-comment"># hl&#39; += th&#39;|tl&#39;</span>
                        <span class="ruby-identifier">exx</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">mh</span><span class="ruby-operator">|</span><span class="ruby-identifier">ml</span>    <span class="ruby-comment"># hl  += mh|ml + carry</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;optimize should be :time or :size&quot;</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul16_signed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul16_signed</span><span
            class="method-args">(kh=h, kl=l, m=b, tt:de, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer <code>kh</code>|<code>kl</code> * 8-bit signed <code>m</code>. Returns the result in <code>hl</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>An 8-bit multiplier.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code> unless <code>optimize</code> is <code>:compact</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:compact</code>, <code>:size</code>, <code>:time</code> or <code>:unroll</code>.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>tt</code>, optionally <code>b</code> if <code>optimize</code> is <code>:compact</code>.</p>
          
          

          
          <div class="method-source-code" id="mul16_signed-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 794</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul16_signed</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16_signed: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">t</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">m</span>
    <span class="ruby-keyword">else</span>
        [<span class="ruby-identifier">l</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">th</span>].<span class="ruby-identifier">find</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kl</span>}
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">P</span>, <span class="ruby-identifier">mult</span>        <span class="ruby-comment"># m &gt;= 0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">neg16</span> <span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">t</span>              <span class="ruby-comment"># a: -m</span>
        <span class="ruby-identifier">mult</span>    <span class="ruby-identifier">mul16</span>(<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul16_signed9" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul16_signed9</span><span
            class="method-args">(kh=h, kl=l, m=c, s:nil, tt:de, m_overflow:nil, m_neg_cond:C, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer <code>kh</code>|<code>kl</code> * 9-bit signed integer <code>f</code>|<code>m</code>. Returns the 16-bit result in <code>hl</code> or 17-bit result in <code>s</code>|<code>hl</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>The lowest 8-bits of the twos complement multiplier integer.</p>
</dd></dl>

<p>The branching condition specified in <code>m_neg_cond</code> determines the sign (bit 9th) of a 9-bit twos complement multiplier.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>An optional sign output register which extends the result to 17 bits: (-65536..65535). When <code>s</code> is specified <code>m</code> can&#39;t be <code>a</code>. The twos complement value returned in <code>s</code> can be either 0 for a positive or -1 for a negative result.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code> unless <code>optimize</code> is <code>:compact</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_neg_cond</code>
<dd>
<p>A flags register branching condition indicating that <code>m</code> is negative. When <code>s</code> is specified then <code>m_neg_cond</code> can be <code>nil</code> to indicate that no check should be performed. In this instance enter the routine at <code>posmul</code> sub-label when <code>m</code> &gt;= 0 or at <code>negmul</code> sub-label when <code>m</code> &lt; 0.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_overflow</code>
<dd>
<p>A program address to branch to when <code>m</code> = (-256). When branched <code>kh</code>|<code>kl</code> will be already negated <code>k</code> = (- <code>k</code>) and <code>a</code>, <code>CF</code> = 0. Alternatively <code>m_overflow</code> can be set to <code>false</code>, implicating that <code>m</code> is never equal to (-256).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:compact</code>, <code>:size</code>, <code>:time</code> or <code>:unroll</code>. <em>NOTE</em>: <code>:compact</code> can&#39;t be selected if <code>s</code> is <code>b</code>.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>hl</code>, <code>kh</code>, <code>kl</code>, <code>tt</code>, optionally <code>b</code> if <code>optimize</code> is <code>:compact</code>.</p>
          
          

          
          <div class="method-source-code" id="mul16_signed9-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 720</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul16_signed9</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">s:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">m_overflow:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">m_neg_cond:</span><span class="ruby-constant">C</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16_signed9: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span>
                                                        (<span class="ruby-operator">!</span><span class="ruby-identifier">s</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">or</span>
                                                            [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">s</span>) <span class="ruby-keyword">or</span>
                                                            <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span>))
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">s</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16_signed9: m_neg_cond must be a Condition&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Condition</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:compact</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul16_signed9: optimize can&#39;t be :compact with :s as b&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">t</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">m</span>
    <span class="ruby-keyword">else</span>
        [<span class="ruby-identifier">l</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">th</span>].<span class="ruby-identifier">find</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kl</span>}
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">jump</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:compact</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">jr_ok?</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">m_neg_cond</span>, <span class="ruby-identifier">negmul</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">m_neg_cond</span>, <span class="ruby-identifier">negmul</span>
            <span class="ruby-keyword">end</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">nil?</span>
            <span class="ruby-identifier">posmul</span>  <span class="ruby-identifier">sign_extend</span>(<span class="ruby-identifier">s</span>, <span class="ruby-identifier">kh</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span>    <span class="ruby-comment"># clear CF, test zero</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">mult</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span> <span class="ruby-comment"># clear sign</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-identifier">negmul</span>  <span class="ruby-identifier">neg16</span> <span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>
                    <span class="ruby-identifier">sign_extend</span>(<span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span>)
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">jr_ok?</span>        <span class="ruby-comment"># m &gt;= 0</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">not</span>, <span class="ruby-identifier">mult</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">not</span>, <span class="ruby-identifier">mult</span>
            <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">m</span>
                    <span class="ruby-identifier">neg16</span> <span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">t</span>              <span class="ruby-comment"># a: -m</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_overflow</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">m_overflow</span> <span class="ruby-comment"># m == 256</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">m_overflow</span>.<span class="ruby-identifier">nil?</span>
                    <span class="ruby-identifier">ccf</span>                 <span class="ruby-comment"># CF: 1 when m == 256, otherwise CF: 0</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">mult</span>    <span class="ruby-identifier">mul16</span>(<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">mbit9_carry:</span><span class="ruby-identifier">m_overflow</span>.<span class="ruby-identifier">nil?</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8</span><span
            class="method-args">(kh=h, kl=l, m=a, tt:de, clrhl:true, double:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer <code>kh</code>|<code>kl</code> * 8bit unsigned <code>m</code>. Returns the result as a 16-bit integer in <code>hl</code>.</p>

<p>Optionally the result can be added to an existing value in <code>hl</code>.</p>

<p>Optionally multiplies the result by 2 if <code>double</code> option is <code>true</code>.</p>

<p>As a side-effect <code>m</code> is always cleared to 0 and <code>kl</code> and <code>kh</code> are left unmodified if they are not part of <code>tt</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>An 8-bit multiplier register, must not be a part of the <code>tt</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p><code>true</code> if the result should replace the <code>hl</code> content, <code>false</code> if the result should be added.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>double</code>
<dd>
<p><code>true</code> if the result should be multiplied by 2 (<code>kh</code>|<code>kl</code> * 2).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>What is more important: <code>:time</code> or <code>:size</code>?</p>
</dd></dl>
</li></ul>

<p>Uses: <code>f</code>, <code>hl</code>, <code>m</code>, <code>kh</code>, <code>kl</code>, <code>tt</code>, optionally preserves: <code>kh</code>, <code>kl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul8-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1931</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">double:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8: optimize should be :time or :size&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-value">:size</span>, <span class="ruby-value">:time</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">optimize</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span>
                                                      <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">double</span>
                <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">doadd</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">double</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">muls1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
        <span class="ruby-identifier">muls1</span>   <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">m</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">doadd</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop1</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8_24" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8_24</span><span
            class="method-args">(kh=h, kl=l, m=b, t:c, tt:de, clrahl:true, k_int24:false, mbit9_carry:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit unsigned integer <code>kh</code>|<code>kl</code> or a 24-bit integer <code>t</code>|<code>kh</code>|<code>kl</code> * 8(9)-bit unsigned <code>m</code>. Returns the result as a 24-bit integer in <code>a</code>|<code>hl</code>.</p>

<p>Optionally the result can be added to an existing value in <code>a</code>|<code>hl</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier register, except <code>a</code>, <code>t</code>, <code>h</code>, <code>l</code> or a part of <code>tt</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit temporary register, except <code>a</code>, <code>m</code>, <code>h</code>, <code>l</code> or a part of <code>tt</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrahl</code>
<dd>
<p><code>true</code> if the result should replace the <code>a</code>|<code>hl</code> content, <code>false</code> if the result  should be added.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_int24</code>
<dd>
<p>Whether a multiplicand is a 24-bit (possibly signed) integer with its MSB bits in <code>t</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>mbit9_carry</code>
<dd>
<p>If the multiplier (<code>m</code>) is 9-bit, where MSB (9th bit) is read from the CARRY flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>What is more important: <code>:time</code> or <code>:size</code>?</p>
</dd></dl>
</li></ul>

<p>On exit, the SF flag contains the sign of the 24-bit result.</p>

<p>If <code>k_int24</code> is <code>false</code> and <code>clrahl</code> is <code>true</code> the resulting flags: ZF=1 signals the result  fits in 16 bits, and CF=1 indicates overflow (only possible with 9-bit <code>m</code>).</p>

<pre> bytes|~avg T-states|max T-states

      k_int24    false           true          false          true
  mbit9_carry    false          false           true          true
optimize
 :size        24|~466.5|569  23|~462.5|565  29|~548.2|656  28|~544.2|652
 :time        33|~385.4|504  32|~381.4|500  34|~441.2|570  33|~437.2|566</pre>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul8_24-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2101</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8_24</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrahl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">k_int24:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">mbit9_carry:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_24: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span>
                                                        [<span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">m</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span>
                                                        <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span>
                                                        <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">bit8?</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_24: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">xor</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">k_int24</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>        <span class="ruby-comment"># 20 bytes (+~10 cycles per m bit)</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                    <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">m</span>           <span class="ruby-comment"># CF -&gt; multiplier -&gt; CF</span>
                    <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">cont1</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">srl</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># 0 -&gt; multiplier -&gt; CF</span>
            <span class="ruby-identifier">cont1</span>   <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">last</span>
                    <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>   <span class="ruby-comment"># CF == 0 ? don&#39;t add</span>
                    <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>      <span class="ruby-comment"># add multiplicand to result lo16</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>        <span class="ruby-comment"># add multiplicand to result hi8</span>
            <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">sla</span> <span class="ruby-identifier">tl</span>          <span class="ruby-comment"># multiplicand *= 2</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">t</span>
                    <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">loop1</span>       <span class="ruby-comment"># m != 0 ? loop</span>
            <span class="ruby-identifier">last</span>    <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>      <span class="ruby-comment"># last add</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>     <span class="ruby-comment"># 29 bytes</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                    <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">m</span>           <span class="ruby-comment"># CF -&gt; multiplier -&gt; CF</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">srl</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># 0 -&gt; multiplier -&gt; CF</span>
            <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">skip0</span>   <span class="ruby-comment"># m != 0 ? start regular loop</span>
                    <span class="ruby-identifier">jr</span>  <span class="ruby-constant">C</span>, <span class="ruby-identifier">skadd</span>    <span class="ruby-comment"># m == 1 ? add and quit</span>
                    <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">eoc</span>         <span class="ruby-comment"># m == 0 ? just quit</span>
            <span class="ruby-identifier">skip0</span>   <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>   <span class="ruby-comment"># CF == 0 ? don&#39;t add</span>
            <span class="ruby-identifier">doadd</span>   <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>      <span class="ruby-comment"># add multiplicand to result lo16</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>        <span class="ruby-comment"># add multiplicand to result hi8</span>
            <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">sla</span> <span class="ruby-identifier">tl</span>          <span class="ruby-comment"># multiplicand *= 2</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">rl</span>  <span class="ruby-identifier">t</span>
                    <span class="ruby-identifier">srl</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># 0 -&gt; multiplier -&gt; carry</span>
                    <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>   <span class="ruby-comment"># carry == 0 ? don&#39;t add</span>
                    <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">doadd</span>   <span class="ruby-comment"># carry == 1 and m != 0 ? loop</span>
            <span class="ruby-identifier">skadd</span>   <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>      <span class="ruby-comment"># last add b.c. carry == 1</span>
                    <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;optimize should be :time or :size&quot;</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8_24a" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8_24a</span><span
            class="method-args">(kh=h, kl=l, m=b, t:c, tt:de, k_int24:false, mbit9_carry:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit unsigned integer <code>kh</code>|<code>kl</code> or a 24-bit integer <code>km</code>|<code>kh</code>|<code>kl</code> * 8(9)-bit unsigned <code>m</code>. Returns the result as a 24-bit integer in <code>a</code>|<code>hl</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier register, except <code>a</code>, <code>t</code>, <code>h</code>, <code>l</code> or a part of <code>tt</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit temporary register, except <code>a</code>, <code>m</code>, <code>h</code>, <code>l</code> or a part of <code>tt</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_int24</code>
<dd>
<p>Whether a multiplicand is a 24-bit (possibly signed) integer with its MSB bits in <code>t</code>. Alternatively provide an 8-bit register holding the MSB bits.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>mbit9_carry</code>
<dd>
<p>If the multiplier (<code>m</code>) is 9-bit, where MSB (9th bit) is read from the CARRY flag.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:size</code>, <code>:time</code> or <code>:unroll</code>.</p>
</dd></dl>

<p>bytes|~avg T-states|max T-states</p>

<pre>    k_int24    false           true          false          true
mbit9_carry    false          false           true          true</pre>
</li></ul>

<pre>optimize
  :size       22|~451.0|567  21|~447.0|563  27|~470.0|591  26|~466.0|587
  :time       39|~347.0|443  39|~343.0|439  47|~378.9|488  45|~374.9|484
:unroll       97|~291.2|351  97|~287.3|347 109|~323.1|388 107|~319.1|384</pre>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul8_24a-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2199</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8_24a</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">k_int24:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">mbit9_carry:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_24a: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span>
                                                        [<span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">m</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span>
                                                        <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span>
                                                        <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">bit8?</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">k_int24</span>
    <span class="ruby-keyword">when</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">k_int24</span> = <span class="ruby-identifier">t</span>
    <span class="ruby-keyword">else</span> 
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_24a: invalid k_int24 option&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">k_int24</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">k_int24</span>.<span class="ruby-identifier">bit8?</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>)
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">k_int24</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_24a: invalid kh, kl arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">&amp;&amp;</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>)
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tl</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">th</span>)
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_24a: invalid k_int24 register&quot;</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">k_int24</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">optimize</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:unroll</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">tl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">th</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">mbit9set</span>  <span class="ruby-comment"># bit9 of m</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-value">7</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-value">:&quot;iter#{i+1}&quot;</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># m == 0</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">eoc</span>
            <span class="ruby-identifier">mbit9set</span>    <span class="ruby-identifier">label</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
            (<span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span> <span class="ruby-keyword">then</span> <span class="ruby-value">0</span> <span class="ruby-keyword">else</span> <span class="ruby-value">1</span> <span class="ruby-keyword">end</span><span class="ruby-operator">..</span><span class="ruby-value">7</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ns</span> <span class="ruby-value">:&quot;iter#{i}&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">doadd</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:time</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">tl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">th</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">start9</span>    <span class="ruby-comment"># bit9 of m</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">sll</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 1 (terminator)</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">cont1</span>
                <span class="ruby-identifier">loop0</span>   <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop0</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">cont1</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># m == 0</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                <span class="ruby-identifier">start9</span>  <span class="ruby-identifier">label</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">sll</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 1 (terminator)</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">doadd1</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># a|hl * 2</span>
                <span class="ruby-identifier">cont1</span>   <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                <span class="ruby-identifier">cont2</span>   <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">doadd1</span>  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># a|hl * 2</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>       <span class="ruby-comment"># hl + tt</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>         <span class="ruby-comment"># a|hl + t|tt</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
                        <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">doadd1</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:size</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">mbit9_carry</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">start8</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">start8</span>      <span class="ruby-identifier">sll</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 1 (terminator)</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cont2</span>
            <span class="ruby-identifier">loop1</span>       <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># a|hl * 2</span>
            <span class="ruby-identifier">cont1</span>       <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">m</span>            <span class="ruby-comment"># CF &lt;- m &lt;- 0</span>
            <span class="ruby-identifier">cont2</span>       <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>       <span class="ruby-comment"># hl * 2</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># a|hl * 2</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>       <span class="ruby-comment"># hl + tt</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>         <span class="ruby-comment"># a|hl + t|tt</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cont1</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;optimize should be :size, :time or :unroll&quot;</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8_c" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8_c</span><span
            class="method-args">(kh=h, kl=l, m=a, tt:de, clrhl:true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of an unsigned 16-bit integer <code>kh</code>|<code>kl</code> * 8-bit unsigned <code>m</code>. Returns the result as a 16-bit unsigned integer in <code>hl</code>.</p>

<p>Optionally the result can be added to an existing value in <code>hl</code>.</p>

<p>Breaks on overflow with <code>CF</code>=1.</p>

<p>As a side-effect <code>m</code> is cleared to 0 when CF=0 and <code>kl</code> and <code>kh</code> are left unmodified if they are not part of <code>tt</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>An 8-bit multiplier register, must not be a part of the <code>tt</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p><code>true</code> if the result should replace the <code>hl</code> content, <code>false</code> if the result should be added.</p>
</dd></dl>
</li></ul>

<p>Uses: <code>f</code>, <code>hl</code>, <code>m</code>, <code>tt</code>, optionally preserves: <code>kh</code>, <code>kl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul8_c-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1835</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8_c</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_c: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span>
                                                        <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m</span>.<span class="ruby-identifier">bit8?</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_c: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
        <span class="ruby-identifier">loop1</span>   <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">noadd</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-identifier">noadd</span>   <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-identifier">skip1</span>   <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop1</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul8_signed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul8_signed</span><span
            class="method-args">(kh=h, kl=l, m=c, tt:de, t:m, clrhl:true, double:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit signed integer <code>kh</code>|<code>kl</code> * 8bit signed integer <code>m</code>. Returns the result as a 16-bit integer in <code>hl</code>.</p>

<p>Optionally the result can be added to an existing value in <code>hl</code>.</p>

<p>Optionally multiplies the result by 2 if <code>double</code> option is <code>true</code>.</p>

<p>As a side-effect <code>t</code> is always cleared to 0 and <code>kl</code> and <code>kh</code> are left unmodified if they are not part of <code>tt</code> and <code>m</code> is left unmodified if it&#39;s not <code>a</code> or the same as <code>t</code>.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>An 8-bit multiplier register.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit temporary register, it must not be the <code>accumulator</code> nor be a part of the <code>tt</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p><code>true</code> if the result should replace the <code>hl</code> content, <code>false</code> if the result should be added.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>double</code>
<dd>
<p><code>true</code> if the result should be multiplied by 2 (<code>kh</code>|<code>kl</code> * 2).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>What is more important: <code>:time</code> or <code>:size</code>?</p>
</dd></dl>
</li></ul>

<p>Uses: <code>af</code>, <code>hl</code>, <code>m</code>, <code>kh</code>, <code>kl</code>, <code>t</code>, <code>tt</code>, optionally preserves: <code>kh</code>, <code>kl</code>, <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="mul8_signed-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1883</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul8_signed</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">m</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">double:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_signed: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">or</span>
                                                             [<span class="ruby-identifier">a</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">th</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span>
                                                             [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)

    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul8_signed: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">P</span>, <span class="ruby-identifier">mul_it</span>      <span class="ruby-comment"># m &gt;= 0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">neg16</span> <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">t</span>              <span class="ruby-comment"># a: -m</span>
        <span class="ruby-identifier">mul_it</span>  <span class="ruby-identifier">mul8</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">clrhl:</span><span class="ruby-identifier">clrhl</span>, <span class="ruby-value">double:</span><span class="ruby-identifier">double</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_const" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_const</span><span
            class="method-args">(k=d, m=0, tt:de, clrhl:true, signed_k:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of an 8-bit integer <code>k</code> * 8-bit unsigned <code>m</code>. Returns the result as a 16-bit integer in <code>hl</code>.</p>

<p>Creates an optimized, unrolled code so <code>m</code> should be a constant value in the range: 0..256.</p>

<p>Optionally the result can be added to an existing value in <code>hl</code>.</p>

<p>As a side-effect <code>k</code> is left unmodified if <code>k</code> is not part of <code>tt</code> or <code>hl</code>.</p>

<p>For those <code>m</code> that has only one bit set or none, <code>tt</code> is not being used. For some of <code>m</code> when <code>tt</code> is <code>de</code> the code can be better optimized as we may leverage the usage of <code>ex  de, hl</code> instruction.</p>
<dl class="rdoc-list note-list"><dt><code>k</code>
<dd>
<p>A multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier value as a constant integer.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrhl</code>
<dd>
<p><code>true</code> if the result should replace the <code>hl</code> content, <code>false</code> if the result should be added.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed_k</code>
<dd>
<p>If the multiplicand (<code>k</code>) represents a twos complement signed integer (-128..127).</p>
</dd></dl>
</li></ul>

<p>Uses: <code>f</code>, <code>hl</code>, <code>tt</code>, optionally preserves: <code>k</code>.</p>
          
          

          
          <div class="method-source-code" id="mul_const-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1220</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_const</span>(<span class="ruby-identifier">k</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">m</span>=<span class="ruby-value">0</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const: invalid arguments&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span>
                                                               (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">256</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">tt</span> = <span class="ruby-identifier">hl</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">tsl</span>, <span class="ruby-identifier">clrhlt</span> = <span class="ruby-identifier">m</span>, <span class="ruby-value">4</span><span class="ruby-value">+7</span>, <span class="ruby-identifier">clrhl</span>
    <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">19.5</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
    <span class="ruby-keyword">while</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">11</span>
        <span class="ruby-identifier">ml</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhlt</span>
    <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhlt</span>
                <span class="ruby-identifier">clrhlt</span> = <span class="ruby-keyword">false</span>
                <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">true</span>
                <span class="ruby-value">8</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
                <span class="ruby-value">11</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">and</span> ((<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">just_cleared</span>)
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">just_cleared</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">11</span>
            <span class="ruby-keyword">while</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">11</span>
                <span class="ruby-identifier">ml</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">16</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">mr</span>, <span class="ruby-identifier">tsr</span>, <span class="ruby-identifier">clrhlt</span> = <span class="ruby-identifier">m</span>, <span class="ruby-value">4</span><span class="ruby-value">+7</span>, <span class="ruby-identifier">clrhl</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">mr</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">mr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x100</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
            <span class="ruby-identifier">tsr</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhlt</span>
                <span class="ruby-identifier">clrhlt</span> = <span class="ruby-keyword">false</span>
                <span class="ruby-value">8</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-value">11</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">tsr</span> <span class="ruby-operator">+=</span> <span class="ruby-value">16</span>
        <span class="ruby-identifier">mr</span> <span class="ruby-operator">&lt;&lt;=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tsl</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">tsr</span>
            <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">hl</span>.<span class="ruby-identifier">split</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
                    <span class="ruby-identifier">bit</span>  <span class="ruby-value">7</span>, <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">sk_neg</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">th</span>
            <span class="ruby-identifier">sk_neg</span>  <span class="ruby-identifier">label</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
            <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
            <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
                        <span class="ruby-identifier">clrhl</span> = <span class="ruby-keyword">false</span>
                        <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">true</span>
                        <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">and</span> ((<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">just_cleared</span>)
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">just_cleared</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
                    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x100</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrhl</span>
                        <span class="ruby-identifier">clrhl</span> = <span class="ruby-keyword">false</span>
                        <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
                    <span class="ruby-identifier">sra</span>  <span class="ruby-identifier">th</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">th</span>
                <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">m</span> <span class="ruby-operator">&lt;&lt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_const8_24" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_const8_24</span><span
            class="method-args">(kh=h, kl=l, m=0, t:c, tt:de, clrahl:true, signed_k:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer <code>kh</code>|<code>kl</code> * 8-bit unsigned <code>m</code>. Returns the result as a 24-bit integer in <code>a</code>|<code>hl</code>.</p>

<p>Creates an optimized, unrolled code so <code>m</code> should be a constant value in the range: 0..256.</p>

<p>Optionally the result can be added to an existing value in <code>a</code>|<code>hl</code>.</p>

<p>On exit, the SF flag contains the sign of the 24-bit result.</p>

<p>If <code>signed_k</code> is <code>false</code> and <code>clrahl</code> is <code>true</code> the resulting flag: ZF=1 signals the result  fits in 16 bits.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier value as a constant integer.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit temporary register, except <code>a</code>, <code>h</code>, <code>l</code> or a part of <code>tt</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>clrahl</code>
<dd>
<p><code>true</code> if the result should replace the register content, <code>false</code> if added.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed_k</code>
<dd>
<p>If the multiplicand (<code>kh</code>|<code>kl</code>) represents a twos complement signed integer (-32768..32767).</p>
</dd></dl>
</li></ul>

<p><code>t</code> and <code>tt</code> registers are ignored if <code>clrahl</code> is <code>true</code> and <code>m</code> is a power of two or 0.</p>

<p>Uses: <code>af</code>, <code>t</code>, optionally: <code>tt</code>, <code>hl</code>, optionally preserves: <code>kh</code> or <code>kl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul_const8_24-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2377</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_const8_24</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-value">0</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrahl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24: invalid arguments&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span> (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">256</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">and</span>
                                                            [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">and</span>
                                                            <span class="ruby-operator">!</span>[<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">t</span>, <span class="ruby-identifier">tt</span> = <span class="ruby-identifier">a</span>, <span class="ruby-identifier">hl</span>
        <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">ml</span>, <span class="ruby-identifier">tsl</span>, <span class="ruby-identifier">clrahlt</span> = <span class="ruby-identifier">m</span>, <span class="ruby-value">8</span>, <span class="ruby-identifier">clrahl</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahlt</span>
        <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
            <span class="ruby-value">12</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-value">4</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">7</span>
        <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">19.5</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">while</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">15</span>
        <span class="ruby-identifier">ml</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahlt</span>
    <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahlt</span>
                <span class="ruby-identifier">clrahlt</span> = <span class="ruby-keyword">false</span>
                <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">true</span>
                <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">12</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
                <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">15</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">and</span> ((<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">just_cleared</span>)
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">just_cleared</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">19</span>
            <span class="ruby-keyword">while</span> (<span class="ruby-identifier">ml</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">19</span>
                <span class="ruby-identifier">ml</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ml</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">tsl</span> <span class="ruby-operator">+=</span> <span class="ruby-value">24</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">mr</span>, <span class="ruby-identifier">tsr</span>, <span class="ruby-identifier">clrahlt</span> = <span class="ruby-identifier">m</span>, <span class="ruby-value">8</span><span class="ruby-value">+7</span>, <span class="ruby-identifier">clrahl</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">mr</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">mr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x100</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahlt</span>
                <span class="ruby-identifier">clrahlt</span> = <span class="ruby-keyword">false</span>
                <span class="ruby-identifier">tsr</span> <span class="ruby-operator">+=</span> <span class="ruby-value">12</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">tsr</span> <span class="ruby-operator">+=</span> <span class="ruby-value">15</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
            <span class="ruby-identifier">tsr</span> <span class="ruby-operator">+=</span> <span class="ruby-value">24</span>
        <span class="ruby-identifier">mr</span> <span class="ruby-operator">&lt;&lt;=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">tsr</span> <span class="ruby-operator">+=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>

    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tsl</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">tsr</span>
            <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">hl</span>.<span class="ruby-identifier">split</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kh</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24 condition violated: kh&lt;&gt;tl or kl&lt;&gt;th&quot;</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
                        <span class="ruby-identifier">sign_extend</span>(<span class="ruby-identifier">a</span>, <span class="ruby-identifier">th</span>)
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
                        <span class="ruby-identifier">bit</span>  <span class="ruby-value">7</span>, <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">sk_neg</span>
                        <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">t</span>
                <span class="ruby-identifier">sk_neg</span>  <span class="ruby-identifier">label</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
            <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
            <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span>
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                        <span class="ruby-identifier">clrahl</span> = <span class="ruby-keyword">false</span>
                        <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">true</span>
                        <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">just_cleared</span> = <span class="ruby-keyword">false</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>  <span class="ruby-comment"># CF=0 and ZF=1 in case when result 16 bit</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">and</span> ((<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">just_cleared</span>)
                        <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">just_cleared</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                        <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">t</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
                    <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">t</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kh</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>,  <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">kl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>,  <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24 condition violated: kh&lt;&gt;th or kl&lt;&gt;t&quot;</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x100</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                        <span class="ruby-identifier">clrahl</span> = <span class="ruby-keyword">false</span>
                        <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                        <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
                        <span class="ruby-identifier">sra</span>  <span class="ruby-identifier">t</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">t</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">m</span> <span class="ruby-operator">&lt;&lt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-comment"># CF=0 and ZF=1, SF sign</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_const8_24a" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_const8_24a</span><span
            class="method-args">(kh=h, kl=l, m=0, t:c, tt:de, k_int24:false, signed_k:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 16-bit integer <code>kh</code>|<code>kl</code> or a 24-bit integer <code>km</code>|<code>kh</code>|<code>kl</code> * 8-bit unsigned <code>m</code>. Returns the result as a 24-bit integer in <code>a</code>|<code>hl</code>.</p>

<p>Creates an optimized, unrolled code so <code>m</code> should be a constant value in the range: 0..256.</p>

<p>On exit, if <code>k_int24</code> and <code>signed_k</code> is <code>false</code> the resulting flag: ZF=1 signals the result fits in 16 bits. If <code>k_int24</code> is <code>false</code> or <code>signed_k</code> is <code>true</code> the resulting flag SF contains the sign of the 24-bit result.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>The MSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LSB part of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier value as a constant integer.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit temporary register, except <code>a</code>, <code>h</code>, <code>l</code> or a part of <code>tt</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_int24</code>
<dd>
<p>Whether a multiplicand is a 24-bit (possibly signed) integer with its MSB bits in <code>t</code>. Alternatively provide an 8-bit register holding the MSB bits.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed_k</code>
<dd>
<p>If <code>k_int24</code> is <code>false</code> this controls whether the multiplicand (<code>kh</code>|<code>kl</code>) represents a twos complement signed integer (-32768..32767). Otherwise if <code>k_int24</code> is truthy this ensures the SF flag is set properly.</p>
</dd></dl>
</li></ul>

<p><code>t</code> and <code>tt</code> registers are ignored <code>m</code> is a power of two or 0.</p>

<p>Uses: <code>af</code>, <code>hl</code>, optionally: <code>t</code>, <code>tt</code>, optionally preserves: <code>kh</code> or <code>kl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul_const8_24a-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2580</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_const8_24a</span>(<span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-value">0</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">k_int24:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid arguments&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span> (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">256</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">and</span>
                                                                [<span class="ruby-identifier">bc</span>, <span class="ruby-identifier">de</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">and</span>
                                                                <span class="ruby-operator">!</span>[<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">k_int24</span>
    <span class="ruby-keyword">when</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">k_int24</span> = <span class="ruby-identifier">t</span>
    <span class="ruby-keyword">else</span> 
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid k_int24 option&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">k_int24</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">k_int24</span>.<span class="ruby-identifier">bit8?</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">256</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">signed_k</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
                <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid kh, kl arguments&quot;</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span> <span class="ruby-comment"># a = kh</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
                    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>
                            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>
                            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                            <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span>
                                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>
                            <span class="ruby-keyword">else</span>
                                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span>
                            <span class="ruby-keyword">end</span>
                        <span class="ruby-keyword">else</span>
                            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">l</span>)
                            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span>
                            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">l</span>)
                        <span class="ruby-keyword">end</span>
                    <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid kh, kl arguments&quot;</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">is_single_bit</span> = (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment"># single bit only</span>
    <span class="ruby-identifier">ztshift</span> = <span class="ruby-identifier">trailing_zeros</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">zlshift</span> = <span class="ruby-identifier">leading_zeros</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">ztshift</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> (<span class="ruby-identifier">ztshift</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">zlshift</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_int24</span>
            <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">k_int24</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid kh, kl arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kh</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">l</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>)
                    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid k_int24 register&quot;</span>
                <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">k_int24</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">is_single_bit</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">ora</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">signed_k</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid kh, kl arguments&quot;</span> <span class="ruby-keyword">if</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">kl</span>)
                    <span class="ruby-identifier">sign_extend</span>(<span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span>)
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kh</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">sign_extend</span>(<span class="ruby-identifier">a</span>, <span class="ruby-identifier">kh</span>)
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const8_24a: invalid kh, kl arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kh</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">l</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">h</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">k_int24</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">while</span> <span class="ruby-identifier">mask</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_const_ex" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_const_ex</span><span
            class="method-args">(k=d, m=0, tt:de, signed_k:false, use_a:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of an 8-bit integer <code>k</code> * 8-bit unsigned <code>m</code>. Returns the result as a 16-bit integer in <code>hl</code>.</p>

<p>Creates an optimized, unrolled code so <code>m</code> should be a constant value in the range: 0..256.</p>

<p>As a side-effect <code>k</code> is left unmodified if <code>k</code> is not part of <code>tt</code> or <code>hl</code>.</p>

<p>For those <code>m</code> that has only one bit set or none, <code>tt</code> is not being used.</p>

<p>This macro can produce faster routines compared to <a href="Macros.html#method-i-mul_const"><code>Macros.mul_const</code></a>, but does not allow to accumulate results.</p>
<dl class="rdoc-list note-list"><dt><code>k</code>
<dd>
<p>A multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>A multiplier value as a constant integer.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>signed_k</code>
<dd>
<p>If the multiplicand (<code>k</code>) represents a twos complement signed integer (-128..127).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>use_a</code>
<dd>
<p>Whether to allow modifying the <code>a</code> register. For some values of <code>m</code> the routine can be optimized further by utilizing the <code>accumulator</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:size</code>, <code>:time</code> or a specific algorithm.</p>
</dd></dl>
</li></ul>

<p>Algorithm list for <code>optimize</code>:</p>
<ul><li>
<p>:k_rshift_sum</p>
</li><li>
<p>:neg_k_rshift_sum</p>
</li><li>
<p>:split_hik_lshift_sum</p>
</li><li>
<p>:neg_split_hik_lshift_sum</p>
</li><li>
<p>:split_lok_rshift_sum</p>
</li><li>
<p>:sum_lshift_add_k</p>
</li><li>
<p>:neg_sum_lshift_add_k</p>
</li></ul>

<p>Uses: <code>f</code>, <code>hl</code>, <code>tt</code>, optionally <code>a</code>, optionally preserves: <code>k</code>.</p>
          
          

          
          <div class="method-source-code" id="mul_const_ex-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1377</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_const_ex</span>(<span class="ruby-identifier">k</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">m</span>=<span class="ruby-value">0</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">use_a:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const_ex: invalid arguments&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">and</span>
                                                                  (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">256</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value">256</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">is_single_bit</span> = (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment"># single bit only</span>
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">srx</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
        <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">x</span>) { <span class="ruby-identifier">sra</span> <span class="ruby-identifier">x</span> }
    <span class="ruby-keyword">else</span>
        <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">x</span>) { <span class="ruby-identifier">srl</span> <span class="ruby-identifier">x</span> }
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># tricky optim:</span>
    <span class="ruby-comment"># if [rl, a].include?(k) this method should be called before k is modified</span>
    <span class="ruby-identifier">sign_extend_k</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rh</span>, <span class="ruby-identifier">rl</span>, <span class="ruby-value">s:</span><span class="ruby-identifier">k</span>, <span class="ruby-value">use_a:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">zero:</span><span class="ruby-value">0</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">rl</span>, <span class="ruby-identifier">s</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">rl</span> <span class="ruby-comment"># not a BUG!</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-identifier">sign_extend</span>(<span class="ruby-identifier">rh</span>, <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">rl</span> <span class="ruby-keyword">end</span>) <span class="ruby-comment"># not a BUG!</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">rh</span>, <span class="ruby-identifier">zero</span>
                    <span class="ruby-identifier">bit</span>  <span class="ruby-value">7</span>, <span class="ruby-identifier">rl</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">skip_neg</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">rh</span>
        <span class="ruby-identifier">skip_neg</span>    <span class="ruby-identifier">label</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">rh</span>, <span class="ruby-identifier">zero</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># only 8-bit k</span>
    <span class="ruby-identifier">k_rshift_sum</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ztshift</span> = <span class="ruby-identifier">trailing_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">zlshift</span> = <span class="ruby-identifier">leading_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> (<span class="ruby-identifier">ztshift</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">zlshift</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
            (<span class="ruby-identifier">zlshift</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">h</span>]
                <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">l</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">mask</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">th</span>]
                <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># only 8-bit k</span>
    <span class="ruby-identifier">neg_k_rshift_sum</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">m</span> = (<span class="ruby-operator">-</span><span class="ruby-identifier">m</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>
        <span class="ruby-identifier">ztshift</span> = <span class="ruby-identifier">trailing_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span> <span class="ruby-comment"># hl = k * 256</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
            <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">mask</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">th</span>]
                <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># only 8-bit k</span>
    <span class="ruby-identifier">split_hik_lshift_sum</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">use_a</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">zlshift</span> = <span class="ruby-identifier">leading_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-identifier">zlshift</span>
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">signed_k</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_single_bit</span>
                    <span class="ruby-identifier">sll8_16</span>(<span class="ruby-value">7</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">zlshift</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span><span class="ruby-identifier">k</span>)
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">sll8_16</span>(<span class="ruby-value">7</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">zlshift</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">end</span>, <span class="ruby-value">zero:</span><span class="ruby-identifier">th</span>)
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
                <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-value">s:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">use_a:</span><span class="ruby-identifier">use_a</span>, <span class="ruby-value">zero:</span><span class="ruby-identifier">l</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
                (<span class="ruby-identifier">zlshift</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">h</span>]
                    <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">l</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">m</span> <span class="ruby-operator">^=</span> <span class="ruby-identifier">mask</span>
            <span class="ruby-identifier">mask</span> = <span class="ruby-value">1</span>
            <span class="ruby-keyword">until</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-identifier">m</span> <span class="ruby-operator">^=</span> <span class="ruby-identifier">mask</span>
                    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&lt;&lt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 16-bit k supported</span>
    <span class="ruby-identifier">neg_split_hik_lshift_sum</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">m</span> = (<span class="ruby-operator">-</span><span class="ruby-identifier">m</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-value">0</span>
            <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-value">s:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">zero:</span><span class="ruby-identifier">l</span>
            <span class="ruby-identifier">mask</span> = <span class="ruby-value">1</span>
            <span class="ruby-keyword">until</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">mask</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                    <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-identifier">m</span> <span class="ruby-operator">^=</span> <span class="ruby-identifier">mask</span>
                    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">rl</span>   <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&lt;&lt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># only 8-bit k</span>
    <span class="ruby-identifier">split_lok_rshift_sum</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">use_a</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ztshift</span> = <span class="ruby-identifier">trailing_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">signed_k</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_single_bit</span>
                    <span class="ruby-identifier">sll8_16</span>(<span class="ruby-identifier">ztshift</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span><span class="ruby-identifier">k</span>)
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">sll8_16</span>(<span class="ruby-identifier">ztshift</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">th</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">end</span>, <span class="ruby-value">zero:</span><span class="ruby-identifier">tl</span>)
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">use_a:</span><span class="ruby-identifier">use_a</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">l</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-comment"># not a BUG!</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span> <span class="ruby-keyword">then</span> <span class="ruby-value">0</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">h</span> <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">m</span> <span class="ruby-operator">^=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">until</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">srx</span>[<span class="ruby-identifier">th</span>]
                <span class="ruby-identifier">rr</span>  <span class="ruby-identifier">tl</span>
                <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                    <span class="ruby-identifier">m</span> <span class="ruby-operator">^=</span> <span class="ruby-identifier">mask</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 16-bit k supported</span>
    <span class="ruby-identifier">sum_lshift_add_k</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">use_a</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ztshift</span> = <span class="ruby-identifier">trailing_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">zlshift</span> = <span class="ruby-identifier">leading_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> (<span class="ruby-identifier">ztshift</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">zlshift</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">is_single_bit</span>
                    <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-value">use_a:</span><span class="ruby-identifier">use_a</span>
                    <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">use_a:</span><span class="ruby-identifier">use_a</span>
                    <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">signed_k</span>
                    <span class="ruby-identifier">sll8_16</span>(<span class="ruby-identifier">ztshift</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span><span class="ruby-identifier">k</span>)
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">use_a:</span><span class="ruby-identifier">use_a</span>
                    <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">mask</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 16-bit k supported</span>
    <span class="ruby-identifier">neg_sum_lshift_add_k</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">use_a</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">m</span> = (<span class="ruby-operator">-</span><span class="ruby-identifier">m</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>
        <span class="ruby-identifier">ztshift</span> = <span class="ruby-identifier">trailing_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">zlshift</span> = <span class="ruby-identifier">leading_zeros</span>(<span class="ruby-identifier">m</span>)
        <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">mask</span> = <span class="ruby-value">0x80</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-identifier">ztshift</span>
        <span class="ruby-identifier">is_single_bit</span> = (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment"># single bit only</span>
        <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-identifier">zlshift</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
                <span class="ruby-identifier">kk</span> = <span class="ruby-keyword">if</span> [<span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">k</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">k</span>
                    <span class="ruby-identifier">tl</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">k</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">ztshift</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">5</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">signed_k</span>
                    <span class="ruby-identifier">neg16</span>(<span class="ruby-keyword">unless</span> <span class="ruby-identifier">signed_k</span> <span class="ruby-keyword">then</span> <span class="ruby-value">0</span> <span class="ruby-keyword">end</span>, <span class="ruby-identifier">k</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">l</span>)
                    <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">else</span> <span class="ruby-comment"># 224, 192, 160, 128, 96, 64, 32</span>
                    <span class="ruby-identifier">sll8_16</span>(<span class="ruby-identifier">ztshift</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span><span class="ruby-identifier">k</span>)
                    <span class="ruby-identifier">neg16</span>(<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>)
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">kk</span>
                <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_single_bit</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>
                    <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">sign_extend_k</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ztshift</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">tt</span>, <span class="ruby-identifier">hl</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">while</span> <span class="ruby-identifier">mask</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
              <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">mask</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">m</span>).<span class="ruby-identifier">zero?</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
                    <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">tt</span>
                <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">end</span>
              <span class="ruby-identifier">mask</span> <span class="ruby-operator">&gt;&gt;=</span> <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">algorithms</span> = {
        <span class="ruby-value">k_rshift_sum:</span> <span class="ruby-identifier">k_rshift_sum</span>,
        <span class="ruby-value">neg_k_rshift_sum:</span> <span class="ruby-identifier">neg_k_rshift_sum</span>,
        <span class="ruby-value">split_hik_lshift_sum:</span> <span class="ruby-identifier">split_hik_lshift_sum</span>,
        <span class="ruby-value">neg_split_hik_lshift_sum:</span> <span class="ruby-identifier">neg_split_hik_lshift_sum</span>,
        <span class="ruby-value">split_lok_rshift_sum:</span> <span class="ruby-identifier">split_lok_rshift_sum</span>,
        <span class="ruby-value">sum_lshift_add_k:</span> <span class="ruby-identifier">sum_lshift_add_k</span>,
        <span class="ruby-value">neg_sum_lshift_add_k:</span> <span class="ruby-identifier">neg_sum_lshift_add_k</span>,
    }
    <span class="ruby-comment"># the choice made here may be slightly off, depending on what k is selected</span>
    <span class="ruby-comment"># some k choices can benefit some algos, while punishing others</span>
    <span class="ruby-identifier">algo</span>, <span class="ruby-identifier">with_a</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">optimize</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:time</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">224</span>
                    [<span class="ruby-value">:neg_k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">32</span>,<span class="ruby-value">64</span>,<span class="ruby-value">80</span>,<span class="ruby-value">96</span>,<span class="ruby-value">112</span>,<span class="ruby-value">128</span>,<span class="ruby-value">144</span>,<span class="ruby-value">152</span>,<span class="ruby-value">160</span>,<span class="ruby-value">168</span>,<span class="ruby-value">176</span>,<span class="ruby-value">192</span>,<span class="ruby-value">208</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">33</span>,<span class="ruby-value">65</span>,<span class="ruby-value">67</span>,<span class="ruby-value">129</span>,<span class="ruby-value">131</span>,<span class="ruby-value">133</span><span class="ruby-operator">..</span><span class="ruby-value">135</span>,<span class="ruby-value">137</span><span class="ruby-operator">..</span><span class="ruby-value">143</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">66</span>,<span class="ruby-value">68</span>,<span class="ruby-value">97</span><span class="ruby-operator">..</span><span class="ruby-value">98</span>,<span class="ruby-value">130</span>,<span class="ruby-value">132</span>,<span class="ruby-value">136</span>,<span class="ruby-value">145</span>,<span class="ruby-value">161</span><span class="ruby-operator">..</span><span class="ruby-value">162</span>,<span class="ruby-value">164</span>,<span class="ruby-value">177</span>,<span class="ruby-value">193</span><span class="ruby-operator">..</span><span class="ruby-value">194</span>,<span class="ruby-value">196</span>,<span class="ruby-value">200</span>,<span class="ruby-value">209</span>,<span class="ruby-value">225</span><span class="ruby-operator">..</span><span class="ruby-value">226</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">126</span><span class="ruby-operator">..</span><span class="ruby-value">127</span>,<span class="ruby-value">158</span><span class="ruby-operator">..</span><span class="ruby-value">159</span>,<span class="ruby-value">174</span><span class="ruby-operator">..</span><span class="ruby-value">175</span>,<span class="ruby-value">182</span><span class="ruby-operator">..</span><span class="ruby-value">184</span>,<span class="ruby-value">186</span><span class="ruby-operator">..</span><span class="ruby-value">191</span>,<span class="ruby-value">199</span>,<span class="ruby-value">203</span><span class="ruby-operator">..</span><span class="ruby-value">207</span>,<span class="ruby-value">211</span><span class="ruby-operator">..</span><span class="ruby-value">223</span>,<span class="ruby-value">227</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">127</span>,<span class="ruby-value">191</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">120</span>,<span class="ruby-value">124</span>,<span class="ruby-value">184</span>,<span class="ruby-value">188</span>,<span class="ruby-value">190</span>,<span class="ruby-value">216</span>,<span class="ruby-value">220</span>,<span class="ruby-value">224</span>,<span class="ruby-value">232</span>,<span class="ruby-value">240</span>
                    [<span class="ruby-value">:neg_k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">33</span>,<span class="ruby-value">65</span>,<span class="ruby-value">67</span>,<span class="ruby-value">69</span><span class="ruby-operator">..</span><span class="ruby-value">71</span>,<span class="ruby-value">129</span>,<span class="ruby-value">131</span>,<span class="ruby-value">133</span><span class="ruby-operator">..</span><span class="ruby-value">135</span>,<span class="ruby-value">137</span><span class="ruby-operator">..</span><span class="ruby-value">143</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">66</span>,<span class="ruby-value">68</span>,<span class="ruby-value">97</span><span class="ruby-operator">..</span><span class="ruby-value">98</span>,<span class="ruby-value">130</span>,<span class="ruby-value">132</span>,<span class="ruby-value">136</span>,<span class="ruby-value">145</span>,<span class="ruby-value">161</span><span class="ruby-operator">..</span><span class="ruby-value">162</span>,<span class="ruby-value">164</span>,<span class="ruby-value">177</span>,<span class="ruby-value">193</span><span class="ruby-operator">..</span><span class="ruby-value">194</span>,<span class="ruby-value">196</span>,<span class="ruby-value">209</span>,<span class="ruby-value">225</span><span class="ruby-operator">..</span><span class="ruby-value">226</span>,<span class="ruby-value">228</span>,<span class="ruby-value">241</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">222</span><span class="ruby-operator">..</span><span class="ruby-value">223</span>,<span class="ruby-value">231</span>,<span class="ruby-value">235</span><span class="ruby-operator">..</span><span class="ruby-value">239</span>,<span class="ruby-value">242</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">32</span>,<span class="ruby-value">48</span>,<span class="ruby-value">64</span>,<span class="ruby-value">72</span>,<span class="ruby-value">80</span>,<span class="ruby-value">88</span>,<span class="ruby-value">96</span>,<span class="ruby-value">104</span>,<span class="ruby-value">112</span>,<span class="ruby-value">128</span>,<span class="ruby-value">144</span>,<span class="ruby-value">148</span>,<span class="ruby-value">152</span>,<span class="ruby-value">156</span>,<span class="ruby-value">160</span>,<span class="ruby-value">168</span>,<span class="ruby-value">172</span>,<span class="ruby-value">176</span>,<span class="ruby-value">180</span>,<span class="ruby-value">192</span>,<span class="ruby-value">200</span>,<span class="ruby-value">204</span>,<span class="ruby-value">208</span>,<span class="ruby-value">212</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">176</span>,<span class="ruby-value">192</span>,<span class="ruby-value">208</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">9</span>,<span class="ruby-value">17</span>,<span class="ruby-value">33</span><span class="ruby-operator">..</span><span class="ruby-value">35</span>,<span class="ruby-value">65</span>,<span class="ruby-value">67</span>,<span class="ruby-value">69</span><span class="ruby-operator">..</span><span class="ruby-value">71</span>,<span class="ruby-value">129</span>,<span class="ruby-value">131</span>,<span class="ruby-value">133</span><span class="ruby-operator">..</span><span class="ruby-value">135</span>,<span class="ruby-value">137</span><span class="ruby-operator">..</span><span class="ruby-value">143</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">66</span>,<span class="ruby-value">68</span>,<span class="ruby-value">81</span>,<span class="ruby-value">97</span><span class="ruby-operator">..</span><span class="ruby-value">98</span>,<span class="ruby-value">113</span>,<span class="ruby-value">130</span>,<span class="ruby-value">132</span>,<span class="ruby-value">136</span>,<span class="ruby-value">144</span><span class="ruby-operator">..</span><span class="ruby-value">146</span>,<span class="ruby-value">160</span><span class="ruby-operator">..</span><span class="ruby-value">162</span>,<span class="ruby-value">164</span>,<span class="ruby-value">177</span><span class="ruby-operator">..</span><span class="ruby-value">178</span>,<span class="ruby-value">193</span><span class="ruby-operator">..</span><span class="ruby-value">194</span>,<span class="ruby-value">196</span>,<span class="ruby-value">200</span>,<span class="ruby-value">209</span><span class="ruby-operator">..</span><span class="ruby-value">210</span>,<span class="ruby-value">225</span><span class="ruby-operator">..</span><span class="ruby-value">226</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">95</span>,<span class="ruby-value">111</span>,<span class="ruby-value">119</span>,<span class="ruby-value">123</span><span class="ruby-operator">..</span><span class="ruby-value">127</span>,<span class="ruby-value">151</span>,<span class="ruby-value">155</span><span class="ruby-operator">..</span><span class="ruby-value">159</span>,<span class="ruby-value">167</span>,<span class="ruby-value">171</span><span class="ruby-operator">..</span><span class="ruby-value">175</span>,<span class="ruby-value">179</span><span class="ruby-operator">..</span><span class="ruby-value">191</span>,<span class="ruby-value">198</span><span class="ruby-operator">..</span><span class="ruby-value">199</span>,<span class="ruby-value">202</span><span class="ruby-operator">..</span><span class="ruby-value">207</span>,<span class="ruby-value">211</span><span class="ruby-operator">..</span><span class="ruby-value">224</span>,<span class="ruby-value">227</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">224</span>,<span class="ruby-value">240</span>
                    [<span class="ruby-value">:neg_k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">126</span><span class="ruby-operator">..</span><span class="ruby-value">127</span>,<span class="ruby-value">188</span>,<span class="ruby-value">190</span><span class="ruby-operator">..</span><span class="ruby-value">191</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">32</span>,<span class="ruby-value">64</span>,<span class="ruby-value">80</span>,<span class="ruby-value">96</span>,<span class="ruby-value">112</span>,<span class="ruby-value">128</span>,<span class="ruby-value">160</span>,<span class="ruby-value">176</span>,<span class="ruby-value">192</span>,<span class="ruby-value">208</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">33</span>,<span class="ruby-value">65</span>,<span class="ruby-value">67</span>,<span class="ruby-value">69</span><span class="ruby-operator">..</span><span class="ruby-value">71</span>,<span class="ruby-value">129</span>,<span class="ruby-value">131</span>,<span class="ruby-value">133</span><span class="ruby-operator">..</span><span class="ruby-value">135</span>,<span class="ruby-value">137</span><span class="ruby-operator">..</span><span class="ruby-value">143</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">66</span>,<span class="ruby-value">68</span>,<span class="ruby-value">72</span>,<span class="ruby-value">81</span>,<span class="ruby-value">97</span><span class="ruby-operator">..</span><span class="ruby-value">98</span>,<span class="ruby-value">113</span>,<span class="ruby-value">130</span>,<span class="ruby-value">132</span>,<span class="ruby-value">136</span>,<span class="ruby-value">144</span><span class="ruby-operator">..</span><span class="ruby-value">146</span>,<span class="ruby-value">161</span><span class="ruby-operator">..</span><span class="ruby-value">162</span>,<span class="ruby-value">164</span>,<span class="ruby-value">177</span><span class="ruby-operator">..</span><span class="ruby-value">178</span>,<span class="ruby-value">193</span><span class="ruby-operator">..</span><span class="ruby-value">194</span>,<span class="ruby-value">196</span>,<span class="ruby-value">200</span>,<span class="ruby-value">209</span><span class="ruby-operator">..</span><span class="ruby-value">210</span>,<span class="ruby-value">225</span><span class="ruby-operator">..</span><span class="ruby-value">226</span>,<span class="ruby-value">228</span>,<span class="ruby-value">241</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">207</span>,<span class="ruby-value">215</span>,<span class="ruby-value">219</span><span class="ruby-operator">..</span><span class="ruby-value">223</span>,<span class="ruby-value">230</span><span class="ruby-operator">..</span><span class="ruby-value">232</span>,<span class="ruby-value">234</span><span class="ruby-operator">..</span><span class="ruby-value">239</span>,<span class="ruby-value">242</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:size</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">signed_k</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">129</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">130</span>,<span class="ruby-value">132</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">64</span>,<span class="ruby-value">128</span>,<span class="ruby-value">192</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">191</span>,<span class="ruby-value">222</span><span class="ruby-operator">..</span><span class="ruby-value">224</span>,<span class="ruby-value">231</span>,<span class="ruby-value">235</span><span class="ruby-operator">..</span><span class="ruby-value">240</span>,<span class="ruby-value">242</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">224</span>
                    [<span class="ruby-value">:neg_k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">248</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">129</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">130</span>,<span class="ruby-value">132</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">252</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">64</span>,<span class="ruby-value">128</span>,<span class="ruby-value">160</span>,<span class="ruby-value">192</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">use_a</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">129</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">136</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">127</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">130</span>,<span class="ruby-value">132</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">8</span>,<span class="ruby-value">16</span>,<span class="ruby-value">24</span>,<span class="ruby-value">32</span>,<span class="ruby-value">40</span>,<span class="ruby-value">48</span>,<span class="ruby-value">56</span>,<span class="ruby-value">72</span>,<span class="ruby-value">80</span>,<span class="ruby-value">88</span>,<span class="ruby-value">96</span>,<span class="ruby-value">104</span>,<span class="ruby-value">112</span>,<span class="ruby-value">120</span>,<span class="ruby-value">144</span>,<span class="ruby-value">152</span>,<span class="ruby-value">160</span>,<span class="ruby-value">168</span>,<span class="ruby-value">176</span>,<span class="ruby-value">184</span>,<span class="ruby-value">200</span>,<span class="ruby-value">208</span>,<span class="ruby-value">216</span>,<span class="ruby-value">224</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">190</span><span class="ruby-operator">..</span><span class="ruby-value">191</span>,<span class="ruby-value">207</span>,<span class="ruby-value">215</span>,<span class="ruby-value">219</span><span class="ruby-operator">..</span><span class="ruby-value">223</span>,<span class="ruby-value">230</span><span class="ruby-operator">..</span><span class="ruby-value">232</span>,<span class="ruby-value">234</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">m</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">129</span>
                    [<span class="ruby-value">:split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">128</span>
                    [<span class="ruby-value">:k_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">130</span>,<span class="ruby-value">132</span>,<span class="ruby-value">136</span>
                    [<span class="ruby-value">:split_lok_rshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">250</span>,<span class="ruby-value">252</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>
                    [<span class="ruby-value">:neg_split_hik_lshift_sum</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-value">127</span>,<span class="ruby-value">190</span><span class="ruby-operator">..</span><span class="ruby-value">191</span>,<span class="ruby-value">222</span><span class="ruby-operator">..</span><span class="ruby-value">223</span>,<span class="ruby-value">238</span><span class="ruby-operator">..</span><span class="ruby-value">240</span>,<span class="ruby-value">246</span><span class="ruby-operator">..</span><span class="ruby-value">248</span>,<span class="ruby-value">251</span>
                    [<span class="ruby-value">:neg_sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">else</span>
                    [<span class="ruby-value">:sum_lshift_add_k</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
        [<span class="ruby-identifier">optimize</span>, <span class="ruby-identifier">use_a</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">algo_impl</span> = <span class="ruby-identifier">algorithms</span>[<span class="ruby-identifier">algo</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_const_ex: unsupported algorithm in :optimize&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">algo_impl</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">algo_impl</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">m</span>, <span class="ruby-identifier">with_a</span>)
    <span class="ruby-comment"># case optimize</span>
    <span class="ruby-comment"># when :time</span>
    <span class="ruby-comment">#     algo = algorithms.each_value.map do |algo|</span>
    <span class="ruby-comment">#         tsc = Z80::TStatesCounter.new</span>
    <span class="ruby-comment">#         tsc.instance_exec(m, use_a, &amp;algo)</span>
    <span class="ruby-comment">#         [tsc.to_i, algo]</span>
    <span class="ruby-comment">#     end.min_by {|i| i.first}[1]</span>
    <span class="ruby-comment"># when :size</span>
    <span class="ruby-comment">#     algo = algorithms.each_value.map do |algo|</span>
    <span class="ruby-comment">#         csc = Z80::CodeSizeCounter.new</span>
    <span class="ruby-comment">#         csc.instance_exec(m, use_a, &amp;algo)</span>
    <span class="ruby-comment">#         [csc.to_i, algo]</span>
    <span class="ruby-comment">#     end.min_by {|i| i.first}[1]</span>
    <span class="ruby-comment"># else</span>
    <span class="ruby-comment">#     algo = algorithms[optimize]</span>
    <span class="ruby-comment">#     raise ArgumentError, &quot;mul_const_ex: unsupported algorithm in :optimize&quot; if algo.nil?</span>
    <span class="ruby-comment">#     algo.call(m, use_a)</span>
    <span class="ruby-comment"># end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_signed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_signed</span><span
            class="method-args">(k=d, m=a, tt:de, clrhl:true, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a signed 8-bit <code>k</code> * 8-bit signed <code>m</code>.</p>

<p>See <a href="Macros.html#method-i-mul"><code>Macros.mul</code></a> for details.</p>
          
          

          
          <div class="method-source-code" id="mul_signed-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 940</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_signed</span>(<span class="ruby-identifier">k</span>=<span class="ruby-identifier">d</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">k</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">P</span>, <span class="ruby-identifier">mul_it</span>      <span class="ruby-comment"># m &gt;= 0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">tl</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">m</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">mul_it</span>  <span class="ruby-identifier">mul</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">clrhl:</span><span class="ruby-identifier">clrhl</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_signed9" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_signed9</span><span
            class="method-args">(kh, kl, m=a, s:kh, tt:de, m_neg_cond:C, k_full_range:true, m_full_range:true, k_overflow:nil, m_is_zero_zf:false, optimize: :time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a signed 9-bit integer <code>kh</code>|<code>kl</code> * 9-bit signed integer <code>m</code>. Returns the result as a 17-bit integer in <code>s</code>|<code>hl</code>.</p>

<p>The sign of a twos complement multiplicand <code>kl</code> is expected in <code>kh</code> extended to all bits.</p>

<p>The sign of a twos complement multiplier <code>m</code> is provided via the flags register.</p>

<p>Optionally the ZERO flag (ZF) must signal <code>m</code> equals to 0 if <code>m_is_zero_zf</code> option is set.</p>

<p>The sign of a twos complement result is returned in a register <code>s</code>.</p>

<p>The result has only 17 bits capacity, thus multiplying (-256)x(-256) leads to overflow.</p>

<p>To detect overflow check that all of the following conditions are met on result:</p>

<pre>if (CF = 1) and (s == 0) and (hl == 0) then overflow is detected</pre>

<p>Alternatively provide an address or a label of a routine to enter on overflow as <code>k_overflow</code> option. In this instance the values of flags and registers will be unspecified on overflow.</p>
<dl class="rdoc-list note-list"><dt><code>kh</code>
<dd>
<p>An extended multiplicand sign as an immediate value or an 8-bit register. <code>kh</code> is expected to be either equal to 0 or to 255 (twos complement -1). Other sign values will render <strong>UNDEFINED BEHAVIOUR</strong>.</p>
</dd><dt><code>kl</code>
<dd>
<p>Least significant 8-bits of a twos complement multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>Least significant 8-bits of a twos complement multiplier as an immediate value or an 8-bit register.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>An 8-bit sign output register, preferably the same as <code>kh</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16-bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_neg_cond</code>
<dd>
<p>A flags register branching condition indicating that <code>m</code> is negative.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_full_range</code>
<dd>
<p>Determines whether the multiplicand is allowed to be equal to (-256). Saves 7 T-states and 18-21 bytes if <code>false</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_full_range</code>
<dd>
<p>Determines whether the multiplier is allowed to be equal to (-256). Saves 7 T-states and 6-9 bytes if <code>false</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>k_overflow</code>
<dd>
<p>An address of a rountine to enter on overflow. When <code>k_overflow</code> is <code>true</code> but <code>k_full_range</code> is <code>false</code> the routine will be entered in case if <code>k</code> = (-256) and <code>m</code> is negative. When <code>k_full_range</code> and <code>k_overflow</code> are enabled then the <code>m_full_range</code> option must be also <code>true</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_is_zero_zf</code>
<dd>
<p>Determines whether <code>ZF</code> flag holds the condition whether the multiplier <code>m</code> is equal to 0 when the routine is entered. Saves 4 T-states and 1 byte if <code>true</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>Optimization options: <code>:size</code>, <code>:time</code> or <code>:unroll</code>.</p>
</dd></dl>
</li></ul>

<h4 id="method-i-mul_signed9-label-Note-3A">Note:<span><a href="#method-i-mul_signed9-label-Note-3A">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When <code>m_is_zero_zf</code> option is <code>true</code> and the <code>Z</code> flag is set to indicate that <code>m</code> is equal to 0, then flags must also indicate positive <code>m</code> when <code>m_neg_cond</code> is checked (the condition must fail). Otherwise the routine will result in <strong>UNDEFINED BEHAVIOUR</strong>.</p>

<p>When <code>m_full_range</code> option is <code>false</code>, then passing (-256) to <code>m</code> will resolve in <strong>UNDEFINED BEHAVIOUR</strong>.</p>

<p>When <code>k_full_range</code> option is <code>false</code>, then passing (-256) to <code>k</code> and a negative value to <code>m</code> will resolve in <strong>UNDEFINED BEHAVIOUR</strong> unless <code>k_overflow</code> option is enabled. In this instance the <code>k_overflow</code> routine will be called when attempting to multiply (-256) by a negative multiplier.</p>

<p>For example if your multiplicand or a multiplier is calculated from a subtraction of 2 positive 8-bit values, the resulting value never equals to (-256). Thus it is safe to disable the corresponding <code>x_full_range</code> option.</p>

<p>Uses: <code>af</code>, <code>hl</code>, <code>tt</code>, <code>s</code>, optionally preserves: <code>kh</code>, <code>kl</code> or <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="mul_signed9-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 1027</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_signed9</span>(<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">s:</span><span class="ruby-identifier">kh</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">m_neg_cond:</span><span class="ruby-constant">C</span>, <span class="ruby-value">k_full_range:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">m_full_range:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">k_overflow:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">m_is_zero_zf:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
        <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">th</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span> <span class="ruby-keyword">or</span>
                                                             [<span class="ruby-identifier">kh</span>, <span class="ruby-identifier">kl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span>
                                                             [<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">s</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9: invalid options&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_overflow</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">k_full_range</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">m_full_range</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9: m_neg_cond must be a Condition&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Condition</span>)
    <span class="ruby-keyword">unless</span> [<span class="ruby-value">:size</span>, <span class="ruby-value">:time</span>, <span class="ruby-value">:unroll</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">optimize</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9: optimize should be :size, :time or :unroll&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">jump</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cond</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">jr_ok?</span>)
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">m</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kh</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                <span class="ruby-comment"># m &lt; 0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_neg_cond</span>.<span class="ruby-identifier">jr_ok?</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">m_neg_cond</span>, <span class="ruby-identifier">m_neg</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">m_neg_cond</span>, <span class="ruby-identifier">m_neg</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m_is_zero_zf</span>
                <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">mul_it</span> <span class="ruby-comment"># m != 0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_full_range</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m_full_range</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">k_overflow</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m_is_zero_zf</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m_neg_cond</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">C</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>               <span class="ruby-comment"># clear CF</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear sign</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">eoc</span>   <span class="ruby-comment"># CF=0</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_full_range</span>              <span class="ruby-comment"># k = -(-256)</span>
        <span class="ruby-identifier">k_over</span>  <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span>            <span class="ruby-comment"># clear sign (-256 * m) where m &lt; 0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">tl</span>              <span class="ruby-comment"># a = -m, CF = 1 (unless m == -256)</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_full_range</span>
                <span class="ruby-comment"># m == (-256)</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">k_overflow</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_overflow</span>
                <span class="ruby-identifier">ccf</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k_overflow</span> <span class="ruby-comment"># CF:1 when m == -256</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>            <span class="ruby-comment"># hl: 256 * -m where m &lt; 0</span>
                <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">eoc</span>   <span class="ruby-comment"># CF=0|1 depending on overflow unless k_overflow is set</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_full_range</span>
        <span class="ruby-identifier">m_n256</span>  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">th</span>           <span class="ruby-comment"># hl: k * (-256)</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">eoc</span>   <span class="ruby-comment"># CF=0|1 depending on overflow unless k_overflow is set</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">m_neg</span>   <span class="ruby-identifier">label</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">neg16</span> <span class="ruby-identifier">s</span>, <span class="ruby-identifier">th</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">a</span> <span class="ruby-comment"># a: 0|FF depending on th == 0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_full_range</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">k_over</span>    <span class="ruby-comment"># 0-0:CF=0, 0-FF:CF=1, FF-0:CF=0, FF-FF:CF=0</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">k_overflow</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">k_overflow</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># s|k = -(s|k)</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">tl</span>           <span class="ruby-comment"># a = -m</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_full_range</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">m_n256</span>    <span class="ruby-comment"># m == (-256)</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
        <span class="ruby-identifier">mul_it</span>  <span class="ruby-identifier">sra</span>  <span class="ruby-identifier">s</span>            <span class="ruby-comment"># k sign -&gt; CF</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">l</span>
        <span class="ruby-identifier">mult</span>    <span class="ruby-identifier">mul</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">clrhl:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">kbit9_carry:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">tl_is_zero:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:size</span>)
        <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">mul_it</span>  <span class="ruby-identifier">mul16</span>(<span class="ruby-identifier">s</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">mbit9_carry:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>)
                <span class="ruby-identifier">anda</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">k_full_range</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m_full_range</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">k_overflow</span> <span class="ruby-comment"># clear CF</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mul_signed9_24" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mul_signed9_24</span><span
            class="method-args">(ks=c, kh=h, kl=l, m=b, tt:de, m_pos_cond:NC, m_full_range:true, optimize: :time, &amp;restore_a)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that performs a multiplication of a 24-bit signed integer <code>ks</code>|<code>kh</code>|<code>kl</code> * 9-bit signed integer <code>m</code>. Returns the result as a 24-bit integer in <code>a</code>|<code>hl</code>.</p>

<p>The sign of a twos complement multiplier <code>m</code> is provided via the flags register.</p>

<p>Optionally the result can be added to an existing value in <code>a</code>|<code>hl</code>.</p>
<dl class="rdoc-list note-list"><dt><code>ks</code>
<dd>
<p>The MS 8-bits of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kh</code>
<dd>
<p>Bits 8-15 of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>kl</code>
<dd>
<p>The LS 8-bits of the multiplicand as an immediate value or an 8-bit register.</p>
</dd><dt><code>m</code>
<dd>
<p>The LS 8-bits of the multiplier as an 8-bit register, it must not be the <code>accumulator</code>.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tt</code>
<dd>
<p>A 16 bit temporary register (<code>de</code> or <code>bc</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_pos_cond</code>
<dd>
<p>A flags register branching condition indicating that <code>m</code> is positive (including 0).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>m_full_range</code>
<dd>
<p>Determines whether the multiplier is allowed to be equal to (-256). Saves 10-12 T-states and 7-9+ bytes if disabled.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize</code>
<dd>
<p>What is more important: <code>:time</code> or <code>:size</code>?</p>
</dd></dl>
</li></ul>

<p>If a block of code (<code>restore_a</code>) is present, <code>a</code>|<code>hl</code> registers are not cleared. Provide instructions to restore <code>a</code> and optionally <code>hl</code> registers, thus the result will be added:</p>

<pre>a|hl += k * m.</pre>
<ul><li>
<p>The block of code must not modify the content of <code>tt</code>, <code>t</code> or <code>m</code> registers.</p>
</li><li>
<p>There is no need to restore <code>hl</code> registers as they are not modified before the <code>restore_a</code> instructions are executed.</p>
</li><li>
<p>The <code>restore_a</code> block is inserted twice if the <code>optimize</code> option is <code>:time</code> and <code>m_full_range</code> is <code>true</code>.</p>
</li></ul>

<p>When <code>m_full_range</code> option is disabled, then passing (-256) to <code>m</code> will resolve in <strong>UNDEFINED BEHAVIOUR</strong>.</p>

<p>Uses: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="mul_signed9_24-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 2009</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mul_signed9_24</span>(<span class="ruby-identifier">ks</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">kh</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">kl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>=<span class="ruby-identifier">b</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">m_pos_cond:</span><span class="ruby-constant">NC</span>, <span class="ruby-value">m_full_range:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">optimize:</span> <span class="ruby-value">:time</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">restore_a</span>)
    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9_24: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">ks</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>) <span class="ruby-keyword">or</span>
                                                                <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">kl</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ks</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9_24: m_pos_cond must be a Condition&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m_pos_cond</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Condition</span>)
    <span class="ruby-identifier">clrahl</span> = <span class="ruby-operator">!</span><span class="ruby-identifier">block_given?</span>
    <span class="ruby-identifier">jump</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cond</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">jr_ok?</span>)
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">target</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mul_signed9_24: invalid arguments&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">kl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">kh</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">kh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_pos_cond</span>.<span class="ruby-identifier">jr_ok?</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">m_pos_cond</span>, <span class="ruby-identifier">mul_it</span> <span class="ruby-comment"># m &gt;= 0</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">m_pos_cond</span>, <span class="ruby-identifier">mul_it</span> <span class="ruby-comment"># m &gt;= 0</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">neg_int</span> <span class="ruby-identifier">ks</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-value">optimize_last:</span><span class="ruby-keyword">true</span>

                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">m</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">m</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">m_full_range</span>
                <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">mul_it</span> <span class="ruby-comment"># m != (-256)</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">clrahl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>             <span class="ruby-comment"># a: 0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">th</span>            <span class="ruby-comment"># set flags</span>
                <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ks</span>, <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>            <span class="ruby-comment"># a: 0</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:size</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">m</span>, <span class="ruby-value">1</span>         <span class="ruby-comment"># m: 1</span>
                <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">optimize</span> <span class="ruby-operator">==</span> <span class="ruby-value">:time</span>
                    <span class="ruby-identifier">ns</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">restore_a</span>)
                    <span class="ruby-identifier">jump</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">mult</span>.<span class="ruby-identifier">skadd</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">mul_it</span>  <span class="ruby-identifier">label</span>
                <span class="ruby-identifier">ns</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">restore_a</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">clrahl</span>
        <span class="ruby-identifier">mult</span>    <span class="ruby-identifier">mul8_24</span>(<span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">m</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">ks</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">tt</span>, <span class="ruby-value">clrahl:</span><span class="ruby-identifier">clrahl</span>, <span class="ruby-value">k_int24:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">optimize:</span><span class="ruby-identifier">optimize</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-neg16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">neg16</span><span
            class="method-args">(sh, sl, th:sh, tl:sl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that changes the sign of a twos complement 16-bit integer in <code>sh</code>|<code>sl</code> or an 8-bit integer in <code>sl</code> and extends it to a 16-bit integer.</p>
<dl class="rdoc-list note-list"><dt><code>sh</code>
<dd>
<p>An 8-bit MSB of the 16-bit integer input, as a register, except <code>a</code>, a constant value or <code>nil</code> to extend 8-bit integer in <code>sl</code>.</p>
</dd><dt><code>sl</code>
<dd>
<p>An 8-bit register holding LSB of the 16-bit integer input or an 8-bit integer input.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>th</code>
<dd>
<p>An 8-bit MSB output register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tl</code>
<dd>
<p>An 8-bit LSB output register, except <code>a</code> or <code>sh</code>.</p>
</dd></dl>
</li></ul>

<p>To extend an 8-bit integer in a register <code>e</code> to a negative 16-bit in <code>hl</code>:</p>

<pre class="ruby"><span class="ruby-identifier">neg16</span>(  <span class="ruby-value">0</span>, <span class="ruby-identifier">e</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">l</span>) <span class="ruby-comment"># e = positive or 0 (0..255)</span>
<span class="ruby-identifier">neg16</span>( <span class="ruby-value">-1</span>, <span class="ruby-identifier">e</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">l</span>) <span class="ruby-comment"># e = negative, twos complement (-1..-256)</span>
<span class="ruby-identifier">neg16</span>(<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">e</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">l</span>) <span class="ruby-comment"># e = an 8-bit signed twos complement (-128..127)</span>
</pre>

<p>Uses: <code>af</code>, <code>th</code>, <code>tl</code>, preserves optionally: <code>sh</code>, <code>sl</code>.</p>

<p>T-states (sh):</p>

<pre>reg,1,-1: 20|24, 0: 16|20, const: 23|27, nil: 27|28|31|32</pre>
          
          

          
          <div class="method-source-code" id="neg16-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 325</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">neg16</span>(<span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">sh</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">sl</span>)
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">sh</span>, <span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">sh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">sh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;neg16: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">neg</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">sl</span>
        <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">sh</span>.<span class="ruby-identifier">nil?</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">skip_ext</span> <span class="ruby-comment"># tl=0|128</span>
        <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">sh</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">0</span>,<span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">1</span>
            <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">-1</span>
            <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">sh</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">skip_ext</span> <span class="ruby-identifier">label</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sh</span>.<span class="ruby-identifier">nil?</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-neg_int" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">neg_int</span><span
            class="method-args">(*regs, t:nil, t_is_zero:false, optimize_last:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that changes the sign of a twos complement integer held in any number of <code>regs</code>.</p>

<p>Pass any number of 8-bit registers, except the <code>accumulator</code>, as function arguments. A register passed as the first argument should hold the most significant byte of the negated integer.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>A temporary 8-bit register used when the number of argument registers is 3 or more to slightly optimize the routine.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t_is_zero</code>
<dd>
<p>Assume the <code>t</code> register already holds 0. If <code>false</code> the content of the <code>t</code> register will be set to 0.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>optimize_last</code>
<dd>
<p>Saves 3 T-states on the last iteration when <code>t</code> is not being used. This however renders the state of the CF flag useless.</p>
</dd></dl>
</li></ul>

<p><a href="Integers.html"><code>Integers</code></a> are being processed starting from the least significant byte (the last argument).</p>

<p>On completion the <code>accumulator</code> holds a copy of the MSB register after the operation.</p>

<p>The CF flag will hold the carry over state of the last operation and the SF flag the sign of the resulting integer, unless <code>optimize_last</code> is <code>true</code>.</p>

<p>Modifies: <code>af</code> and argument registers.</p>

<p>T-states (register count):</p>

<pre>1: 12, 2: 24|27, 3: 36|39|40|42, 4: 48|52|54|57, 5: 60|64|69|72, 6: 84|87.</pre>
          
          

          
          <div class="method-source-code" id="neg_int-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 380</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">neg_int</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">regs</span>, <span class="ruby-value">t:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">t_is_zero:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">optimize_last:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;neg_int invalid arguments!&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span>
                                                       <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">any?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">r</span>.<span class="ruby-identifier">bit8?</span> } <span class="ruby-keyword">or</span>
                                                       <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">size</span> <span class="ruby-keyword">or</span>
                                                       <span class="ruby-operator">!</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">b</span>,<span class="ruby-identifier">c</span>,<span class="ruby-identifier">d</span>,<span class="ruby-identifier">e</span>,<span class="ruby-identifier">h</span>,<span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>))
    <span class="ruby-identifier">t</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">reverse_each</span>.<span class="ruby-identifier">with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">reg</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">t_is_zero</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">t</span>)
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">reg</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">optimize_last</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">regs</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">t</span>)
                <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">reg</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">t</span>
                <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">reg</span>
            <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">reg</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-rnd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rnd</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a Lehmer random number generator routine.</p>

<p>See: <a href="https://en.wikipedia.org/wiki/Lehmer_random_number_generator">en.wikipedia.org/wiki/Lehmer_random_number_generator</a></p>

<p>This routine uses the following parameters (similar to ZX-Spectrum ROM&#39;s):</p>

<pre class="ruby"><span class="ruby-identifier">s1</span> = (<span class="ruby-identifier">s0</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">75</span> <span class="ruby-operator">%</span> <span class="ruby-value">65537</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
</pre>

<p>Expects a seed (s0) in <code>hl</code> and produces the result (s1) in <code>hl</code>.</p>

<p>Modifies: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>

<p>T-states: ~ 547.7 (46 for seed=65535, 193 for seed&lt;=872, max: 601)</p>
          
          

          
          <div class="method-source-code" id="rnd-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3635</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rnd</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># seed + 1</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ora</span> <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">multi75</span> <span class="ruby-comment"># (seed + 1) &lt; 65536</span>
                                        <span class="ruby-comment"># return pre-calculated value</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-value">65536</span> <span class="ruby-operator">*</span> <span class="ruby-value">75</span> <span class="ruby-operator">%</span> <span class="ruby-value">65537</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>
                                        <span class="ruby-comment"># overflow 0x1_0000 - 0x1_0001 = -1 happens only for seeds:</span>
                                        <span class="ruby-comment"># 65535, 20097, 34952, 40195</span>
        <span class="ruby-identifier">ovrflow</span>         <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>           <span class="ruby-comment"># shift left (for all possible cases CF=0 after this)</span>
                                        <span class="ruby-comment"># otherwise we should have take care of CF=1</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">mnext</span>      <span class="ruby-comment"># this was the last iteration so the remainder result is 65536</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-identifier">eoc</span>         <span class="ruby-comment"># remainder = (borrow|hl = 0x1_0000) (seed - 1) == 65535</span>

                                        <span class="ruby-comment"># a|hl = (seed + 1) * 75</span>
        <span class="ruby-identifier">multi75</span>         <span class="ruby-identifier">mul_const8_24a</span>(<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>, <span class="ruby-value">75</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">tt:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">k_int24:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">signed_k:</span><span class="ruby-keyword">false</span>)
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># a|hl &lt; 0x1_0000: n mod 65537 == n</span>
                                        <span class="ruby-comment"># a|hl never == 0x1_0000 after multiplication by 75</span>
                                        <span class="ruby-comment"># so we can ignore some checks later</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">de</span>, <span class="ruby-value">-1</span>      <span class="ruby-comment"># a|hl mod 65537 (0x1_0001) goes to borrow|hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>        <span class="ruby-comment"># shift left this many times before dividend fits in a divisor</span>
        <span class="ruby-identifier">mloop0</span>          <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>      <span class="ruby-comment"># pre-shift left a|hl, highest bit to CF</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">dec</span> <span class="ruby-identifier">b</span>           <span class="ruby-comment"># no check if b==0, there&#39;ll be at most 8 iterations since a &gt;= 0x01</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">mloop0</span>  <span class="ruby-comment"># CF == 0: loop</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">l</span>        <span class="ruby-comment"># swap registers: hl|a = a|hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">l</span>, <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
                        <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># hl = hl - 1, in effect: borrow|hl = 0x1_nnnn - 0x1_0001 = 0x0_mmmm</span>
                                        <span class="ruby-comment"># no need to check for overflow here since 65536 is never a result of n*75</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">fits</span>     <span class="ruby-comment"># b==0: (seed + 1) * 75 == 0x0001_nnnn</span>
        <span class="ruby-identifier">mloop1</span>          <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span>           <span class="ruby-comment"># shift left hl|a, highest bit to CF</span>
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">mnext</span>   <span class="ruby-comment"># CF == 0: continue</span>
                        <span class="ruby-identifier">add</span> <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">de</span>      <span class="ruby-comment"># borrow|hl = 0x1_nnnn - 0x1_0001</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">ovrflow</span> <span class="ruby-comment"># 0x1_0000 - 0x1_0001 = -1 (0x1_FFFF)</span>
        <span class="ruby-identifier">mnext</span>           <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">mloop1</span>
        <span class="ruby-identifier">fits</span>            <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>          <span class="ruby-comment"># seed - 1</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sign_extend" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sign_extend</span><span
            class="method-args">(t=a, s=a)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that extends a sign bit from an octet indicated by <code>s</code> into a <code>t</code>.</p>
<dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>A target 8-bit register or a pointer.</p>
</dd><dt><code>s</code>
<dd>
<p>An octet being sign-extended as an 8-bit register or a pointer.</p>
</dd></dl>

<p>Uses: <code>af</code>, <code>t</code>, optionally preserves: <code>s</code>.</p>

<p>T-states: 8|12|16.</p>
          
          

          
          <div class="method-source-code" id="sign_extend-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 412</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sign_extend</span>(<span class="ruby-identifier">t</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">s</span>=<span class="ruby-identifier">a</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">s</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sll8_16" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sll8_16</span><span
            class="method-args">(bshift, th=h, tl=l, sl:tl, zero:0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Shift logical left 8-bit register with a result extended to 16-bits.</p>
<dl class="rdoc-list note-list"><dt><code>bshift</code>
<dd>
<p>How many bits to shift the content of the <code>tl</code> register.</p>
</dd><dt><code>th</code>
<dd>
<p>An 8-bit register, except the <code>accumulator</code> for receiving the highest 8 bits of the result.</p>
</dd><dt><code>tl</code>
<dd>
<p>An 8-bit register, except the <code>accumulator</code> for receiving the lowest 8 bits of the result.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>th</code>, <code>tl</code>, optionally preserves <code>a</code>, <code>sl</code>.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>sl</code>
<dd>
<p>An 8-bit register holding the initial value to shift.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>zero</code>
<dd>
<p>An 8-bit register holding zero value or a literal 0. Specifying a register may save additional 3 or 7 T-states.</p>
</dd></dl>
</li></ul>

<p>T-states (bshift):</p>

<pre>0-7:  7|11, 18|22|23|27, 29|31|33|35, 35|39, 39|43, 35|39, 31|35, 23|27,
8-15: 7|11, 15|19,       19|23,       23|27, 27|31, 22|26, 26|30, 30|34,
&gt;=16: 10|11</pre>
          
          

          
          <div class="method-source-code" id="sll8_16-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 542</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sll8_16</span>(<span class="ruby-identifier">bshift</span>, <span class="ruby-identifier">th</span>=<span class="ruby-identifier">h</span>, <span class="ruby-identifier">tl</span>=<span class="ruby-identifier">l</span>, <span class="ruby-value">sl:</span><span class="ruby-identifier">tl</span>, <span class="ruby-value">zero:</span><span class="ruby-value">0</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lshift8_16: invalid arguments!&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">bshift</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">bshift</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span> <span class="ruby-keyword">and</span>
                                                             <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">th</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">th</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">and</span>
                                                             <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">tl</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">tl</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">and</span>
                                                             <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">sl</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">sl</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span>
                                                             (<span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span>
                                                                (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">zero</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">zero</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span>
                                                                    (<span class="ruby-identifier">zero</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">sl</span>)))
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">bshift</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">0</span> <span class="ruby-comment"># 0|4|7|11</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">1</span> <span class="ruby-comment"># 18|22|23|27</span>
            <span class="ruby-identifier">tc1</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-keyword">then</span> <span class="ruby-value">22</span> <span class="ruby-keyword">else</span> <span class="ruby-value">1000</span> <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">tc1</span> <span class="ruby-operator">-=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                <span class="ruby-identifier">tc1</span> <span class="ruby-operator">-=</span> <span class="ruby-value">7</span>
            <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">zero</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">l</span>)
                <span class="ruby-identifier">tc1</span> <span class="ruby-operator">-=</span> <span class="ruby-value">3</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">tc2</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-keyword">then</span> <span class="ruby-value">23</span> <span class="ruby-keyword">else</span> <span class="ruby-value">1000</span> <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">tc2</span> <span class="ruby-operator">-=</span> <span class="ruby-value">7</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">tc2</span> <span class="ruby-operator">-=</span> <span class="ruby-value">3</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">tc3</span> = <span class="ruby-value">27</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">tc3</span> <span class="ruby-operator">-=</span> <span class="ruby-value">4</span> <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-identifier">tc3</span> <span class="ruby-operator">-=</span> <span class="ruby-value">7</span>
            <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">th</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">zero</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tl</span>)
                <span class="ruby-identifier">tc3</span> <span class="ruby-operator">-=</span> <span class="ruby-value">3</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">tcmin</span> = [<span class="ruby-identifier">tc1</span>, <span class="ruby-identifier">tc2</span>, <span class="ruby-identifier">tc3</span>].<span class="ruby-identifier">min</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">tcmin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tc1</span>
                <span class="ruby-comment"># 11(+4|7)(+4)|15|18|19|22</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">tcmin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tc2</span> <span class="ruby-comment"># 16|20|23</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">else</span> <span class="ruby-comment"># 16(+4|7)(+4)|20|23|24|27</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">6</span> <span class="ruby-comment"># 29|31|33|35,35|39,39|43,35|39,31|35,(27|31)</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">bshift</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> 
                (<span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">zero</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>))
                <span class="ruby-comment"># 22(+4|7)(+4)|26|29|30|33</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">h</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">l</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">h</span>
                <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">hl</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
              <span class="ruby-keyword">if</span> <span class="ruby-identifier">bshift</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">4</span> <span class="ruby-comment"># 35|39,31|35,(27|31)</span>
                        (<span class="ruby-value">8</span><span class="ruby-operator">-</span><span class="ruby-identifier">bshift</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rrca</span> }
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">anda</span> (<span class="ruby-value">0xFF</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">bshift</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
              <span class="ruby-keyword">else</span> <span class="ruby-comment"># 31|35,35|39,39|43</span>
                        <span class="ruby-identifier">bshift</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rlca</span> }
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">anda</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">bshift</span>) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">7</span><span class="ruby-operator">..</span><span class="ruby-value">9</span> <span class="ruby-comment"># 23|27,7|11,15|19</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">bshift</span> <span class="ruby-operator">==</span> <span class="ruby-value">7</span>
                        <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">th</span>
                        <span class="ruby-identifier">rr</span>   <span class="ruby-identifier">tl</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">bshift</span> <span class="ruby-operator">==</span> <span class="ruby-value">9</span>
                        <span class="ruby-identifier">sla</span>  <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">10</span><span class="ruby-operator">..</span><span class="ruby-value">12</span> <span class="ruby-comment"># (15|19),19|23,23|27,27|31</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-keyword">end</span>
                        (<span class="ruby-identifier">bshift</span><span class="ruby-value">-8</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">add</span> <span class="ruby-identifier">a</span> }
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">13</span><span class="ruby-operator">..</span><span class="ruby-value">15</span> <span class="ruby-comment"># 22|26,26|30,30|34</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tl</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">zero</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
            <span class="ruby-keyword">end</span>
                        (<span class="ruby-value">16</span><span class="ruby-operator">-</span><span class="ruby-identifier">bshift</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rrca</span> }
                          <span class="ruby-identifier">anda</span> (<span class="ruby-value">0xFF</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">bshift</span><span class="ruby-value">-8</span>)) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>
                        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span> <span class="ruby-comment"># 4|8|10|11</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">th</span>.<span class="ruby-identifier">match16?</span>(<span class="ruby-identifier">tl</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                          <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span><span class="ruby-operator">|</span><span class="ruby-identifier">tl</span>, <span class="ruby-value">0</span>
            <span class="ruby-keyword">else</span>
                          <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">zero</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span>
                          <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">zero</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sub_from" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sub_from</span><span
            class="method-args">(s, th, tl, oh:th, ol:tl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that subtracts an 8-bit <code>s</code> register value from a 16-bit value in a <code>th</code>|<code>tl</code> register pair.</p>
<dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>A subtractor as an 8-bit register except the accumulator.</p>
</dd><dt><code>th</code>
<dd>
<p>An 8-bit register containing MSB bits of the 16-bit value.</p>
</dd><dt><code>tl</code>
<dd>
<p>An 8-bit register containing LSB bits of the 16-bit value.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>oh</code>
<dd>
<p>An output MSB 8-bit register, <code>th</code> by default.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ol</code>
<dd>
<p>An output LSB 8-bit register, <code>tl</code> by default.</p>
</dd></dl>
</li></ul>

<p>As a side effect: <code>a</code> equals to <code>oh</code> when the routine ends.</p>

<h4 id="method-i-sub_from-label-Note-3A">Note:<span><a href="#method-i-sub_from-label-Note-3A">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Although this method is often a more convenient way to subtract an 8-bit unsigned register value from a 16-bit pair of registers, it does not set flags properly.</p>

<p>Uses: <code>af</code>, <code>th</code>, <code>tl</code>, preserves: <code>s</code>.</p>

<p>T-states: 24</p>
          
          

          
          <div class="method-source-code" id="sub_from-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 476</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sub_from</span>(<span class="ruby-identifier">s</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-value">oh:</span><span class="ruby-identifier">th</span>, <span class="ruby-value">ol:</span><span class="ruby-identifier">tl</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">oh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ol</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ol</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">th</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">s</span>,<span class="ruby-identifier">th</span>,<span class="ruby-identifier">ol</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;sub_from: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">tl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tl</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">s</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ol</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">sbc</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">th</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">oh</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">oh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-trailing_zeros" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">trailing_zeros</span><span
            class="method-args">(m, bitsize:8)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the number of trailing zeros in the binary representation of <code>m</code>.</p>
          
          

          
          <div class="method-source-code" id="trailing_zeros-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">trailing_zeros</span>(<span class="ruby-identifier">m</span>, <span class="ruby-value">bitsize:</span><span class="ruby-value">8</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;trailing_zeros: m is not an integer&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">m</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;trailing_zeros: m is out of range&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">&gt;=</span> (<span class="ruby-value">1</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">bitsize</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">bitsize</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">zero?</span>
    <span class="ruby-identifier">zshift</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">while</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">zshift</span>)).<span class="ruby-identifier">zero?</span>
        <span class="ruby-identifier">zshift</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">zshift</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-twos_complement16_by_sgn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">twos_complement16_by_sgn</span><span
            class="method-args">(sh, sl, sgn, th:sh, tl:sl, t:sgn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that changes the sign of a twos complement 16-bit integer depending on the content of the <code>sgn</code>.</p>
<dl class="rdoc-list note-list"><dt><code>sh</code>
<dd>
<p>An 8-bit register holding MSB of the input 16-bit integer.</p>
</dd><dt><code>sl</code>
<dd>
<p>An 8-bit register holding LSB of the input 16-bit integer.</p>
</dd><dt><code>sgn</code>
<dd>
<p>An 8-bit sign register which must hold 0 or -1 (0xFF).</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>th</code>
<dd>
<p>An 8-bit MSB output register, may be the same as <code>sh</code> or <code>sl</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tl</code>
<dd>
<p>An 8-bit LSB output register, may be the same as <code>sl</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit temporary register, which is used when <code>sgn</code> is the accumulator.</p>
</dd></dl>
</li></ul>

<p>When <code>sgn</code> equals to 0 an integer is left unmodified: <code>th</code>|<code>tl</code> = <code>sh</code>|<code>sl</code>. When <code>sgn</code> equals to -1 an integer&#39;s sign is being changed: <code>th</code>|<code>tl</code> = 0 - <code>sh</code>|<code>sl</code>.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Other values of <code>sgn</code> will render unexpected results.</p>
</dd></dl>

<p>Uses: <code>af</code>, <code>th</code>, <code>tl</code>, preserves: <code>sgn</code> and optionally: <code>sh</code>, <code>sl</code>.</p>

<p>T-states: 32</p>
          
          

          
          <div class="method-source-code" id="twos_complement16_by_sgn-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 281</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">twos_complement16_by_sgn</span>(<span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>, <span class="ruby-identifier">sgn</span>, <span class="ruby-value">th:</span><span class="ruby-identifier">sh</span>, <span class="ruby-value">tl:</span><span class="ruby-identifier">sl</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">sgn</span>)
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>, <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">sh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">sh</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tl</span> <span class="ruby-keyword">or</span>
       [<span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">sgn</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">sh</span>, <span class="ruby-identifier">sl</span>, <span class="ruby-identifier">th</span>, <span class="ruby-identifier">tl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;twos_complement16_by_sgn: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">sgn</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">sgn</span> = <span class="ruby-identifier">t</span>
            <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">sgn</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sgn</span>
        <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">xor</span>   <span class="ruby-identifier">sl</span>
            <span class="ruby-identifier">sub</span>   <span class="ruby-identifier">sgn</span>
            <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">tl</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sh</span>
            <span class="ruby-identifier">adc</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">sgn</span>
            <span class="ruby-identifier">xor</span>   <span class="ruby-identifier">sgn</span>
            <span class="ruby-identifier">ld</span>    <span class="ruby-identifier">th</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">th</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-utobcd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">utobcd</span><span
            class="method-args">(bufend, input=de, size: 4, r: d, rr: de, byteorder: :lsb, input_end:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts an unsigned binary integer of an arbitrary size to a BCD string.</p>
<dl class="rdoc-list note-list"><dt><code>bufend</code>
<dd>
<p>A direct address of the byte immediately following an end of the BCD memory area as an integer or a label or a pointer to the memory address holding the <code>bufend</code> value.</p>
</dd><dt><code>input</code>
<dd>
<p>An address of the binary integer being converted as an integer, a label, a pointer or <code>rr</code>.</p>
</dd></dl>

<p>After the conversion is done the <code>c&#39;</code> register will hold the number of bytes written to the buffer and <code>hl&#39;</code> will hold the address of the first byte of the result.</p>

<p>Provide a large enough BCD buffer. E.g. for a 32-bit integer, 5 bytes (10 digits) should be enough.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>size</code>
<dd>
<p>A byte size of the integer being converted as an integer, a label, a pointer or an 8-bit register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>r</code>
<dd>
<p>A temporary register used in an alternative register set: <code>d</code> or <code>e</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rr</code>
<dd>
<p>A 16-bit register: <code>de</code> or <code>hl</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>byteorder</code>
<dd>
<p>The order of bytes in the integer being converted: <code>:lsb</code> or <code>:msb</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>input_end</code>
<dd>
<p>Indicates that <code>input</code> points to the byte after the end of the integer payload instead of pointing to its beginning.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>b</code>, <code>rr</code>, <code>bc&#39;</code>, <code>hl&#39;</code>, <code>r&#39;</code>.</p>
          
          

          
          <div class="method-source-code" id="utobcd-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3739</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">utobcd</span>(<span class="ruby-identifier">bufend</span>, <span class="ruby-identifier">input</span>=<span class="ruby-identifier">de</span>, <span class="ruby-value">size:</span> <span class="ruby-value">4</span>, <span class="ruby-value">r:</span> <span class="ruby-identifier">d</span>, <span class="ruby-value">rr:</span> <span class="ruby-identifier">de</span>, <span class="ruby-value">byteorder:</span> <span class="ruby-value">:lsb</span>, <span class="ruby-value">input_end:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">bufend</span>) <span class="ruby-keyword">and</span>
                               (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">input</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">rr</span>) <span class="ruby-keyword">and</span>
                               (<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">size</span>.<span class="ruby-identifier">bit8?</span>)) <span class="ruby-keyword">and</span>
                               [<span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rr</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;input_end should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">input_end</span>)
    <span class="ruby-identifier">adjust_input</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">byteorder</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:lsb</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">!</span><span class="ruby-identifier">input_end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:msb</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">input_end</span>
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;byteorder should be :lsb or :msb&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">size</span>)
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">size</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">adjust_input</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:lsb</span> <span class="ruby-keyword">and</span>
                    (<span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">input</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">address?</span>(<span class="ruby-identifier">input</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span><span class="ruby-identifier">address?</span>(<span class="ruby-identifier">size</span>))
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">size</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">size</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">adjust_input</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">input</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">size</span>) <span class="ruby-keyword">and</span>
                            <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">input</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">size</span>)
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">rr</span>, <span class="ruby-identifier">input</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">size</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:lsb</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">rr</span>, <span class="ruby-identifier">input</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">size</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:msb</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">rr</span>, <span class="ruby-identifier">input</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">input</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">rr</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">adjust_input</span>
                <span class="ruby-identifier">adda_to</span> <span class="ruby-operator">*</span><span class="ruby-identifier">rr</span>.<span class="ruby-identifier">split</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:lsb</span>
                <span class="ruby-identifier">sub_from</span> <span class="ruby-identifier">b</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">rr</span>.<span class="ruby-identifier">split</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:msb</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">bufend</span>)
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">bufend</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>], <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">exx</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">bufend</span>)
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bufend</span>
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">1</span>
                <span class="ruby-identifier">exx</span>
        <span class="ruby-identifier">loopi</span>   <span class="ruby-identifier">label</span>
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">rr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:lsb</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">rr</span>]
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">rr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">byteorder</span> <span class="ruby-operator">==</span> <span class="ruby-value">:msb</span>
                <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">utobcd_step</span>(<span class="ruby-identifier">bufend</span>, <span class="ruby-identifier">r</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">c</span>, <span class="ruby-keyword">true</span>)
                <span class="ruby-identifier">exx</span>
                <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loopi</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-utobcd_step" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">utobcd_step</span><span
            class="method-args">(bufend, r, buflen=1, t=c, r_in_a=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts an 8-bit unsigned integer to a BCD string.</p>

<p>Used by <a href="Macros.html#method-i-utobcd"><code>Macros.utobcd</code></a>.</p>
<dl class="rdoc-list note-list"><dt><code>bufend</code>
<dd>
<p>A direct address of the byte immediately following an end of the BCD memory area as an integer or a label or a pointer to the memory address holding the <code>bufend</code> value.</p>
</dd><dt><code>r</code>
<dd>
<p>An 8-bit register holding the integer during conversion: <code>c</code>, <code>d</code> or <code>e</code>.</p>
</dd><dt><code>buflen</code>
<dd>
<p>The current byte size of the BCD buffer as an integer, a label or <code>t</code>.</p>
</dd><dt><code>t</code>
<dd>
<p>The register holding the current byte size of the BCD buffer: <code>c</code>, <code>d</code> or <code>e</code>.</p>
</dd><dt><code>r_in_a</code>
<dd>
<p><code>true</code> if the integer to convert is provided in <code>accumulator</code> instead of in <code>r</code>.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>b</code>, <code>r</code>, <code>t</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="utobcd_step-source">
            <pre><span class="ruby-comment"># File lib/z80/math_i.rb, line 3691</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">utobcd_step</span>(<span class="ruby-identifier">bufend</span>, <span class="ruby-identifier">r</span>, <span class="ruby-identifier">buflen</span>=<span class="ruby-value">1</span>, <span class="ruby-identifier">t</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">r_in_a</span>=<span class="ruby-keyword">false</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">bufend</span>) <span class="ruby-keyword">and</span>
                               [<span class="ruby-identifier">c</span>,<span class="ruby-identifier">d</span>,<span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">c</span>,<span class="ruby-identifier">d</span>,<span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">r</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword">and</span>
                               ((<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">buflen</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">buflen</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">buflen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>)
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">r</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">r_in_a</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">t</span>, <span class="ruby-identifier">buflen</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">buflen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>
                        <span class="ruby-identifier">scf</span>
                        <span class="ruby-identifier">rla</span>              <span class="ruby-comment"># carry &lt;- a &lt;- 1</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">r</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-identifier">buffmul</span>         <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bufend</span>   <span class="ruby-comment"># multiply buffer[] * 2 + carry using BCD</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">b</span>, <span class="ruby-identifier">t</span>
        <span class="ruby-identifier">nextadd</span>         <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
                        <span class="ruby-identifier">adc</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">daa</span>
                        <span class="ruby-identifier">ld</span>  [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>
                        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">nextadd</span>
                        <span class="ruby-identifier">jr</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">nbufext</span>  <span class="ruby-comment"># no carry</span>
                        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">t</span>            <span class="ruby-comment"># extend buffer on carry</span>
                        <span class="ruby-identifier">dec</span> <span class="ruby-identifier">hl</span>
                        <span class="ruby-identifier">ld</span>  [<span class="ruby-identifier">hl</span>], <span class="ruby-value">1</span>      <span class="ruby-comment"># put 1 in new place</span>
        <span class="ruby-identifier">nbufext</span>         <span class="ruby-identifier">sla</span> <span class="ruby-identifier">r</span>            <span class="ruby-comment"># carry &lt;- r &lt;- 0</span>
                        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">buffmul</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

