<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Z80::Program - ruby-Z80</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="Program/Macros.html">Z80::Program::Macros</a>
  
  
  
    <li><a class="include" href="Program/Mnemonics.html">Z80::Program::Mnemonics</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-5B-5D">#[]</a>
    
    <li ><a href="#method-i-addr">#addr</a>
    
    <li ><a href="#method-i-address-3F">#address?</a>
    
    <li ><a href="#method-i-bytes">#bytes</a>
    
    <li ><a href="#method-i-data">#data</a>
    
    <li ><a href="#method-i-db">#db</a>
    
    <li ><a href="#method-i-define_label">#define_label</a>
    
    <li ><a href="#method-i-dw">#dw</a>
    
    <li ><a href="#method-i-export">#export</a>
    
    <li ><a href="#method-i-immediate-3F">#immediate?</a>
    
    <li ><a href="#method-i-import">#import</a>
    
    <li ><a href="#method-i-import_file">#import_file</a>
    
    <li ><a href="#method-i-isolate">#isolate</a>
    
    <li ><a href="#method-i-label">#label</a>
    
    <li ><a href="#method-i-label-3F">#label?</a>
    
    <li ><a href="#method-i-label_defined-3F">#label_defined?</a>
    
    <li ><a href="#method-i-label_immediate-3F">#label_immediate?</a>
    
    <li ><a href="#method-i-label_import">#label_import</a>
    
    <li ><a href="#method-i-macro_import">#macro_import</a>
    
    <li ><a href="#method-i-method_missing">#method_missing</a>
    
    <li class="calls-super" ><a href="#method-i-new">#new</a>
    
    <li ><a href="#method-i-ns">#ns</a>
    
    <li ><a href="#method-i-org">#org</a>
    
    <li ><a href="#method-i-pc">#pc</a>
    
    <li ><a href="#method-i-pointer-3F">#pointer?</a>
    
    <li ><a href="#method-i-register-3F">#register?</a>
    
    <li ><a href="#method-i-select">#select</a>
    
    <li ><a href="#method-i-union">#union</a>
    
    <li ><a href="#method-i-unwrap_pointer">#unwrap_pointer</a>
    
    <li ><a href="#method-i-words">#words</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Z80::Program">
  <h1 id="module-Z80::Program" class="module">
    module Z80::Program
  </h1>

  <section class="description">
    
<p>This module defines methods that become your program&#39;s class methods when you include the <a href="../Z80.html"><code>Z80</code></a> module. This includes all of <a href="Program/Macros.html"><code>Program::Macros</code></a> and <a href="Program/Mnemonics.html"><code>Program::Mnemonics</code></a> methods as well as <a href="Program/Macros.html"><code>Macros</code></a> module defined in the including class.</p>

<p>Use these methods to build your <a href="../Z80.html"><code>Z80</code></a> assembler program or macros.</p>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="VERSION">VERSION
        
        <dd>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-code" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">code</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>A raw, not relocated code.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-debug" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">debug</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>A raw, debug information.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-exports" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">exports</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Exportable labels.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-reloc" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">reloc</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>A relocation table.</p>
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-5B-5D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">[]</span><span
            class="method-args">(label)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Method used internally by mnemonics to make a pointer of a label or a <a href="Program/Register.html"><code>Register</code></a>.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">foo</span>]
<span class="ruby-comment"># is equivalent to</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">foo</span>[]
<span class="ruby-comment"># is equivalent to</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">[]</span>(<span class="ruby-identifier">foo</span>)
<span class="ruby-comment"># or</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">foo</span>[<span class="ruby-value">5</span>]]
<span class="ruby-comment"># is equivalent to</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">foo</span>[<span class="ruby-value">5</span>][]
<span class="ruby-comment"># is equivalent to</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">[]</span>(<span class="ruby-identifier">foo</span>[<span class="ruby-value">5</span>])
<span class="ruby-comment"># or</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, [<span class="ruby-identifier">foo</span> <span class="ruby-operator">-</span> <span class="ruby-value">8</span>]
<span class="ruby-comment"># is equivalent to</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, (<span class="ruby-identifier">foo</span> <span class="ruby-operator">-</span> <span class="ruby-value">8</span>)[]
<span class="ruby-comment"># is equivalent to</span>
<span class="ruby-identifier">ld</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">[]</span>(<span class="ruby-identifier">foo</span> <span class="ruby-operator">-</span> <span class="ruby-value">8</span>)
</pre>
          
          

          
          <div class="method-source-code" id="5B-5D-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 61</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">[]</span>(<span class="ruby-identifier">label</span>)
        <span class="ruby-identifier">label</span> = <span class="ruby-identifier">label</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_label</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>)
                <span class="ruby-identifier">label</span>[]
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Condition</span>)
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;Invalid pointer argument.&quot;</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">label</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-value">1</span>)[]
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-addr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">addr</span><span
            class="method-args">(address, type = 1, align: 1, offset: 0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns an unnamed, immediate label at an absolute <code>address</code> of the optional <code>type</code>.</p>

<p><code>type</code> can be an integer or a data structure (a class derived from <a href="Label.html"><code>Label</code></a>). The <code>address</code> may be a number or another label or an immediate expression. It may also be a <code>:next</code> symbol. In this instance the label address will be the previously added label address offset by its size.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:align</code>
<dd>
<p>Additionally aligns the <code>address</code> to the nearest multiple of <code>:align</code> bytes.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:offset</code>
<dd>
<p>Added to the <code>address</code> after alignment.</p>
</dd></dl>
</li></ul>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">foo</span> <span class="ruby-identifier">addr</span> <span class="ruby-value">0xffff</span>
<span class="ruby-identifier">bar</span> <span class="ruby-identifier">addr</span> <span class="ruby-value">0x4000</span>, <span class="ruby-value">2</span>
<span class="ruby-identifier">baz</span> <span class="ruby-identifier">addr</span> <span class="ruby-value">:next</span>, <span class="ruby-value">2</span> <span class="ruby-comment"># 0x4002</span>
</pre>
          
          

          
          <div class="method-source-code" id="addr-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 208</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">addr</span>(<span class="ruby-identifier">address</span>, <span class="ruby-identifier">type</span> = <span class="ruby-value">1</span>, <span class="ruby-value">align:</span> <span class="ruby-value">1</span>, <span class="ruby-value">offset:</span> <span class="ruby-value">0</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-value">:next</span>
                <span class="ruby-identifier">last_label</span> = <span class="ruby-ivar">@labels</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">last</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;There is no label added to the program yet.&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_label</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">addr</span> <span class="ruby-identifier">last_label</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">type</span>, <span class="ruby-value">align:</span><span class="ruby-identifier">align</span>, <span class="ruby-value">offset:</span><span class="ruby-identifier">offset</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">address</span> = <span class="ruby-identifier">address</span>.<span class="ruby-identifier">to_i</span>
                <span class="ruby-identifier">align</span> = <span class="ruby-identifier">align</span>.<span class="ruby-identifier">to_i</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;align must be &gt;= 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
                <span class="ruby-identifier">address</span> = (<span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">offset</span>.<span class="ruby-identifier">to_i</span>
                <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">address</span>, <span class="ruby-identifier">type</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-address-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">address?</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A convenient method for macros to check if argument is a non-register value or a pointer.</p>

<p>Returns <code>true</code> for:</p>

<pre>0x1234, foo, :foo, [0x1234], [foo], foo[10], [:foo], [foo + 10]</pre>
          
          

          
          <div class="method-source-code" id="address-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 135</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">address?</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
        <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_label</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bytes" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            bytes count
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            bytes count, byte_integer, ...
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            bytes count, [byte_integer, ...]
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            bytes [byte_integer, ...]
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns an unnamed label and allocates <code>count</code> bytes with <a href="Program.html#method-i-data"><code>Program.data</code></a>. Optionally you can provide values for the allocated bytes.</p>

<p>See: <a href="Program.html#method-i-data"><code>Program.data</code></a>.</p>
          
          

          
          <div class="method-source-code" id="bytes-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 370</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bytes</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>); <span class="ruby-identifier">data</span>(<span class="ruby-value">1</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>); <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-data" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            data(type = 1)
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            data(type, size = nil)
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            data(type, size, *data)
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            data(type, *data)
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            data(str[, size = str.bytesize])
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns an unnamed, relative label and adds provided data to the <a href="Program.html#attribute-i-code"><code>Program.code</code></a> at <a href="Program.html#method-i-pc"><code>Program.pc</code></a>.</p>

<p>The <code>type</code> argument may be a number <code>1</code> to indicate bytes or <code>2</code> to indicate words. To store larger integers please consult <a href="MathInt/Macros.html#method-i-int"><code>Z80::MathInt::Macros.int</code></a>.</p>

<p><code>type</code> may also be a class derived from <a href="Label.html"><code>Label</code></a>, which represents a data structure with named fields. In this instance each <code>data</code> argument must be an Array or a Hash containing data for each field in the structure. Please consult <a href="Label.html"><code>Label</code></a> for more information and examples.</p>

<p><code>type</code> may also be one of the following symbols - in this instance the <code>type</code> will always be 1 (a byte):</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:pc</code>
<dd>
<p>A <code>data</code> label will be evaluated relatively to the program counter, e.g. an offset of a jump table.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:jr</code>
<dd>
<p>A <code>data</code> label will be evaluated relatively to the program counter + 1, like an offset of a <code>jr</code> instruction.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:self</code>
<dd>
<p>A <code>data</code> label will be evaluated relatively to self, like an offset of an address using <code>ix</code>/<code>iy</code> registers. In this instance all labels but fields will evaluate to 0.</p>
</dd></dl>
</li></ul>

<p>If the first argument is a string, a label is being created of the <code>type</code> being equal to the string&#39;s byte size. It allows you to easily access string&#39;s size with unary + method on a returned label. The string is being added as a binary string to <a href="Program.html#attribute-i-code"><code>Program.code</code></a> at <a href="Program.html#method-i-pc"><code>Program.pc</code></a> and may be limited (or extended) with a <code>size</code> argument. Any other arguments are ignored in this form.</p>

<p>The <code>data</code> argument must be one of the following:</p>
<ul><li>
<p>A string: it will be added as a binary string.</p>
</li><li>
<p>A convertible <a href="../Object.html"><code>Object</code></a> (with method <code>:to_z80bin</code> which should return a binary string).</p>
</li><li>
<p>An integer (starting from 3rd argument), a label or a lazy evaluated expression will be added as a byte or a word (2-bytes, LSB) depending on the <code>type</code>.</p>
</li><li>
<p>An array of integers, strings, convertible objects or labels (the array will be flattened), will be added consecutively to the <a href="Program.html#attribute-i-code"><code>Program.code</code></a>.</p>
</li></ul>

<p>If the <code>size</code> is specified as a second argument, <code>data</code> will be padded with zeroes or cut according to <code>size</code> * <code>type.to_i</code>.</p>

<p>Examples:</p>

<pre class="ruby"><span class="ruby-comment"># Creates &quot;foo&quot; label of type 2 and fills 10 bytes of code (5 words) with data from array.</span>
<span class="ruby-identifier">foo</span>   <span class="ruby-identifier">data</span> <span class="ruby-value">2</span>, [<span class="ruby-value">0</span>, <span class="ruby-value">2</span>, <span class="ruby-value">4</span>, <span class="ruby-identifier">label1</span>, <span class="ruby-identifier">label2</span>]
<span class="ruby-comment"># Creates &quot;bar&quot; label and fills 10 bytes of code with 0s.</span>
<span class="ruby-identifier">bar</span>   <span class="ruby-identifier">data</span> <span class="ruby-value">1</span>, <span class="ruby-value">10</span>
<span class="ruby-comment"># Creates &quot;bar&quot; label and fills 2 words of code with data from an array and the rest (3 words) with 0s.</span>
<span class="ruby-identifier">baz</span>   <span class="ruby-identifier">data</span> <span class="ruby-value">2</span>, <span class="ruby-value">5</span>, [<span class="ruby-value">1</span>, <span class="ruby-value">2</span>]
<span class="ruby-identifier">baz</span>   <span class="ruby-identifier">data</span> <span class="ruby-value">2</span>, <span class="ruby-value">5</span>, <span class="ruby-value">1</span>, <span class="ruby-value">2</span>
<span class="ruby-comment"># Creates &quot;mystr&quot; label and fills 12 bytes of code with bytes from a string, adds a byte +10+ at the end.</span>
<span class="ruby-identifier">mystr</span> <span class="ruby-identifier">data</span> <span class="ruby-value">1</span>, <span class="ruby-string">&quot;Hello World!&quot;</span>, <span class="ruby-value">10</span>
<span class="ruby-comment"># Creates &quot;mystr&quot; label and fills 12 bytes of code with bytes from a string, adds a word +4242+ at the end</span>
<span class="ruby-comment"># and fills additional 14 bytes of code with 0s.</span>
<span class="ruby-identifier">mystr</span> <span class="ruby-identifier">data</span> <span class="ruby-value">2</span>, <span class="ruby-value">20</span>, <span class="ruby-string">&quot;Hello World!&quot;</span>, <span class="ruby-value">4242</span>
<span class="ruby-comment"># Creates &quot;hello&quot; label which addresses the following string and +hello resolves to its length</span>
<span class="ruby-comment"># which is 12 in this instance.</span>
<span class="ruby-identifier">hello</span> <span class="ruby-identifier">data</span> <span class="ruby-string">&quot;Hello World!&quot;</span>
</pre>

<p>See also: <a href="Label.html"><code>Label</code></a> for additional examples on how to use labels in a more advanced way.</p>
          
          

          
          <div class="method-source-code" id="data-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 307</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">data</span>(<span class="ruby-identifier">type</span> = <span class="ruby-value">1</span>, <span class="ruby-identifier">size</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
        <span class="ruby-identifier">res</span> = <span class="ruby-string">&#39;&#39;</span>
        <span class="ruby-identifier">from</span> = <span class="ruby-value">0</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">type</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">:jr</span>, <span class="ruby-value">:pc</span>, <span class="ruby-value">:self</span>
                        <span class="ruby-identifier">from</span> = <span class="ruby-identifier">type</span>
                        <span class="ruby-identifier">type</span> = <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:to_data</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">size</span>
                        <span class="ruby-identifier">args</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">size</span>
                        <span class="ruby-identifier">size</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">length</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">type_size</span> = <span class="ruby-identifier">type</span>.<span class="ruby-identifier">to_i</span>
                <span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">type</span>.<span class="ruby-identifier">to_data</span>(<span class="ruby-keyword">self</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">*</span><span class="ruby-identifier">type_size</span>, <span class="ruby-identifier">args</span>.<span class="ruby-identifier">shift</span>)
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">size</span> = <span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">type</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
                <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">type</span>
                <span class="ruby-identifier">type</span> = <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">bytesize</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">bsize</span> = <span class="ruby-identifier">type</span>.<span class="ruby-identifier">to_i</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;Invalid data type&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bsize</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">bsize</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
                <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">size</span>
                        <span class="ruby-identifier">size</span> <span class="ruby-operator">*=</span> <span class="ruby-identifier">bsize</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">args</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">size</span>
                        <span class="ruby-identifier">size</span> = <span class="ruby-keyword">nil</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">pack_string</span> = <span class="ruby-identifier">bsize</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-string">&#39;c&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;s&lt;&#39;</span>
                <span class="ruby-identifier">args</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">data</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> 
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:to_label</span>
                                <span class="ruby-keyword">case</span> <span class="ruby-identifier">bsize</span>
                                <span class="ruby-keyword">when</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_reloc</span>(<span class="ruby-keyword">self</span>, <span class="ruby-identifier">data</span>, <span class="ruby-value">1</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">from</span>)
                                <span class="ruby-keyword">when</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span> <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_reloc</span>(<span class="ruby-keyword">self</span>, <span class="ruby-identifier">data</span>, <span class="ruby-value">2</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)
                                <span class="ruby-keyword">end</span>
                        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:to_z80bin</span>
                                <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_z80bin</span>
                        <span class="ruby-keyword">elsif</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">data</span>
                                [<span class="ruby-identifier">data</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-identifier">pack_string</span>)
                        <span class="ruby-keyword">else</span>
                                <span class="ruby-identifier">data</span>.<span class="ruby-identifier">to_s</span>
                        <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">size</span>
                <span class="ruby-identifier">res</span> = <span class="ruby-identifier">res</span>.<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">size</span>, <span class="ruby-string">&quot;\x0&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">size</span>
                <span class="ruby-identifier">res</span>.<span class="ruby-identifier">slice!</span>(<span class="ruby-identifier">size</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_code</span>(<span class="ruby-keyword">self</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">ASCII_8BIT</span>), <span class="ruby-identifier">type</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-db" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            db *byte_integers
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns an unnamed label and adds the provided integers to <a href="Program.html#attribute-i-code"><code>Program.code</code></a> as bytes.</p>

<p>See: <a href="Program.html#method-i-data"><code>Program.data</code></a>.</p>
          
          

          
          <div class="method-source-code" id="db-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 377</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">db</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>); <span class="ruby-identifier">data</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">args</span>); <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-define_label" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">define_label</span><span
            class="method-args">(name, label=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Defines a label with the given name in the current namespace&#39;s context. Returns a named label.</p>

<p>A <code>label</code>, if provided, may be an integer, an instance of an unnamed label, or a lazy evaluated expression. If <code>label</code> has already some different name an error will be raised.</p>

<p>If <code>label</code> argument is missing the “dummy” label (a label that is being referenced before being given value and type) is being created instead. See <a href="Label.html"><code>Label</code></a> and <a href="Label.html#method-i-dummy-3F"><code>Label.dummy?</code></a>.</p>

<p>This method exists for ability to create an arbitrary named label without any constraint on its name. However the way one should normally define labels is via: <a href="Program.html#method-i-method_missing"><code>method_missing</code></a></p>

<p>Example:.</p>

<pre class="ruby"><span class="ruby-identifier">define_label</span> <span class="ruby-value">:loop</span>, <span class="ruby-identifier">label</span>
        <span class="ruby-comment"># ... some code</span>
        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">define_label</span> <span class="ruby-value">:loop</span>
</pre>

<p>See <a href="Program.html#method-i-method_missing"><code>method_missing</code></a> for more examples.</p>
          
          

          
          <div class="method-source-code" id="define_label-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 415</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">define_label</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">label</span>=<span class="ruby-keyword">nil</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;there is no context for a label&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">ct</span> = <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">last</span>)
        <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">label</span>
                <span class="ruby-identifier">label</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_label</span>)
                        <span class="ruby-identifier">label</span>.<span class="ruby-identifier">to_label</span> <span class="ruby-keyword">self</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-value">1</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-ivar">@dummies</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">lbl</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">cts</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">n</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">cts</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">ct</span>.<span class="ruby-identifier">object_id</span>
                                <span class="ruby-identifier">lbl</span>.<span class="ruby-identifier">reinitialize</span> <span class="ruby-identifier">label</span>
                                <span class="ruby-identifier">label</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>
                                <span class="ruby-keyword">true</span>
                        <span class="ruby-keyword">else</span>
                                <span class="ruby-keyword">false</span>
                        <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">ct</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-identifier">name</span>
                        <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>].<span class="ruby-identifier">reinitialize</span> <span class="ruby-identifier">label</span>
                        <span class="ruby-identifier">label</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">label</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>
                        <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">label</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> <span class="ruby-ivar">@autoexport</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                        <span class="ruby-identifier">export</span> <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>]
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>]
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>]<span class="ruby-operator">||=</span> <span class="ruby-constant">Label</span>.<span class="ruby-identifier">dummy</span>(<span class="ruby-identifier">name</span>).<span class="ruby-identifier">to_alloc</span>
        <span class="ruby-keyword">end</span>.<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">label</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">label</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>
                <span class="ruby-ivar">@labels</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">name</span> <span class="ruby-comment"># move label to last position</span>
                <span class="ruby-ivar">@labels</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">label</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-dw" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            dw *word_integers
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns an unnamed label and adds the provided integers to <a href="Program.html#attribute-i-code"><code>Program.code</code></a> as words.</p>

<p>See: <a href="Program.html#method-i-data"><code>Program.data</code></a>.</p>
          
          

          
          <div class="method-source-code" id="dw-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 395</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">dw</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>); <span class="ruby-identifier">data</span>(<span class="ruby-value">2</span>, <span class="ruby-identifier">args</span>); <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-export" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            export label_name
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            export :auto
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            export :noauto
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Marks <code>label_name</code> as exportable. Programs may import labels from another programs with <a href="Program.html#method-i-import"><code>Program.import</code></a>. Only exportable labels will be imported into the parent program. Imported labels retain all their members.</p>

<p>Alternatively pass <code>:auto</code> symbol to make all subsequent top level labels exportable or <code>:noauto</code> to stop auto-exporting.</p>

<p>Only top level labels may be exported this way.</p>
          
          

          
          <div class="method-source-code" id="export-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 27</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">export</span>(<span class="ruby-identifier">label</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;Only labels on the top level may be exported&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">label</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:auto</span>
                <span class="ruby-ivar">@autoexport</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:noauto</span>, <span class="ruby-value">:no_auto</span>
                <span class="ruby-ivar">@autoexport</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">name</span> = <span class="ruby-identifier">label</span>.<span class="ruby-identifier">to_name</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-node">&quot;No label name for export: #{label.inspect}.&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">empty?</span>
                <span class="ruby-ivar">@exports</span>[<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>] = <span class="ruby-identifier">label</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-immediate-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">immediate?</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A convenient method for macros to check if argument is an immediate label or an integer.</p>

<p>Returns <code>true</code> for:</p>

<pre>foo addr 0x1234
0x1234, foo, :foo, [0x1234], [foo], foo[10], [:foo], [foo + 10]</pre>
          
          

          
          <div class="method-source-code" id="immediate-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 159</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">immediate?</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
        <span class="ruby-identifier">label_immediate?</span>(<span class="ruby-identifier">arg</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-import" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">import</span><span
            class="method-args">(program, name=nil, labels:true, code:true, macros:false, override:{}, args:[])</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Imports code, labels or macros from another <code>program</code> class. Give an optional <code>name</code> to create a namespace for the imported labels. With no <code>name</code> given, imported labels will be defined in the current context. Pass a class of a program (not an instance!).</p>

<p>Options to choose what to import:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:labels</code>
<dd>
<p><code>true/false</code> or an absolute address (default: <code>true</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:code</code>
<dd>
<p><code>true/false</code> or an absolute address (default: <code>true</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:macros</code>
<dd>
<p><code>true/false</code> (default: <code>false</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:override</code>
<dd>
<p>A flat hash containing names with labels to be replaced.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:args</code>
<dd>
<p>Initialize arguments for an imported program.</p>
</dd></dl>
</li></ul>

<p>Only labels marked with <a href="Program.html#method-i-export"><code>Program.export</code></a> are being imported. If <code>:labels</code> is an address, all relative labels being imported will be converted to absolute labels and will be offset by the given value.</p>

<p>If <code>:code</code> is an address, the imported code will be always compiled at the given address.</p>

<p>To be able to import <strong>macros</strong>, create a module named <code>Macros</code> inside your <a href="Program.html"><code>Program</code></a> class and put macro methods there.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>When creating macro methods remember to wrap the generated code in a namespace with <a href="Program.html#method-i-ns"><code>Program.ns</code></a> or better yet with <a href="Program.html#method-i-isolate"><code>Program.isolate</code></a>. The best practice is to return such a namespace, so it can be named later by the code invoking the macro.</p>
</dd></dl>

<p>Returns a label that points to the beginning of the imported code and its size is equal to the imported code size. If the name is given, the returned label will hold all the imported labels as sublabels.</p>
          
          

          
          <div class="method-source-code" id="import-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 537</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import</span>(<span class="ruby-identifier">program</span>, <span class="ruby-identifier">name</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-value">labels:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">code:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">macros:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">override:</span>{}, <span class="ruby-value">args:</span>[])
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">program</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Symbol</span>)
                <span class="ruby-identifier">program</span>, <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>, <span class="ruby-identifier">program</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;modules may not be imported from under namespaces&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>

        <span class="ruby-identifier">addr</span> = <span class="ruby-identifier">pc</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;override should be a map of override names to labels&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">override</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:map</span>)
        <span class="ruby-identifier">override</span> = <span class="ruby-identifier">override</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">v</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">v</span>
                <span class="ruby-keyword">when</span> <span class="ruby-constant">Integer</span>
                        <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">v</span>, <span class="ruby-value">0</span>)
                <span class="ruby-keyword">when</span> <span class="ruby-constant">Label</span>, <span class="ruby-constant">Alloc</span>
                        <span class="ruby-identifier">v</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;override: #{n} is not a label or an address&quot;</span>
                <span class="ruby-keyword">end</span>
                [<span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">v</span>]
        <span class="ruby-keyword">end</span>.<span class="ruby-identifier">to_h</span>

        <span class="ruby-identifier">code_addr</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">code</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_i</span>)
                <span class="ruby-identifier">code</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">macros</span>
                <span class="ruby-keyword">self</span>.<span class="ruby-identifier">extend</span> <span class="ruby-identifier">program</span><span class="ruby-operator">::</span><span class="ruby-constant">Macros</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-identifier">program</span><span class="ruby-operator">::</span><span class="ruby-constant">Macros</span>)
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">labels</span>
                <span class="ruby-identifier">label_addr</span>, <span class="ruby-identifier">absolute</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">labels</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_i</span>)
                        [<span class="ruby-identifier">labels</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-keyword">true</span>]
                <span class="ruby-keyword">else</span>
                        [<span class="ruby-identifier">addr</span>, <span class="ruby-keyword">false</span>]
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">members</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">program</span>.<span class="ruby-identifier">exports</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">l</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;only named labels may be exported&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">to_name</span>.<span class="ruby-identifier">nil?</span>
                        [<span class="ruby-identifier">n</span>, <span class="ruby-identifier">l</span>.<span class="ruby-identifier">deep_clone_with_relocation</span>(<span class="ruby-identifier">label_addr</span>, <span class="ruby-identifier">absolute</span>, <span class="ruby-identifier">override</span>)]
                }]
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">type</span> = <span class="ruby-identifier">code</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">program</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>
                <span class="ruby-identifier">plabel</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">type</span>, <span class="ruby-value">:code</span>, <span class="ruby-identifier">members</span>)
                <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">plabel</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">members</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">m</span>} <span class="ruby-keyword">if</span> <span class="ruby-identifier">members</span>
                <span class="ruby-identifier">plabel</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">addr</span>, <span class="ruby-identifier">type</span>, <span class="ruby-value">:code</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">code</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">program</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">bytesize</span>.<span class="ruby-identifier">zero?</span>
                <span class="ruby-ivar">@debug</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DebugInfo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-ivar">@context_labels</span>.<span class="ruby-identifier">dup</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">plabel</span>)
                <span class="ruby-ivar">@debug</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@imports</span>.<span class="ruby-identifier">size</span>
                <span class="ruby-ivar">@imports</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">program</span>, <span class="ruby-identifier">code_addr</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">override</span>]
                <span class="ruby-ivar">@code</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">program</span>.<span class="ruby-identifier">code</span>
                <span class="ruby-identifier">program</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">freeze</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">program</span>.<span class="ruby-identifier">freeze</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">labels</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">code</span>
        <span class="ruby-identifier">plabel</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-import_file" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">import_file</span><span
            class="method-args">(file, type = :any, size = nil, pipe:nil, check_size:nil, data_type:nil, **args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Imports a binary file.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>file</code>
<dd>
<p>A file name.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>type</code>
<dd>
<p>A format of a binary file (as a symbol), if <code>:any</code> -&gt; format will be determined by file name&#39;s extension.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>size</code>
<dd>
<p>A size in bytes to which imported data will be cropped or extended.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>pipe</code>
<dd>
<p>A <code>proc</code> to postprocess binary data with (e.g. compress it).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check_size</code>
<dd>
<p>A byte size to check the size (before pipe) of the imported data. If the sizes don&#39;t match a <a href="CompileError.html"><code>CompileError</code></a> will be raised.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>data_type</code>
<dd>
<p>A returned label&#39;s type.</p>
</dd></dl>
</li></ul>

<p>Any additional options are being passed to <code>read_data</code> method of the format handler.</p>

<p><strong>Currently only :tap or :tzx format is supported and only, if you include <a href="TAP.html"><code>Z80::TAP</code></a> in your program</strong>.</p>

<p>If format is not known, a file is being imported as a blob.</p>

<p>Returns an unnamed label that points to the beginning of imported data.</p>
          
          

          
          <div class="method-source-code" id="import_file-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 620</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">import_file</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">type</span> = <span class="ruby-value">:any</span>, <span class="ruby-identifier">size</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-value">pipe:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">check_size:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">data_type:</span><span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">args</span>)
        <span class="ruby-identifier">type</span> = <span class="ruby-identifier">type</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">upcase</span>.<span class="ruby-identifier">to_sym</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:ANY</span>
                <span class="ruby-identifier">type</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">file</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^\./</span>,<span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">upcase</span>.<span class="ruby-identifier">to_sym</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">data</span> = <span class="ruby-keyword">if</span> <span class="ruby-constant">Z80</span>.<span class="ruby-identifier">constants</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>) <span class="ruby-keyword">and</span> (<span class="ruby-identifier">handler</span> = <span class="ruby-constant">Z80</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">type</span>)) <span class="ruby-keyword">and</span> (<span class="ruby-identifier">handler</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:read_data</span>)
                <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Importing #{type} file: `#{file}&#39;.&quot;</span>
                <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">read_data</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">args</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Importing binary file: `#{file}&#39;.&quot;</span>
                <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>, <span class="ruby-string">&#39;rb&#39;</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>}
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">check_size</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;size does not match the imported file size: #{check_size} != #{data.bytesize}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_size</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">bytesize</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">pipe</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;pipe should be a proc&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">pipe</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:call</span>
                <span class="ruby-identifier">data</span> = <span class="ruby-identifier">pipe</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">data</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">data_type</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">data_type</span> = <span class="ruby-identifier">size</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">bytesize</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_code</span> <span class="ruby-keyword">self</span>, <span class="ruby-keyword">if</span> <span class="ruby-identifier">size</span>
                <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">size</span>].<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">size</span>, <span class="ruby-string">&quot;\x0&quot;</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">data</span>
        <span class="ruby-keyword">end</span>, <span class="ruby-identifier">data_type</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-isolate" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            isolate **opts {|eoc| ... }
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            isolate name, **opts {|eoc| ... }
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns a relative label, as an isolated namespace, holding labels defined by the code created with <code>block</code> as sub-labels. Appends the created code to the <a href="Program.html#attribute-i-code"><code>Program.code</code></a>.</p>

<p>In an isolated namespace you can&#39;t reference labels defined outside of it unless explicitly indicated with the <code>:use</code> option.</p>

<p>See: <a href="Program.html#method-i-ns"><code>Program#ns</code></a>.</p>
          
          

          
          <div class="method-source-code" id="isolate-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 316</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">isolate</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
        <span class="ruby-identifier">ns</span>(<span class="ruby-identifier">name</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>, <span class="ruby-value">isolate:</span> <span class="ruby-keyword">true</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-label" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">label</span><span
            class="method-args">(type = 1, align: nil, offset: 0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns an unnamed, relative label at <a href="Program.html#method-i-pc"><code>Program.pc</code></a> of the optional <code>type</code>.</p>

<p><code>type</code> can be an integer or a data structure (a class derived from <a href="Label.html"><code>Label</code></a>).</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:align</code>
<dd>
<p>Additionally lazily aligns a label to the nearest multiple of <code>:align</code> bytes applying a lazy evaluated expression to a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:offset</code>
<dd>
<p>Added to a label after alignment.</p>
</dd></dl>
</li></ul>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">foo</span>     <span class="ruby-identifier">label</span>
<span class="ruby-identifier">bar</span>     <span class="ruby-identifier">label</span> <span class="ruby-value">2</span>
</pre>
          
          

          
          <div class="method-source-code" id="label-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 177</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">label</span>(<span class="ruby-identifier">type</span> = <span class="ruby-value">1</span>, <span class="ruby-value">align:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">offset:</span> <span class="ruby-value">0</span>)
        <span class="ruby-identifier">lbl</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">pc</span>, <span class="ruby-identifier">type</span>, <span class="ruby-value">:code</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">offset</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-ivar">@debug</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DebugInfo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pc</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-ivar">@context_labels</span>.<span class="ruby-identifier">dup</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">lbl</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span>
                        <span class="ruby-identifier">align</span> = <span class="ruby-identifier">align</span>.<span class="ruby-identifier">to_i</span>
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;align must be &gt;= 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
                        <span class="ruby-identifier">lbl</span> = (<span class="ruby-identifier">lbl</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">align</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">lbl</span> = <span class="ruby-identifier">lbl</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">offset</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">offset</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">lbl</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-label-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">label?</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A convenient method for macros to check if argument is label-like.</p>

<p>Returns <code>true</code> for:</p>

<pre>foo, :foo, [foo], [foo + 10], [:foo]</pre>
          
          

          
          <div class="method-source-code" id="label-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 110</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">label?</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
        <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_label</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-label_defined-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">label_defined?</span><span
            class="method-args">(name)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>True if a label with a <code>name</code> is defined in the current context.</p>
          
          

          
          <div class="method-source-code" id="label_defined-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 93</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">label_defined?</span>(<span class="ruby-identifier">name</span>)
                <span class="ruby-ivar">@labels</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-label_immediate-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">label_immediate?</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A convenient method for macros to check if argument is an immediate label.</p>

<p>Returns <code>true</code> for:</p>

<pre>foo addr 0x1234
foo, :foo, [foo], foo[10], [:foo], [foo + 10]</pre>
          
          

          
          <div class="method-source-code" id="label_immediate-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 145</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">label_immediate?</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:immediate?</span>)
                <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">immediate?</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">label?</span>(<span class="ruby-identifier">arg</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">to_label</span>(<span class="ruby-keyword">self</span>).<span class="ruby-identifier">immediate?</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-label_import" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">label_import</span><span
            class="method-args">(program, name = nil, labels:true, macros:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Imports labels from another <code>program</code> class. Optionally imports macros.</p>

<p>A sugar for:</p>

<pre class="ruby"><span class="ruby-identifier">import</span> <span class="ruby-identifier">program</span>, <span class="ruby-value">code:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">labels:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">macros:</span> <span class="ruby-keyword">false</span>
</pre>

<p>See: <a href="Program.html#method-i-import"><code>Program.import</code></a>.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:labels</code>
<dd>
<p><code>true/false</code> or an absolute address (default: <code>true</code>).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:macros</code>
<dd>
<p><code>true/false</code> (default: <code>false</code>).</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="label_import-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 505</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">label_import</span>(<span class="ruby-identifier">program</span>, <span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-value">labels:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">macros:</span><span class="ruby-keyword">false</span>)
        <span class="ruby-identifier">import</span> <span class="ruby-identifier">program</span>, <span class="ruby-identifier">name</span>, <span class="ruby-value">code:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">labels:</span> <span class="ruby-identifier">labels</span>, <span class="ruby-value">macros:</span> <span class="ruby-identifier">macros</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-macro_import" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">macro_import</span><span
            class="method-args">(program)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Imports macros from another <code>program</code> class.</p>

<p>A sugar for:</p>

<pre class="ruby"><span class="ruby-identifier">import</span> <span class="ruby-identifier">program</span>, <span class="ruby-value">code:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">macros:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">labels:</span> <span class="ruby-keyword">false</span>
</pre>

<p>See: <a href="Program.html#method-i-import"><code>Program.import</code></a>.</p>
          
          

          
          <div class="method-source-code" id="macro_import-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 490</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">macro_import</span>(<span class="ruby-identifier">program</span>)
        <span class="ruby-identifier">import</span> <span class="ruby-identifier">program</span>, <span class="ruby-value">code:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">macros:</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">labels:</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-method_missing" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">method_missing</span><span
            class="method-args">(m, label = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>If no singleton method <code>m</code> is defined, assume <code>m</code> is a label name to define. Returns a named label.</p>

<p>A <code>label</code>, if provided, may be an integer, an instance of an unnamed label, or a lazy evaluated expression. If <code>label</code> has already some other name an error will be raised.</p>

<p>If <code>label</code> argument is missing the “dummy” label is being created instead. See <a href="Label.html"><code>Label</code></a> and <a href="Label.html#method-i-dummy-3F"><code>Label.dummy?</code></a>.</p>

<p>To create a label with the name of the existing singleton method or a ruby keyword, see: <a href="Program.html#method-i-define_label"><code>define_label</code></a></p>

<p>Example:.</p>

<pre class="ruby"><span class="ruby-identifier">mylabel</span> <span class="ruby-value">0x0123</span>
<span class="ruby-identifier">mylabel</span> <span class="ruby-identifier">addr</span> <span class="ruby-value">0x0123</span>, <span class="ruby-value">2</span>
</pre>

<p>This example gives a name “mylabel” to a label produced by an <code>ld</code> instruction and later references it:</p>

<pre class="ruby"><span class="ruby-identifier">mylabel</span> <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
        <span class="ruby-identifier">inc</span> <span class="ruby-identifier">hl</span>
        <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">mylabel</span>
</pre>

<p>This example creates a dummy label “skipret” and assings a value to it later:</p>

<pre class="ruby">        <span class="ruby-identifier">jp</span>  <span class="ruby-constant">Z</span>, <span class="ruby-identifier">skipret</span>
        <span class="ruby-identifier">ret</span>
<span class="ruby-identifier">skipret</span> <span class="ruby-identifier">label</span>
</pre>
          
          

          
          <div class="method-source-code" id="method_missing-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 475</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">method_missing</span>(<span class="ruby-identifier">m</span>, <span class="ruby-identifier">label</span> = <span class="ruby-keyword">nil</span>)
        <span class="ruby-identifier">define_label</span>(<span class="ruby-identifier">m</span>, <span class="ruby-identifier">label</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(start = 0x0000, *args, override:{})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Compiles a <strong>program</strong> at the <code>start</code> address passing *args to initialize(). Returns a compiled instance of a <strong>program</strong>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:override</code>
<dd>
<p>A flat hash containing names of labels with addresses to be overwritten.</p>
</dd></dl>
</li></ul>
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 188</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new</span>(<span class="ruby-identifier">start</span> = <span class="ruby-value">0x0000</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-value">override:</span>{})
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;override should be a map of override names to labels&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">override</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_h</span>)
        <span class="ruby-identifier">override</span> = <span class="ruby-constant">Alloc</span>.<span class="ruby-identifier">compile</span>(<span class="ruby-identifier">override</span>, <span class="ruby-value">0</span>, <span class="ruby-value">include_sizes:</span><span class="ruby-keyword">false</span>)

        <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@dummies</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">any?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">_</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">dummy?</span>}
                <span class="ruby-identifier">dummies</span> = <span class="ruby-ivar">@dummies</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">1</span>]} <span class="ruby-operator">+</span> <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">_</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">dummy?</span>}.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">1</span>]}
                <span class="ruby-identifier">dummies</span>.<span class="ruby-identifier">reject!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">override</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">n</span>) }
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dummies</span>.<span class="ruby-identifier">empty?</span>
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Labels referenced but not defined in #{self}: #{dummies.inspect}&quot;</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">prog</span> = <span class="ruby-keyword">super</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
        <span class="ruby-identifier">code</span> = <span class="ruby-ivar">@code</span>.<span class="ruby-identifier">dup</span>

        <span class="ruby-identifier">imports</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-ivar">@imports</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">addr</span>, <span class="ruby-identifier">size</span>, <span class="ruby-identifier">program</span>, <span class="ruby-identifier">code_addr</span>, <span class="ruby-identifier">arguments</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">import_override</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">merged_override</span> = <span class="ruby-constant">Alloc</span>.<span class="ruby-identifier">compile</span>(<span class="ruby-identifier">import_override</span>, <span class="ruby-identifier">start</span>, <span class="ruby-identifier">override</span>, <span class="ruby-value">include_sizes:</span><span class="ruby-keyword">false</span>)
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">nil?</span>
                        <span class="ruby-identifier">merged_override</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">override</span>)
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">prefix</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;.&#39;</span>.<span class="ruby-identifier">freeze</span>
                        <span class="ruby-identifier">merged_override</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">override</span>.
                                <span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">start_with?</span>(<span class="ruby-identifier">prefix</span>) }.
                                <span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">k</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-identifier">prefix</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">..</span>), <span class="ruby-identifier">v</span>] }.
                                <span class="ruby-identifier">to_h</span>)
                <span class="ruby-keyword">end</span>

                <span class="ruby-identifier">code_addr</span> = <span class="ruby-identifier">addr</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">start</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">code_addr</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">program</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">code_addr</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">arguments</span>, <span class="ruby-value">override:</span><span class="ruby-identifier">merged_override</span>)
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Imported program #{program} has been modified.&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">size</span>
                <span class="ruby-identifier">code</span>[<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">size</span>] = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">code</span>
                [<span class="ruby-identifier">name</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">addr</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">start</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">ip</span>]
        <span class="ruby-keyword">end</span>]

        <span class="ruby-identifier">labels</span> = <span class="ruby-constant">Alloc</span>.<span class="ruby-identifier">compile</span>(<span class="ruby-ivar">@labels</span>, <span class="ruby-identifier">start</span>, <span class="ruby-identifier">override</span>)

        <span class="ruby-identifier">reloc</span> = <span class="ruby-ivar">@reloc</span>.<span class="ruby-identifier">dup</span>
        <span class="ruby-identifier">debug</span> = <span class="ruby-ivar">@debug</span>.<span class="ruby-identifier">dup</span>
        <span class="ruby-ivar">@conditional_blocks</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cndblk</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-string">&quot;Invalid conditional block program&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cndblk</span>.<span class="ruby-identifier">program</span>.<span class="ruby-identifier">equal?</span>(<span class="ruby-keyword">self</span>)
                <span class="ruby-constant">ConditionalBlock</span>.<span class="ruby-identifier">compile</span>(<span class="ruby-identifier">cndblk</span>, <span class="ruby-identifier">code</span>, <span class="ruby-identifier">reloc</span>, <span class="ruby-identifier">debug</span>, <span class="ruby-identifier">start</span>, <span class="ruby-identifier">override</span>)
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">reloc</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">size</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">0</span>
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-string">&quot;Absolute labels need relocation sizes for the overrides&quot;</span>
                        <span class="ruby-comment"># OBSOLETE: ignore, this is an absolute address but we need relocation info for debug</span>
                <span class="ruby-keyword">when</span> <span class="ruby-value">1</span>
                        <span class="ruby-identifier">addr</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">from</span>
                        <span class="ruby-keyword">when</span> <span class="ruby-constant">Integer</span>
                                <span class="ruby-identifier">r</span>.<span class="ruby-identifier">from</span>
                        <span class="ruby-keyword">when</span> <span class="ruby-value">:jr</span>, <span class="ruby-keyword">nil</span>
                                <span class="ruby-identifier">r</span>.<span class="ruby-identifier">addr</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">start</span>
                        <span class="ruby-keyword">when</span> <span class="ruby-value">:pc</span>
                                <span class="ruby-identifier">r</span>.<span class="ruby-identifier">addr</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">start</span>
                        <span class="ruby-keyword">when</span> <span class="ruby-value">:self</span>
                                <span class="ruby-value">:self</span>
                        <span class="ruby-keyword">else</span>
                                <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Unknown from relocation parameter: #{r.inspect}&quot;</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">i</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">alloc</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-identifier">start</span>, <span class="ruby-identifier">addr</span>, <span class="ruby-value">override:</span><span class="ruby-identifier">override</span>)
                        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">r</span>.<span class="ruby-identifier">from</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">from</span> <span class="ruby-operator">==</span> <span class="ruby-value">:jr</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>(<span class="ruby-value">-128</span><span class="ruby-operator">..</span><span class="ruby-value">127</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>)
                                <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Relative relocation out of range at 0x#{&#39;%04x&#39; % r.addr} -&gt; #{i} #{r.inspect}&quot;</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">from</span> <span class="ruby-operator">==</span> <span class="ruby-value">:pc</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">255</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>)
                                <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Jump table relocation out of range at 0x#{&#39;%04x&#39; % r.addr} -&gt; #{i} #{r.inspect}&quot;</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">code</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">addr</span>] = [<span class="ruby-identifier">i</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&#39;c&#39;</span>)
                <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>
                        <span class="ruby-identifier">code</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">addr</span>, <span class="ruby-value">2</span>] = [<span class="ruby-identifier">r</span>.<span class="ruby-identifier">alloc</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-identifier">start</span>, <span class="ruby-value">override:</span><span class="ruby-identifier">override</span>)].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&#39;S&lt;&#39;</span>)
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">code</span>[<span class="ruby-identifier">r</span>.<span class="ruby-identifier">addr</span>, <span class="ruby-identifier">r</span>.<span class="ruby-identifier">size</span>] = [<span class="ruby-identifier">r</span>.<span class="ruby-identifier">alloc</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-identifier">start</span>, <span class="ruby-value">override:</span><span class="ruby-identifier">override</span>)].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&#39;Q&lt;&#39;</span>)[<span class="ruby-value">0</span>, <span class="ruby-identifier">r</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">ljust</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">size</span>, <span class="ruby-string">&quot;\0&quot;</span>)
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        [<span class="ruby-string">&#39;@code&#39;</span>, <span class="ruby-identifier">code</span>,
         <span class="ruby-string">&#39;@org&#39;</span>, <span class="ruby-identifier">start</span>,
         <span class="ruby-string">&#39;@debug&#39;</span>, <span class="ruby-keyword">nil</span>,
         <span class="ruby-string">&#39;@labels&#39;</span>, <span class="ruby-identifier">labels</span>,
         <span class="ruby-string">&#39;@imports&#39;</span>, <span class="ruby-identifier">imports</span>,
         <span class="ruby-string">&#39;@reloc_info&#39;</span>, <span class="ruby-identifier">reloc</span>,
         <span class="ruby-string">&#39;@debug_info&#39;</span>, <span class="ruby-identifier">debug</span>
        ].<span class="ruby-identifier">each_slice</span>(<span class="ruby-value">2</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">prog</span>.<span class="ruby-identifier">instance_variable_set</span> <span class="ruby-identifier">n</span>,<span class="ruby-identifier">v</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">prog</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ns" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            ns **opts {|eoc| ... }
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            ns name, **opts {|eoc| ... }
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns a relative label, as a namespace, holding labels defined by the code created with <code>block</code> as sub-labels. Appends the created code to the <a href="Program.html#attribute-i-code"><code>Program.code</code></a>.</p>

<p>This function requires a block which may generate <a href="../Z80.html"><code>Z80</code></a> code containing labels or possibly other namespaces (namespaces can be nested). Every label defined within this block will become a member of the created namespace.</p>

<p>An optional <code>name</code> may be provided, as a string or a symbol. In this instance the returned label will already have a name. Otherwise an unnamed label is being returned.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:use</code>
<dd>
<p>If <code>true</code> namespace can inherit absolute labels from parent namespaces; if a name, label or an Array of names is given - only specified labels are being inherited; <code>false</code> by default.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:inherit</code>
<dd>
<p>An alias of <code>:inherit</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:isolate</code>
<dd>
<p>If <code>true</code> creates an isolated namespace; see: <a href="Program.html#method-i-isolate"><code>Program#isolate</code></a>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:merge</code>
<dd>
<p>If <code>true</code> merges labels from within a namespace with the current context; usefull if you want to pass an <code>eoc</code> label to some block of code and don&#39;t need a namespace.</p>
</dd></dl>
</li></ul>

<p>Given <code>block</code> receives one argument: <code>eoc</code> which is a relative label that will address the end of the namespaced code and may be referenced from within the <code>block</code>.</p>

<p>Labels created within the <code>block</code> has higher priority than labels with the same name created outside of it, when referenced from within the <code>block</code>.</p>

<p>All labels created outside of the namespace scope and not indicated with <code>:use</code> can only be referenced lazily. If you really need to gain an immediate access to absolute labels (e.g. coerce its address or size to an integer), provide <code>:use</code> option with their names or <code>true</code> for all absolute labels.</p>

<p>If <code>:isolate</code> option is <code>true</code> no label created outside of the <code>block</code> can be referenced unless explicitly indicated with <code>:use</code>.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">ns</span> <span class="ruby-value">:foo</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">loop1</span>  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>
         <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
         <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loop1</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Returns a label that points to the beginning of the <code>block</code> of code and its size is equal to the created code size.</p>
          
          

          
          <div class="method-source-code" id="ns-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 367</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ns</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;no block given to ns&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">block_given?</span>
        <span class="ruby-comment"># Save parent labels</span>
        <span class="ruby-identifier">labels</span> = <span class="ruby-ivar">@labels</span>
        <span class="ruby-ivar">@labels</span> = <span class="ruby-identifier">labels</span>.<span class="ruby-identifier">dup</span>
        <span class="ruby-comment"># Normalize inherit option</span>
        <span class="ruby-identifier">inherit</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:inherit</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:inherit_absolute</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:inherit_labels</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:use</span>]
        <span class="ruby-identifier">inherit</span> = [<span class="ruby-identifier">inherit</span>] <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">inherit</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">&amp;&amp;</span>
                                                        (<span class="ruby-identifier">inherit</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Symbol</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">inherit</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">label?</span>(<span class="ruby-identifier">inherit</span>))
        <span class="ruby-comment"># Looks for labels in every context</span>
        <span class="ruby-identifier">find_1st_defined_label_in_contexts</span> = <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">ct</span> = <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">reverse_each</span>.<span class="ruby-identifier">find</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ct</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">l</span> = <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>]
                        <span class="ruby-identifier">l</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">l</span>.<span class="ruby-identifier">dummy?</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ct</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ct</span>[<span class="ruby-identifier">name</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Handle inherit option</span>
        <span class="ruby-ivar">@contexts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">inherit</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
                <span class="ruby-identifier">inherit</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">name</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_name</span>)
                                <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_name</span>
                        <span class="ruby-keyword">else</span>
                                <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">labl</span> = <span class="ruby-identifier">labels</span>[<span class="ruby-identifier">name</span>]
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">labl</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">labl</span>.<span class="ruby-identifier">dummy?</span>
                                <span class="ruby-identifier">labl</span> = <span class="ruby-identifier">find_1st_defined_label_in_contexts</span>[<span class="ruby-identifier">name</span>]
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Label: `#{name}&#39; not found&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">labl</span>.<span class="ruby-identifier">nil?</span>
                        [<span class="ruby-identifier">name</span>, <span class="ruby-identifier">labl</span>]
                <span class="ruby-keyword">end</span>.<span class="ruby-identifier">to_h</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">inherit</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
                <span class="ruby-identifier">labels</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>,<span class="ruby-identifier">label</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">dummy?</span>
                                <span class="ruby-identifier">label</span> = <span class="ruby-identifier">find_1st_defined_label_in_contexts</span>[<span class="ruby-identifier">name</span>]
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">label</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">immediate?</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">inherit</span>
                {}
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;ns :inherit option must be a boolean, name or array of names&quot;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Prepare top and eoc labels</span>
        <span class="ruby-identifier">addr</span> = <span class="ruby-identifier">pc</span>
        <span class="ruby-identifier">top</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">dummy</span>
        <span class="ruby-identifier">eoc</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">dummy</span> <span class="ruby-string">&#39;EOC&#39;</span>
        <span class="ruby-comment"># Prepare debug info for a namespace</span>
        <span class="ruby-identifier">begin_reloc_index</span> = <span class="ruby-ivar">@reloc</span>.<span class="ruby-identifier">length</span>
        <span class="ruby-identifier">begin_debug</span> = <span class="ruby-constant">DebugInfo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-value">0</span>, <span class="ruby-string">&#39;--- begin ---&#39;</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-ivar">@context_labels</span>.<span class="ruby-identifier">dup</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">top</span>)
        <span class="ruby-ivar">@debug</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">begin_debug</span>
        <span class="ruby-ivar">@context_labels</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">top</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:merge</span>]
        <span class="ruby-comment"># Execute block</span>
        <span class="ruby-keyword">yield</span> <span class="ruby-identifier">eoc</span>
        <span class="ruby-comment"># Check if eoc was used and modify debug info accordingly</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@reloc</span>[<span class="ruby-identifier">begin_reloc_index</span><span class="ruby-operator">...</span><span class="ruby-ivar">@reloc</span>.<span class="ruby-identifier">length</span>].<span class="ruby-identifier">any?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-constant">Alloc</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">r</span>.<span class="ruby-identifier">alloc</span>, <span class="ruby-identifier">eoc</span>) }
                <span class="ruby-ivar">@debug</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DebugInfo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pc</span>, <span class="ruby-value">0</span>, <span class="ruby-string">&#39;---  end  ---&#39;</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-ivar">@context_labels</span>.<span class="ruby-identifier">dup</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">eoc</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">begin_debug</span>.<span class="ruby-identifier">text</span> = <span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Finally define eoc label</span>
        <span class="ruby-identifier">eoc</span>.<span class="ruby-identifier">reinitialize</span>(<span class="ruby-identifier">pc</span>, <span class="ruby-value">1</span>, <span class="ruby-value">:code</span>)
        <span class="ruby-comment"># Restore parent labels</span>
        <span class="ruby-ivar">@labels</span> = <span class="ruby-identifier">labels</span>
        <span class="ruby-comment"># Get our context&#39;s id</span>
        <span class="ruby-identifier">context_id</span> = <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">object_id</span>
        <span class="ruby-comment"># Partition labels created in this context</span>
        <span class="ruby-identifier">members</span>, <span class="ruby-identifier">dummies</span> = <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">pop</span>.<span class="ruby-identifier">partition</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">l</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">l</span>.<span class="ruby-identifier">dummy?</span>
                        <span class="ruby-keyword">false</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-keyword">true</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Handle dummies left by inner namespaces</span>
        <span class="ruby-ivar">@dummies</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">label</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">cts</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">cts</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">context_id</span>) <span class="ruby-keyword">and</span> <span class="ruby-ivar">@labels</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@labels</span>[<span class="ruby-identifier">name</span>].<span class="ruby-identifier">dummy?</span>
                        <span class="ruby-identifier">label</span>.<span class="ruby-identifier">reinitialize</span> <span class="ruby-ivar">@labels</span>[<span class="ruby-identifier">name</span>]
                        <span class="ruby-keyword">true</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-keyword">false</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Prepare contexts array for dummies</span>
        <span class="ruby-identifier">contexts</span> = <span class="ruby-ivar">@contexts</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:object_id</span>)
        <span class="ruby-comment"># Handle isolate option</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:isolate</span>]
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dummies</span>.<span class="ruby-identifier">empty?</span>
                        <span class="ruby-identifier">dummies</span> = <span class="ruby-identifier">dummies</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">1</span>]}
                        <span class="ruby-identifier">raise</span> <span class="ruby-constant">CompileError</span>, <span class="ruby-node">&quot;Undefined labels referenced in isolated namespace: #{dummies.inspect}&quot;</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-ivar">@dummies</span><span class="ruby-operator">+=</span> <span class="ruby-identifier">dummies</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">label</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@labels</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@labels</span>[<span class="ruby-identifier">name</span>].<span class="ruby-identifier">dummy?</span>
                                <span class="ruby-identifier">label</span>.<span class="ruby-identifier">reinitialize</span> <span class="ruby-ivar">@labels</span>[<span class="ruby-identifier">name</span>]
                                <span class="ruby-keyword">nil</span>
                        <span class="ruby-keyword">else</span>
                                [<span class="ruby-identifier">name</span>, <span class="ruby-identifier">label</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">contexts</span>
                        <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>.<span class="ruby-identifier">compact</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Remove our context from debug info</span>
        <span class="ruby-ivar">@context_labels</span>.<span class="ruby-identifier">pop</span>
        <span class="ruby-comment"># Handle merge option</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:merge</span>]
                <span class="ruby-identifier">members</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">l</span><span class="ruby-operator">|</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">l</span>) }
                <span class="ruby-identifier">top</span>.<span class="ruby-identifier">reinitialize</span> <span class="ruby-identifier">addr</span>, <span class="ruby-identifier">pc</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">addr</span>, <span class="ruby-value">:code</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">top</span>.<span class="ruby-identifier">reinitialize</span> <span class="ruby-identifier">addr</span>, <span class="ruby-identifier">pc</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">addr</span>, <span class="ruby-value">:code</span>, <span class="ruby-constant">Hash</span>[<span class="ruby-identifier">members</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Optionally give name to top label</span>
        <span class="ruby-identifier">top</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">top</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>
        <span class="ruby-identifier">top</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-org" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">org</span><span
            class="method-args">(address = pc, pad = 0, align: 1, offset: 0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns an unnamed, relative label that points to the beginning of padded space. The space is being padded with <code>pad</code> byte. The <code>address</code> should be relative to the beginning of the <a href="Program.html#attribute-i-code"><code>Program.code</code></a> and must be equal to or greater than <a href="Program.html#method-i-pc"><code>Program.pc</code></a>.</p>
<dl class="rdoc-list note-list"><dt><strong>Note</strong>
<dd>
<p>Do not confuse it with assembler directive ORG which sets absolute address of a program. Only instances of <a href="Program.html"><code>Z80::Program</code></a> have absolute addresses.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:align</code>
<dd>
<p>Additionally aligns the <code>address</code> to the nearest multiple of <code>:align</code> bytes (relative to the beginning of code).</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:offset</code>
<dd>
<p>Added to the <code>address</code> after alignment.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="org-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 296</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">org</span>(<span class="ruby-identifier">address</span> = <span class="ruby-identifier">pc</span>, <span class="ruby-identifier">pad</span> = <span class="ruby-value">0</span>, <span class="ruby-value">align:</span> <span class="ruby-value">1</span>, <span class="ruby-value">offset:</span> <span class="ruby-value">0</span>)
        <span class="ruby-identifier">address</span> = <span class="ruby-identifier">address</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">align</span> = <span class="ruby-identifier">align</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;align must be &gt;= 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">address</span> = (<span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">offset</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-node">&quot;The current code pointer: #{pc.to_s 16} is exceeding: #{address.to_i.to_s 16} &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pc</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">address</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-node">&quot;The current code pointer is exceeding 64k address range: #{address.to_i.to_s 16} &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0x10000</span>
        <span class="ruby-constant">Z80</span><span class="ruby-operator">::</span><span class="ruby-identifier">add_code</span> <span class="ruby-keyword">self</span>, [<span class="ruby-identifier">pad</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&#39;c&#39;</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">address</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">pc</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pc" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pc</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the current byte offset from the beginning of the <a href="Program.html#attribute-i-code"><code>Program.code</code></a> (a program counter relative to 0). To create a label at <code>pc</code> use <a href="Program.html#method-i-label"><code>Program.label</code></a> instead.</p>
          
          

          
          <div class="method-source-code" id="pc-source">
            <pre><span class="ruby-comment"># File lib/z80.rb, line 278</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pc</span>
        <span class="ruby-ivar">@code</span>.<span class="ruby-identifier">bytesize</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pointer-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pointer?</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A convenient method for macros to check if argument is pointer-like.</p>

<p>Returns <code>true</code> for:</p>

<pre>[foo], [:foo], [foo + 10], [foo[10]], foo[], foo[10][], [0x1234], [hl], [ix + 6], ix[7]</pre>
          
          

          
          <div class="method-source-code" id="pointer-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 119</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pointer?</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
                <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:pointer?</span>)
                <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">pointer?</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">label?</span>(<span class="ruby-identifier">arg</span>)
                <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">to_label</span>(<span class="ruby-keyword">self</span>).<span class="ruby-identifier">pointer?</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-register-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">register?</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A convenient method for macros to check if argument is a <a href="Program/Register.html"><code>Register</code></a>.</p>

<p>Returns <code>true</code> for:</p>

<pre>hl, a, [hl], [iy + 6]</pre>
          
          

          
          <div class="method-source-code" id="register-3F-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 101</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">register?</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
        <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Register</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-select" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">select</span><span
            class="method-args">(*args, &amp;test)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a conditional block that creates alternative code based on the lazy evaluated boolean condition.</p>

<p>Returns an instance of <a href="ConditionalBlock.html"><code>ConditionalBlock</code></a>.</p>

<p>Each argument should be a label or a label expression. Provide a block of code that computes a boolean value based on the evaluated label expressions.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Currently code produced by each variant must have the same number of bytes. Labels defined inside a variant are not accessible from outside of the conditional block.</p>
</dd></dl>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">select</span>((<span class="ruby-identifier">io</span>.<span class="ruby-identifier">ay_out</span> <span class="ruby-operator">^</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">ay_sel</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF00</span>, <span class="ruby-operator">&amp;</span><span class="ruby-value">:zero?</span>).<span class="ruby-identifier">then</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">io</span>.<span class="ruby-identifier">ay_out</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>
<span class="ruby-keyword">end</span>.<span class="ruby-identifier">else_select</span>((<span class="ruby-identifier">io</span>.<span class="ruby-identifier">ay_out</span> <span class="ruby-operator">^</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">ay_sel</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x00FF</span>, <span class="ruby-operator">&amp;</span><span class="ruby-value">:zero?</span>).<span class="ruby-identifier">then</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">io</span>.<span class="ruby-identifier">ay_out</span>
<span class="ruby-keyword">end</span>.<span class="ruby-identifier">else</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;ay_out and ay_sel should differ only on either 8-bit lsb or msb&quot;</span>
<span class="ruby-keyword">end</span>
</pre>
          
          

          
          <div class="method-source-code" id="select-source">
            <pre><span class="ruby-comment"># File lib/z80/select.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">test</span>)
  <span class="ruby-constant">ConditionalBlock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">test</span>).<span class="ruby-identifier">tap</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">cndblk</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@conditional_blocks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">cndblk</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-union" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">union</span><span
            class="method-args">(label, type, align: nil, offset: 0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns a new, unnamed label addressed by <code>label</code>, but of different <code>type</code>. <code>type</code> can be an integer or a data structure (a class derived from <a href="Label.html"><code>Label</code></a>). If <code>label</code> was relative the returned label will also be relative. If <code>label</code> was absolute the returned label will also be absolute.</p>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:align</code>
<dd>
<p>Additionally aligns the <code>label</code> to the nearest multiple of <code>:align</code> bytes applying a lazy evaluated expression to a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:offset</code>
<dd>
<p>Added to the <code>label</code> after alignment.</p>
</dd></dl>
</li></ul>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">foo</span> <span class="ruby-identifier">label</span>
<span class="ruby-identifier">bar</span> <span class="ruby-identifier">union</span> <span class="ruby-identifier">foo</span>, <span class="ruby-value">2</span>
</pre>
          
          

          
          <div class="method-source-code" id="union-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">union</span>(<span class="ruby-identifier">label</span>, <span class="ruby-identifier">type</span>, <span class="ruby-value">align:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">offset:</span> <span class="ruby-value">0</span>)
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_label</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">label</span>.<span class="ruby-identifier">sublabel?</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">label</span>.<span class="ruby-identifier">dummy?</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">type</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">Syntax</span>, <span class="ruby-string">&quot;Invalid union argument.&quot;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">lbl</span> = <span class="ruby-constant">Label</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">label</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">label</span>.<span class="ruby-identifier">immediate?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-value">:code</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span>
                <span class="ruby-identifier">align</span> = <span class="ruby-identifier">align</span>.<span class="ruby-identifier">to_i</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;align must be &gt;= 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
                <span class="ruby-identifier">lbl</span> = (<span class="ruby-identifier">lbl</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">align</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">align</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">lbl</span> = <span class="ruby-identifier">lbl</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">offset</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">offset</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">lbl</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-unwrap_pointer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">unwrap_pointer</span><span
            class="method-args">(arg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns a normalized pointer label, <a href="Program/Register.html"><code>Register</code></a> or an integer. Otherwise pass-through.</p>

<p>Convenient method for checking arguments in macros.</p>

<p>The following example arguments will be unwrapped as pointer labels:</p>

<pre>[0x1234], [foo], [:bar]</pre>

<p>The following example arguments will be unwrapped as pointer registers:</p>

<pre>[hl], [de], [ix]</pre>

<p>The following example arguments will pass unmodified:</p>

<pre>a, bc, :foo, bar</pre>
          
          

          
          <div class="method-source-code" id="unwrap_pointer-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unwrap_pointer</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
                <span class="ruby-keyword">self</span>.<span class="ruby-identifier">[]</span>(<span class="ruby-identifier">arg</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">arg</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-words" class="method-detail ">
        
        
        <div class="method-heading">
          <span class="method-callseq">
            words count
          </span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            words count, word_integer, ...
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            words count, [word_integer, ...]
          </span>
          
        </div>
        
        <div class="method-heading">
          <span class="method-callseq">
            words [word_integer, ...]
          </span>
          
        </div>
        
        

        <div class="method-description">
          
          <p>Returns an unnamed label and allocates <code>count</code> words with <a href="Program.html#method-i-data"><code>Program.data</code></a>. Optionally you can provide values for the allocated words.</p>

<p>See: <a href="Program.html#method-i-data"><code>Program.data</code></a>.</p>
          
          

          
          <div class="method-source-code" id="words-source">
            <pre><span class="ruby-comment"># File lib/z80/labels.rb, line 388</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">words</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>); <span class="ruby-identifier">data</span>(<span class="ruby-value">2</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>); <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

