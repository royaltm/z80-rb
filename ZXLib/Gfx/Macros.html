<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module ZXLib::Gfx::Macros - ruby-Z80</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-clear_attrs_region_fast">#clear_attrs_region_fast</a>
    
    <li ><a href="#method-i-clear_screen_region_fast">#clear_screen_region_fast</a>
    
    <li ><a href="#method-i-copy_shadow_attrs_region">#copy_shadow_attrs_region</a>
    
    <li ><a href="#method-i-copy_shadow_attrs_region_quick">#copy_shadow_attrs_region_quick</a>
    
    <li ><a href="#method-i-copy_shadow_screen_region">#copy_shadow_screen_region</a>
    
    <li ><a href="#method-i-copy_shadow_screen_region_quick">#copy_shadow_screen_region_quick</a>
    
    <li ><a href="#method-i-nextline">#nextline</a>
    
    <li ><a href="#method-i-nextpixel">#nextpixel</a>
    
    <li ><a href="#method-i-nextrow">#nextrow</a>
    
    <li ><a href="#method-i-only_one_bit_set_or_zero-3F">#only_one_bit_set_or_zero?</a>
    
    <li ><a href="#method-i-prevline">#prevline</a>
    
    <li ><a href="#method-i-prevpixel">#prevpixel</a>
    
    <li ><a href="#method-i-rctoattr">#rctoattr</a>
    
    <li ><a href="#method-i-rctoscr">#rctoscr</a>
    
    <li ><a href="#method-i-scrtoattr">#scrtoattr</a>
    
    <li ><a href="#method-i-xy_to_attr_addr">#xy_to_attr_addr</a>
    
    <li ><a href="#method-i-xy_to_pixel_addr">#xy_to_pixel_addr</a>
    
    <li ><a href="#method-i-xytoscr">#xytoscr</a>
    
    <li ><a href="#method-i-ytoattr">#ytoattr</a>
    
    <li ><a href="#method-i-ytoscr">#ytoscr</a>
    
    <li ><a href="#method-i-yxtoscr">#yxtoscr</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-ZXLib::Gfx::Macros">
  <h1 id="module-ZXLib::Gfx::Macros" class="module">
    module ZXLib::Gfx::Macros
  </h1>

  <section class="description">
    
<h2 id="module-ZXLib::Gfx::Macros-label-ZXLib-3A-3AGfx+macros."><a href="../Gfx.html"><code>ZXLib::Gfx</code></a> macros.<span><a href="#module-ZXLib::Gfx::Macros-label-ZXLib-3A-3AGfx+macros.">&para;</a> <a href="#top">&uarr;</a></span></h2>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-clear_attrs_region_fast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_attrs_region_fast</span><span
            class="method-args">(address=hl, rows=a, cols=2, value=0, disable_intr:true, enable_intr:true, save_sp:true, addr_mode: :optimal, unroll_rows:false, scraddr:nil, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that clears a rectangle on screen attributes using unrolled PUSH instructions.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Interrupts must be disabled prior to calling this routine or the <code>disable_intr</code> option must be set to <code>true</code>.</p>
</dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt><code>address</code>
<dd>
<p>An addres of a memory area to be cleared as a label, pointer, an integer or <code>hl</code>. The interpretation of the given address depends on the <code>addr_mode</code> option. The starting address of the whole screen area must be a multiple of 0x2000.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rows</code>
<dd>
<p>A number of attribute rows to be cleared as an 8-bit register or a label or a pointer or an integer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of attribute columns to be cleared as an integer: 1 to 32.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>value</code>
<dd>
<p>A pattern of 2 attributes (packed as 16-bit integer) to fill each line with as a label, pointer, an integer or <code>de</code>. For the odd number of columns the first and the last column will be the pattern&#39;s least significant byte.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>disable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should disable interrupts. Provide <code>false</code> only if you have already disabled the interrupts.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>enable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should enable interrupts. Provide <code>false</code> if you need to perform more uninterrupted actions.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>save_sp</code>
<dd>
<p>A boolean flag indicating that the <code>sp</code> register should be saved and restored. Otherwise <code>sp</code> will point to the beginning of the last cleared line.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>addr_mode</code>
<dd>
<p>Determines the interpretation of the given <code>address</code>. See below.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>unroll_rows</code>
<dd>
<p>Creates unrolled code for columns and rows. In this instance <code>rows</code> must be a constant.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional screen memory address which must be a multiple of 0x2000 as an integer or a label. If provided the routine breaks execution when the bottom of the attributes has been reached.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>Whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p><code>addr_mode</code> should be one of:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:optimal</code>
<dd>
<p>For the odd number of <code>cols</code> the <code>address</code> should be the same as in the <code>:last</code> mode. For the even number of <code>cols</code> the <code>address</code> should be the same as in the <code>:end</code> mode.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:first</code>
<dd>
<p>The <code>address</code> should point to the first column of the topmost row of the area to be cleared.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:last</code>
<dd>
<p>The <code>address</code> should point to the last column of the topmost row of the area to be cleared.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:end</code>
<dd>
<p>The <code>address</code> should point to the next byte after the last column of the topmost row of the area to be cleared.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Restoring <code>sp</code> register uses self-modifying code.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code>, optionally: <code>sp</code>. <code>af&#39;</code> is used only when <code>scraddr</code> is defined and <code>unroll_rows</code> is <code>false</code>.</p>
          
          

          
          <div class="method-source-code" id="clear_attrs_region_fast-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 838</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_attrs_region_fast</span>(<span class="ruby-identifier">address</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">rows</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">2</span>, <span class="ruby-identifier">value</span>=<span class="ruby-value">0</span>, <span class="ruby-value">disable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">enable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">save_sp:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">addr_mode:</span> <span class="ruby-value">:optimal</span>, <span class="ruby-value">unroll_rows:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;address should be an address or a pointer or hl&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">address</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rows should be an integer or a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">rows</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span>
                                                                                                 <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">rows</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rows must be a positive non-zero integer to unroll code&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">unroll_rows</span> <span class="ruby-keyword">and</span>
                                                                          (<span class="ruby-operator">!</span><span class="ruby-identifier">rows</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>)
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;value should be an integer or a label or a pointer or de&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">value</span>)
  <span class="ruby-keyword">unless</span> [<span class="ruby-value">:optimal</span>, <span class="ruby-value">:first</span>, <span class="ruby-value">:last</span>, <span class="ruby-value">:end</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">addr_mode</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;addr_mode should be either :optimal, :first, :last or :end&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">save_sp</span> = <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">addr_mode</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:first</span>
      <span class="ruby-identifier">address</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
        <span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cols</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:last</span>
      <span class="ruby-identifier">address</span> = <span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">even?</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:end</span>
      <span class="ruby-identifier">address</span> = <span class="ruby-identifier">address</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:first</span>
    <span class="ruby-identifier">ts_cost</span> = <span class="ruby-value">7</span><span class="ruby-value">+4</span><span class="ruby-value">+4</span>
    <span class="ruby-identifier">ts_cost</span> = <span class="ruby-identifier">ts_cost</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">unroll_rows</span>
    <span class="ruby-identifier">ts_cost</span> = <span class="ruby-identifier">ts_cost</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">rows</span>)
    <span class="ruby-identifier">max_cols_adj_unroll</span> = <span class="ruby-identifier">ts_cost</span> <span class="ruby-operator">/</span> <span class="ruby-value">4</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">clear_line</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">is_last</span> = <span class="ruby-keyword">false</span><span class="ruby-operator">|</span>
                  <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                  (<span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span> }
                  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bc</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_last</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">unroll_rows</span>
                  <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, ((<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x1B</span>)<span class="ruby-value">-1</span>
                  <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">unroll_rows</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">!=</span> <span class="ruby-value">:first</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_cols_adj_unroll</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">rows</span>)
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>      <span class="ruby-comment"># ts:4</span>
      <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">c</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">address</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:first</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">max_cols_adj_unroll</span>
                  (<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span> }
        <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span><span class="ruby-value">-1</span> <span class="ruby-comment"># ts:7</span>
                  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">l</span>         <span class="ruby-comment"># ts:4</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>      <span class="ruby-comment"># ts:4</span>
          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">unroll_rows</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>      <span class="ruby-comment"># ts:4</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:optimal</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:end</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
        <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">even?</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">value</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">bc</span>, <span class="ruby-value">32</span>
                  <span class="ruby-identifier">di</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">disable_intr</span>
                  <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">restore_sp_p</span>], <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">unroll_rows</span>
                  <span class="ruby-identifier">clear_line</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, ((<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x1B</span>)<span class="ruby-value">-1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
      (<span class="ruby-identifier">rows</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                  <span class="ruby-identifier">cp</span>   <span class="ruby-identifier">h</span>      <span class="ruby-comment"># a: ((scraddr &gt;&gt; 8)|0x1B)-1</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
                  <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">rows_left</span> = <span class="ruby-identifier">rows</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">row</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
              <span class="ruby-identifier">ahead</span> = <span class="ruby-identifier">rows_left</span> <span class="ruby-operator">*</span> (((<span class="ruby-identifier">cols</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">ahead</span> = <span class="ruby-identifier">rows_left</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">ahead</span> = <span class="ruby-identifier">ahead</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">rows_left</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-operator">*</span> <span class="ruby-value">4</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">ahead</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">128</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">quit</span>
            <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">jp</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">quit</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">clear_line</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                  <span class="ruby-identifier">clear_line</span>.<span class="ruby-identifier">call</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
                  <span class="ruby-identifier">ret</span>  <span class="ruby-constant">Z</span>
        <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">quit</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">loop_line</span>   <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span> <span class="ruby-comment"># ((scraddr &gt;&gt; 8)|0x1B)-1</span>
                  <span class="ruby-identifier">cp</span>   <span class="ruby-identifier">h</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
                  <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
        <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">quit</span>
        <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
      <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">loop_line</span>   <span class="ruby-identifier">label</span>
      <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">clear_line</span>.<span class="ruby-identifier">call</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>
                  <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">loop_line</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">quit</span>          <span class="ruby-identifier">label</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
    <span class="ruby-identifier">restore_sp</span>    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-value">0</span>
    <span class="ruby-identifier">restore_sp_p</span>  <span class="ruby-identifier">as</span>   <span class="ruby-identifier">restore_sp</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_intr</span>
                  <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">save_sp</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-clear_screen_region_fast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_screen_region_fast</span><span
            class="method-args">(address=hl, lines=c, cols=2, value=0, disable_intr:true, enable_intr:true, save_sp:true, addr_mode: :compat, scraddr:nil, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that clears a rectangle on an ink/paper screen using unrolled PUSH instructions.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Interrupts must be disabled prior to calling this routine or the <code>disable_intr</code> option must be set to <code>true</code>.</p>
</dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt><code>address</code>
<dd>
<p>An addres of a memory area to be cleared as a label, pointer, an integer or <code>hl</code>. The interpretation of the given address depends on the <code>addr_mode</code> option. The starting address of the whole screen area must be a multiple of 0x2000.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be cleared as an 8-bit register or a label, pointer or an integer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of 8 pixel columns to be cleared as an integer: 1 to 32.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>value</code>
<dd>
<p>A pattern of 16 pixels to fill each line with as a label, pointer, an integer or <code>de</code>. For the odd number of columns the first and the last column will be the pattern&#39;s least significant byte.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>disable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should disable interrupts. Provide <code>false</code> only if you have already disabled the interrupts.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>enable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should enable interrupts. Provide <code>false</code> if you need to perform more uninterrupted actions.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>save_sp</code>
<dd>
<p>A boolean flag indicating that the <code>sp</code> register should be saved and restored. Otherwise <code>sp</code> will point to the beginning of the last cleared line.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>addr_mode</code>
<dd>
<p>Determines the interpretation of the given <code>address</code>. See below.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional screen memory address which must be a multiple of 0x2000 as an integer or a label. If provided the routine breaks execution when the bottom of the screen has been reached.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>Whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p><code>addr_mode</code> should be one of:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>:last</code>
<dd>
<p>The <code>address</code> should point to the last column of the topmost line of the area to be cleared. This is the fastest mode as the address needs to be adjusted in other modes.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:first</code>
<dd>
<p>The <code>address</code> should point to the first column of the topmost line of the area to be cleared.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>:compat</code>
<dd>
<p>The <code>address</code> should point to the next byte after the last column of the topmost line of the area to be cleared.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Restoring <code>sp</code> register uses self-modifying code.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code>, optionally: <code>sp</code>.</p>
          
          

          
          <div class="method-source-code" id="clear_screen_region_fast-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 658</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">clear_screen_region_fast</span>(<span class="ruby-identifier">address</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">2</span>, <span class="ruby-identifier">value</span>=<span class="ruby-value">0</span>, <span class="ruby-value">disable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">enable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">save_sp:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">addr_mode:</span> <span class="ruby-value">:compat</span>, <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;address should be an address or a pointer or hl&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">address</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lines should be an integer or a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span>
                                                                                                 <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;value should be an integer or a label or a pointer or de&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">value</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">addr_mode</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> [<span class="ruby-value">:compat</span>, <span class="ruby-value">:first</span>, <span class="ruby-value">:last</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">addr_mode</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;addr_mode should be either :compat, :first or :last&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">save_sp</span> = <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">fits_single_row</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">addr_mode</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:first</span>
      <span class="ruby-identifier">address</span> = <span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:last</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">address</span> = <span class="ruby-identifier">address</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">fits_single_row</span> = <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&lt;=</span> (<span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">const_addr_not_right_edge</span> = <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">address</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">31</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">31</span>

  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">c</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">value</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">const_addr_not_right_edge</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">fits_single_row</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">even?</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">address</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">address</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fits_single_row</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
      <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">address</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:first</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">4</span>
                  (<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">inc</span> <span class="ruby-identifier">l</span> }
        <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>
                  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">l</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">addr_mode</span> <span class="ruby-operator">!=</span> <span class="ruby-value">:last</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span>
      <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>       <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
                  <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                  <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">h</span>          <span class="ruby-comment"># (h &amp; 0b11111000) - h % 8</span>
                  <span class="ruby-identifier">add</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># 8 - h % 8</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter: 8 - h % 8</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># if (const_addr_not_right_edge or fits_single_row) and cols.even?</span>
    <span class="ruby-comment">#   hl: -&gt; last screen column + 1</span>
    <span class="ruby-comment"># else</span>
    <span class="ruby-comment">#   hl: -&gt; last screen column</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>)
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># a: lines</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
      <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines - 1 - counter</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">8</span>
        <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = dy</span>
          <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">8</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
                  <span class="ruby-identifier">di</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">disable_intr</span>
                  <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">restore_sp_p</span>], <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
    <span class="ruby-identifier">loop0</span>         <span class="ruby-identifier">label</span>
                  <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">const_addr_not_right_edge</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">fits_single_row</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
    <span class="ruby-identifier">loop1</span>         <span class="ruby-identifier">label</span>
                  <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                  <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
                  (<span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span> }
                  <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">loop1</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
                  <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
      <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">quit</span>
      <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">const_addr_not_right_edge</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
                  <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining lines</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                  <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">skip_adj</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_oos</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                  <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">c</span>          <span class="ruby-comment"># c: 8</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-identifier">skip_adj</span>    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: remaining lines</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># c: 8</span>
                  <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop0</span>
                  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>
                  <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                  <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>
                  <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">loop0</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
        <span class="ruby-identifier">check_oos</span> <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
                  <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">skip_adj</span>
                  <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">quit</span>        <span class="ruby-identifier">label</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
    <span class="ruby-identifier">restore_sp</span>    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-value">0</span>
    <span class="ruby-identifier">restore_sp_p</span>  <span class="ruby-identifier">as</span>   <span class="ruby-identifier">restore_sp</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                  <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_intr</span>
                  <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">enable_intr</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">save_sp</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">fits_single_row</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_shadow_attrs_region" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_shadow_attrs_region</span><span
            class="method-args">(address=de, rows=a, cols=c, tgtaddr:0x4000, srcaddr:0x6000, check_edge:true, break_oos:true, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies a rectangle of screen attributes from or to a shadow screen.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>address</code>
<dd>
<p>An address of a top-left corner of the attributes memory area to be copied to as a label, pointer, an integer or <code>de</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rows</code>
<dd>
<p>A number of attribute rows to be copied as an 8-bit register or a label or a pointer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of attribute columns to be copied as as an 8-bit register or a label or a pointer. If <code>cols</code> is <code>a</code> the <code>cols</code> is taken from <code>a&#39;</code>.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Unless <code>cols</code> is one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code> the routine uses self modifying code.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tgtaddr</code>
<dd>
<p>A target screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>srcaddr</code>
<dd>
<p>A source screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check_edge</code>
<dd>
<p>Ensures that the region does not transgress the right edge of the screen decreasing <code>address</code> if necessary. Applies only if <code>address</code> is not static.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>break_oos</code>
<dd>
<p>Breaks execution when the bottom of the screen has been reached.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>Whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code>. Swaps registers unless out of screen.</p>
          
          

          
          <div class="method-source-code" id="copy_shadow_attrs_region-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 1154</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy_shadow_attrs_region</span>(<span class="ruby-identifier">address</span>=<span class="ruby-identifier">de</span>, <span class="ruby-identifier">rows</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">tgtaddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">srcaddr:</span><span class="ruby-value">0x6000</span>, <span class="ruby-value">check_edge:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">break_oos:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid tgtaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">tgtaddr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid srcaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">srcaddr</span>)
  <span class="ruby-identifier">scrdiff</span> = (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">tgtaddr</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xffff</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;tgtaddr must be not be the same as srcaddr&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;address should be an address or a pointer or de&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">address</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rows should be a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">rows</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">rows</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols should be a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">cols</span>)
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">cols_p</span>], <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_edge</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">c</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">33</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># 32 - cols</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: rows</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">address</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_edge</span>
      <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ora</span>  <span class="ruby-operator">~</span><span class="ruby-value">31</span>
        <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">cols</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">c</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">start0</span>

    <span class="ruby-identifier">rowloop</span>         <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span> <span class="ruby-comment"># 32 - cols</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">adda_to</span> <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">break_oos</span>
                    <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">tgtaddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x1B</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">NC</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">start0</span>          <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">cols_a</span>        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">0</span> <span class="ruby-comment"># self-modified</span>
      <span class="ruby-identifier">cols_p</span>        <span class="ruby-identifier">cols_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ldir</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rowloop</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_shadow_attrs_region_quick" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_shadow_attrs_region_quick</span><span
            class="method-args">(address=de, rows=b, cols=32, tgtaddr:0x4000, srcaddr:0x6000, check_edge:true, break_oos:true, size_limit_opt:false, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies a rectangle of screen attributes from or to a shadow screen using unrolled LDI instructions.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>address</code>
<dd>
<p>An address of a top-left corner of the attributes memory area to be copied to as a label, pointer, an integer or <code>de</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rows</code>
<dd>
<p>A number of attribute rows to be copied as an 8-bit register or a label, pointer or an integer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of attribute columns to be copied as an integer.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tgtaddr</code>
<dd>
<p>A target screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>srcaddr</code>
<dd>
<p>A source screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check_edge</code>
<dd>
<p>Ensures that the region does not transgress the right edge of the screen decreasing <code>address</code> if necessary. Applies only if <code>address</code> is not static.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>break_oos</code>
<dd>
<p>Breaks execution when the bottom of the screen has been reached.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>size_limit_opt</code>
<dd>
<p>If enabled, a small optimization is applied but the following condition must be met: <code>rows*cols &lt; 256</code></p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>Whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="copy_shadow_attrs_region_quick-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 1396</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy_shadow_attrs_region_quick</span>(<span class="ruby-identifier">address</span>=<span class="ruby-identifier">de</span>, <span class="ruby-identifier">rows</span>=<span class="ruby-identifier">b</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">32</span>, <span class="ruby-value">tgtaddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">srcaddr:</span><span class="ruby-value">0x6000</span>, <span class="ruby-value">check_edge:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">break_oos:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">size_limit_opt:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid tgtaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">tgtaddr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid srcaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">srcaddr</span>)
  <span class="ruby-identifier">scrdiff</span> = (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">tgtaddr</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xffff</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;tgtaddr must be not be the same as srcaddr&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">scrxor</span> = <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">tgtaddr</span>
    <span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">^</span> <span class="ruby-identifier">tgtaddr</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;address should be an address or a pointer or de&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">address</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rows should be an integer or a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">rows</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span>
                                                                                                 <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">rows</span>)
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">fits_single_row</span> = <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">rows</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">b</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">255</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">size_limit_opt</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">address</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_edge</span>
      <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ora</span>  <span class="ruby-operator">~</span><span class="ruby-value">31</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">cols</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">scrxor</span>)
      <span class="ruby-identifier">scrbitdiff</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">log2</span>(<span class="ruby-identifier">scrxor</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>).<span class="ruby-identifier">to_i</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">d</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">srcaddr</span>
                    <span class="ruby-identifier">set</span>  <span class="ruby-identifier">scrbitdiff</span>, <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">res</span>  <span class="ruby-identifier">scrbitdiff</span>, <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">32</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">e</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">start1</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">32</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">e</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">start0</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">rowloop</span>         <span class="ruby-identifier">label</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">32</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-value">32</span><span class="ruby-operator">-</span><span class="ruby-identifier">cols</span>
                    <span class="ruby-identifier">adda_to</span> <span class="ruby-identifier">d</span>, <span class="ruby-identifier">e</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">break_oos</span>
                    <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">tgtaddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x1B</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">NC</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">start0</span>        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-identifier">start1</span>        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">255</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size_limit_opt</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">ldi</span> }
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rowloop</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_shadow_screen_region" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_shadow_screen_region</span><span
            class="method-args">(address=de, lines=a, cols=c, tgtaddr:0x4000, srcaddr:0x6000, check_edge:true, break_oos:true, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies a rectangle of an ink/paper screen from or to a shadow screen.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>address</code>
<dd>
<p>An address of a top-left corner of the screen memory area to be copied to as a label, pointer, or <code>de</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be copied as an 8-bit register or a label or a pointer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of 8 pixel columns to be copied as an 8-bit register or a label or a pointer. If <code>cols</code> is <code>a</code> the <code>cols</code> is taken from <code>a&#39;</code>.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Unless <code>cols</code> is a direct label or one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code> the routine uses self modifying code.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tgtaddr</code>
<dd>
<p>A target screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>srcaddr</code>
<dd>
<p>A source screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check_edge</code>
<dd>
<p>Ensures that the region does not transgress the right edge of the screen decreasing <code>address</code> if necessary. Applies only if <code>address</code> is not static.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>break_oos</code>
<dd>
<p>Breaks execution when the bottom of the screen has been reached. <code>CF</code> = 0 (NC) if the routine terminates prematurely due to reaching bottom of the screen. Otherwise <code>CF</code> = 1 if the whole rectangle has been copied.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>Whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>de</code>, <code>hl</code>. Swaps registers unless out of screen.</p>
          
          

          
          <div class="method-source-code" id="copy_shadow_screen_region-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 1005</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy_shadow_screen_region</span>(<span class="ruby-identifier">address</span>=<span class="ruby-identifier">de</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">tgtaddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">srcaddr:</span><span class="ruby-value">0x6000</span>, <span class="ruby-value">check_edge:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">break_oos:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid tgtaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">tgtaddr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid srcaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">srcaddr</span>)
  <span class="ruby-identifier">scrdiff</span> = (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">tgtaddr</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xffff</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;tgtaddr must be not be the same as srcaddr&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;address should be an address or a pointer or de&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">address</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lines should be a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span>
                                                                                  <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols should be a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span>
                                                                                  <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">cols</span>)
  <span class="ruby-identifier">fits_single_row</span> = <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&lt;=</span> (<span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>)
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: lines</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">cols_p</span>], <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_edge</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">c</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">address</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, ((<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xff</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">exx</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_edge</span>
        <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ora</span>  <span class="ruby-operator">~</span><span class="ruby-value">31</span>
          <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">cols</span>
          <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">c</span>
          <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>       <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">h</span>          <span class="ruby-comment"># (h &amp; 0b11111000) - h % 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># 8 - h % 8</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter: 8 - h % 8</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">exx</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: lines, a&#39;: lo</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c: lines</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines - 1 - counter</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">start</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = c: lines</span>

      <span class="ruby-identifier">start</span>         <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining rows - 1; CF&#39;: 1 == last batch, a: lo</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">rloop</span>           <span class="ruby-identifier">exx</span>
    <span class="ruby-identifier">loop0</span>           <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-identifier">loop1</span>           <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">cols_a</span>        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">0</span> <span class="ruby-comment"># self-modified</span>
      <span class="ruby-identifier">cols_p</span>        <span class="ruby-identifier">cols_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ldir</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rloop</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">fits_single_row</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: remaining lines, a&#39;: lo</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>

      <span class="ruby-identifier">loop8</span>         <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: lo, a&#39;: remaining lines</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: lo + 0x20</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">break_oos</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># e: lo</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_ooscr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">break_oos</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x08</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># d: adjusted</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">loop1</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">break_oos</span>
        <span class="ruby-identifier">check_ooscr</span> <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop1</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_shadow_screen_region_quick" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_shadow_screen_region_quick</span><span
            class="method-args">(address=de, lines=c, cols=32, tgtaddr:0x4000, srcaddr:0x6000, check_edge:true, break_oos:true, size_limit_opt:false, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies a rectangle of an ink/paper screen from or to a shadow screen using unrolled LDI instructions.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>address</code>
<dd>
<p>An address of a top-left corner of the screen memory area to be copied to as a label, pointer, an integer or <code>de</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be copied as an 8-bit register or a label, pointer or an integer.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of 8 pixel columns to be copied as an integer.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>tgtaddr</code>
<dd>
<p>A target screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>srcaddr</code>
<dd>
<p>A source screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check_edge</code>
<dd>
<p>Ensures that the region does not transgress the right edge of the screen decreasing <code>address</code> if necessary. Applies only if <code>address</code> is not static.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>break_oos</code>
<dd>
<p>Breaks execution when the bottom of the screen has been reached.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>size_limit_opt</code>
<dd>
<p>If enabled, a small optimization is applied but the following condition must be met: <code>lines*(cols-1) &lt; 256</code></p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>Whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="copy_shadow_screen_region_quick-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 1243</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy_shadow_screen_region_quick</span>(<span class="ruby-identifier">address</span>=<span class="ruby-identifier">de</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">32</span>, <span class="ruby-value">tgtaddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">srcaddr:</span><span class="ruby-value">0x6000</span>, <span class="ruby-value">check_edge:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">break_oos:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">size_limit_opt:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid tgtaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">tgtaddr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;invalid srcaddr argument&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">srcaddr</span>)
  <span class="ruby-identifier">scrdiff</span> = (<span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">tgtaddr</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xffff</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;tgtaddr must be not be the same as srcaddr&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scrdiff</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">scrxor</span> = <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">srcaddr</span> <span class="ruby-keyword">and</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">tgtaddr</span>
    <span class="ruby-identifier">srcaddr</span> <span class="ruby-operator">^</span> <span class="ruby-identifier">tgtaddr</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;address should be an address or a pointer or de&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">address</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lines should be an integer or a label or a pointer or a register&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span>
                                                                                                 <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">fits_single_row</span> = <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&lt;=</span> (<span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>)
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">c</span>          
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">address</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">address</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">scrxor</span>)
        <span class="ruby-identifier">scrbitdiff</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">log2</span>(<span class="ruby-identifier">scrxor</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>).<span class="ruby-identifier">to_i</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">d</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">srcaddr</span>
                    <span class="ruby-identifier">set</span>  <span class="ruby-identifier">scrbitdiff</span>, <span class="ruby-identifier">h</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">res</span>  <span class="ruby-identifier">scrbitdiff</span>, <span class="ruby-identifier">h</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">address</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">address</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_edge</span>
        <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ora</span>  <span class="ruby-operator">~</span><span class="ruby-value">31</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">cols</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>       <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">h</span>          <span class="ruby-comment"># (h &amp; 0b11111000) - h % 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># 8 - h % 8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter: 8 - h % 8</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># a: lines</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines - 1 - counter</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">8</span>
        <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = dy</span>
          <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining rows - 1; CF&#39;: 1 == last batch</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">255</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">size_limit_opt</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">copy_loop</span>       <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-identifier">copy_loop1</span>      <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">255</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">size_limit_opt</span>
                    (<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">ldi</span> }
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">copy_loop</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: lo; a: remaining rows - 1; CF: 1 == last batch</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">copy_loop8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>

      <span class="ruby-identifier">copy_loop8</span>    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining rows - 1; CF&#39;: 1 == last batch, a: lo</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: lo + 0x20</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">copy_loop</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">break_oos</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># e: lo</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_ooscr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">break_oos</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x08</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># d: adjusted</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">scrdiff</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">copy_loop1</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">break_oos</span>
        <span class="ruby-identifier">check_ooscr</span> <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">tgtaddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">copy_loop1</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-nextline" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">nextline</span><span
            class="method-args">(ah, al, bcheck = true, scraddr:0x4000, hires:false, **nsopts, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that advances to the next line (down) a screen address using ah|al registers. Optionally returns from a subroutine if an address would advance beyond the screen area.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a screen address to advance.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a screen address to advance.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>bcheck</code>
<dd>
<p>Out of screen check flag: <code>false</code> = disable checking, <code>true</code>  = issue <code>ret</code> if out of screen, <code>label</code> = jump to a label if out of screen, <code>hl</code>|<code>ix</code>|<code>iy</code> = jump to an address in a register if out of screen.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label, used only for an out of screen check.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>hires</code>
<dd>
<p>if <code>true</code> the out of screen check will be valid on any of the hi-res screen pages, in this instance only 2 highest bits of <code>scraddr</code> is important.</p>
</dd></dl>
</li></ul>

<p>If block is given and <code>bcheck</code> is <code>true</code> evaluates namespaced block instead of <code>ret</code>. The code in the given block should not fall through and should end with a jump or a <code>ret</code>.</p>

<p>T-states: </p>
<ul><li><dl class="rdoc-list note-list"><dt>when <code>bcheck</code> is <code>false</code>
<dd>
<p>27:87.5% / 49:1.56% / 59:10.94%</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>when <code>bcheck</code> is <code>true</code> or <code>label</code>
<dd>
<p>27:87.5% / (70:2 / 75:1):1.56% / 62:10.94%</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="nextline-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">nextline</span>(<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>, <span class="ruby-identifier">bcheck</span> = <span class="ruby-keyword">true</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">hires:</span><span class="ruby-keyword">false</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">nsopts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ah</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">bcheck</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">hl_</span>, <span class="ruby-identifier">ix_</span>, <span class="ruby-identifier">iy_</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bcheck</span>)) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ix</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">iy</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            <span class="ruby-operator">!</span>[<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) } <span class="ruby-keyword">or</span> 
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>)))
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;nextline: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">ah</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0x07</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">al</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">bcheck</span>
            <span class="ruby-identifier">scrhiaddr</span> = (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)
            <span class="ruby-identifier">scrhiaddr</span> = (<span class="ruby-identifier">scrhiaddr</span><span class="ruby-operator">|</span><span class="ruby-value">0x20</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">hires</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">restrh</span>
                <span class="ruby-identifier">ora</span>  <span class="ruby-value">0x20</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hires</span>
                <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scrhiaddr</span><span class="ruby-operator">|</span><span class="ruby-value">0x18</span>)
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">case</span> <span class="ruby-identifier">bcheck</span>
            <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
                    <span class="ruby-identifier">ns</span>(<span class="ruby-operator">**</span><span class="ruby-identifier">nsopts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ret</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">bcheck</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">restrh</span>      <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x08</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-nextpixel" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">nextpixel</span><span
            class="method-args">(al, s: a)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that changes a bit shift and the pixel address for a one pixel to the right.</p>

<p>Modifies: <code>af</code>, <code>al</code>, <code>s</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding the least significant byte of the pixel address to move.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>A register holding a bit shift value of the pixel in the range: [0-7]</p>
</dd></dl>
</li></ul>

<p>T-states: 23/22 (s ≠ a: 31/30)</p>
          
          

          
          <div class="method-source-code" id="nextpixel-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 92</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">nextpixel</span>(<span class="ruby-identifier">al</span>, <span class="ruby-value">s:</span> <span class="ruby-identifier">a</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">al</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">s</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">s</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;nextpixel: invalid arguments!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">s</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">s</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">7</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">al</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-nextrow" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">nextrow</span><span
            class="method-args">(ah, al, bcheck = true, scraddr:0x4000, **nsopts, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that advances to the next text row (down 8 pixels) a screen address using ah|al registers. Optionally returns from a subroutine if an address would advance beyond the screen area.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a screen address to advance.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a screen address to advance.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>bcheck</code>
<dd>
<p>Out of screen check flag: <code>false</code> = disable checking, <code>true</code>  = issue <code>ret</code> if out of screen, <code>label</code> = jump to label if out of screen, <code>hl</code>|<code>ix</code>|<code>iy</code> = jump to an address in a register if out of screen.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li></ul>

<p>If block is given and <code>bcheck</code> is <code>true</code> evaluates namespaced block instead of <code>ret</code>.</p>

<p>T-states: </p>
<ul><li><dl class="rdoc-list note-list"><dt>when <code>bcheck</code> is <code>false</code>
<dd>
<p>27:87.5% / 37:12.50%</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>when <code>bcheck</code> is <code>true</code> or <code>label</code>
<dd>
<p>27:87.5% / (49:2 / 55:1):12.50% / 54:12.50%</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="nextrow-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 550</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">nextrow</span>(<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>, <span class="ruby-identifier">bcheck</span> = <span class="ruby-keyword">true</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">nsopts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ah</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">bcheck</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">hl_</span>, <span class="ruby-identifier">ix_</span>, <span class="ruby-identifier">iy_</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bcheck</span>)) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ix</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">iy</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            <span class="ruby-operator">!</span>[<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) } <span class="ruby-keyword">or</span>
            <span class="ruby-operator">!</span>((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;nextrow: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">al</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>
            <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
            <span class="ruby-identifier">add</span>  <span class="ruby-value">0x08</span>
            <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">bcheck</span>
            <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
            <span class="ruby-keyword">case</span> <span class="ruby-identifier">bcheck</span>
            <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
                    <span class="ruby-identifier">ns</span>(<span class="ruby-operator">**</span><span class="ruby-identifier">nsopts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">NC</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>  <span class="ruby-constant">NC</span>, <span class="ruby-identifier">bcheck</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-only_one_bit_set_or_zero-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">only_one_bit_set_or_zero?</span><span
            class="method-args">(v)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns true if <code>v</code> is a 0 or a positive integer with only one bit set in its binary representation.</p>
          
          

          
          <div class="method-source-code" id="only_one_bit_set_or_zero-3F-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 44</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">v</span>)
    <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">v</span> <span class="ruby-operator">&amp;</span> (<span class="ruby-identifier">v</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-prevline" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">prevline</span><span
            class="method-args">(ah, al, bcheck = true, scraddr:0x4000, hires:false, **nsopts, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that moves up to the previous line a screen address using ah|al registers. Optionally returns from a subroutine if an address would move out of the screen area.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a screen address to move.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a screen address to move.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>bcheck</code>
<dd>
<p>Out of screen check flag: <code>false</code> = disable checking, <code>true</code>  = issue <code>ret</code> if out of screen, <code>label</code> = jump to a label if out of screen, <code>hl</code>|<code>ix</code>|<code>iy</code> = jump to an address in a register if out of screen.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label, used only for an out of screen check.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>hires</code>
<dd>
<p>if <code>true</code> the out of screen check will be valid on any of the hi-res screen pages, in this instance only 2 highest bits of <code>scraddr</code> is important.</p>
</dd></dl>
</li></ul>

<p>If block is given and <code>bcheck</code> is <code>true</code> evaluates namespaced block instead of <code>ret</code>. The code in the given block should not fall through and should end with a jump or a <code>ret</code>.</p>

<p>T-states: </p>
<ul><li><dl class="rdoc-list note-list"><dt>when <code>bcheck</code> is <code>false</code>
<dd>
<p>27:87.5% / 49:1.56% / 59:10.94%</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt>when <code>bcheck</code> is <code>true</code> or <code>label</code>
<dd>
<p>27:87.5% / (70:2 / 75:1):1.56% / 62:10.94%</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="prevline-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 199</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">prevline</span>(<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>, <span class="ruby-identifier">bcheck</span> = <span class="ruby-keyword">true</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">hires:</span><span class="ruby-keyword">false</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">nsopts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ah</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">bcheck</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">hl_</span>, <span class="ruby-identifier">ix_</span>, <span class="ruby-identifier">iy_</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bcheck</span>)) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">h</span>, <span class="ruby-identifier">l</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ix</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ixh</span>, <span class="ruby-identifier">ixl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">iy</span> <span class="ruby-keyword">and</span> ([<span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">iyh</span>, <span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">al</span>))) <span class="ruby-keyword">or</span>
            <span class="ruby-operator">!</span>[<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) } <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">bcheck</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>)))
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;prevline: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">ah</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0x07</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">al</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x20</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">bcheck</span>
            <span class="ruby-identifier">scrhiaddr</span> = (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)
            <span class="ruby-identifier">scrhiaddr</span> = (<span class="ruby-identifier">scrhiaddr</span><span class="ruby-operator">|</span><span class="ruby-value">0x20</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">hires</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">restrh</span>
                <span class="ruby-identifier">ora</span>  <span class="ruby-value">0x20</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hires</span>
                <span class="ruby-identifier">cp</span>   <span class="ruby-identifier">scrhiaddr</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
            <span class="ruby-keyword">case</span> <span class="ruby-identifier">bcheck</span>
            <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
                    <span class="ruby-identifier">ns</span>(<span class="ruby-operator">**</span><span class="ruby-identifier">nsopts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
                <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ret</span>
                <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jp</span>  <span class="ruby-identifier">bcheck</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">restrh</span>      <span class="ruby-identifier">add</span>  <span class="ruby-value">0x08</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-prevpixel" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">prevpixel</span><span
            class="method-args">(al, s: a)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that changes a bit shift and the pixel address for a one pixel to the left.</p>

<p>Modifies: <code>af</code>, <code>al</code>, <code>s</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding the least significant byte of the pixel address to move.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>A register holding a bit shift value of the pixel in the range: [0-7]</p>
</dd></dl>
</li></ul>

<p>T-states: 14/25.</p>
          
          

          
          <div class="method-source-code" id="prevpixel-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">prevpixel</span>(<span class="ruby-identifier">al</span>, <span class="ruby-value">s:</span> <span class="ruby-identifier">a</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">al</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">s</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">s</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;prevpixel: invalid arguments!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">s</span>
                <span class="ruby-identifier">jp</span>   <span class="ruby-constant">P</span>, <span class="ruby-identifier">eoc</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-value">7</span>
                <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">al</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-rctoattr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rctoattr</span><span
            class="method-args">(row, col=0, ah:h, al:l, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts row and column coordinates to an address of a color attribute.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>row</code>
<dd>
<p>An 8-bit register as a text row [0-23].</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>col</code>
<dd>
<p>An 8-bit register, except <code>accumulator</code>, as a text column [0-31] or an integer or a label. If it&#39;s a register then it must not be the same as <code>ah</code>.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li></ul>

<p>T-states: 46/54/57/60 for <code>col</code>: <code>0</code>/<code>register</code>/<code>al</code>/<code>number</code>, T-4 if <code>row</code> is <code>accumulator</code>.</p>

<p>r &lt; 0  0  0  5r 4r 3r 2r 1r,  c &lt; 0  0  0  5c 4c 3c 2c 1c, h &gt; 0  1  0  1  1  0  5r 4r,  l &lt; 3r 2r 1r 5c 4c 3c 2c 1c</p>
          
          

          
          <div class="method-source-code" id="rctoattr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 504</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rctoattr</span>(<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>=<span class="ruby-value">0</span>, <span class="ruby-value">ah:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">al:</span><span class="ruby-identifier">l</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">ah</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">al</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ah</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">col</span>, <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">and</span>
         ((<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">col</span>)) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">ah</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">row</span>)) <span class="ruby-keyword">and</span>
         ((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rctoattr: invalid arguments!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">attraddr</span> = <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">+</span> <span class="ruby-value">0x1800</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">row</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> {<span class="ruby-identifier">rrca</span>}
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>               <span class="ruby-comment"># h= L L L x x x H H</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11100000</span>          <span class="ruby-comment"># a= L L L 0 0 0 0 0</span>
        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">col</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment"># a= L L L C C C C C</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>               <span class="ruby-comment"># l= L L L C C C C C</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">al</span>
        <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">col</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment"># a= L L L 0 0 0 0 0</span>
        <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">ah</span>                  <span class="ruby-comment"># a= 0 0 0 x x x H H</span>
    <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>               <span class="ruby-comment"># h= L L L x x x H H</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000011</span>          <span class="ruby-comment"># h= 0 0 0 0 0 0 H H</span>
    <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">ora</span>  (<span class="ruby-identifier">attraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)       <span class="ruby-comment"># a= S S S 1 1 x H H</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>               <span class="ruby-comment"># h= S S S 1 1 x H H</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-rctoscr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rctoscr</span><span
            class="method-args">(row, col=0, ah:h, al:l, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts row and column coordinates to a byte address of a top 8-pixel line.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>row</code>
<dd>
<p>An 8-bit register as a text row [0-23]. <code>row</code> must not be the same as <code>ah</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>col</code>
<dd>
<p>An 8-bit register, except <code>accumulator</code>, as a text column [0-31] or an integer or a label. If it&#39;s a register then it must not be the same as <code>ah</code>. If <code>row</code> is <code>accumulator</code> then <code>col</code> must not be the same as <code>al</code>.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li></ul>

<p>T-states: 43</p>
<ul><li>
<p>T + 4: if <code>col</code> is a register.</p>
</li><li>
<p>T + 7: if <code>col</code> is a non-zero integer.</p>
</li><li>
<p>T + 6: if <code>scraddr</code> has more than one bit set.</p>
</li></ul>

<p>r &lt; 0  0  0  5r 4r 3r 2r 1r,  c &lt; 0  0  0  5c 4c 3c 2c 1c, h &gt; 0  1  0  5r 4r 0  0  0,   l &lt; 3r 2r 1r 5c 4c 3c 2c 1c</p>
          
          

          
          <div class="method-source-code" id="rctoscr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 456</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rctoscr</span>(<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>=<span class="ruby-value">0</span>, <span class="ruby-value">ah:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">al:</span><span class="ruby-identifier">l</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">ah</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">al</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ah</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">col</span>, <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">and</span>
         ((<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">col</span>)) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">ah</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">row</span> <span class="ruby-keyword">and</span> (<span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>))) <span class="ruby-keyword">and</span>
         ((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rctoscr: invalid arguments!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">row</span>
    <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00011000</span> <span class="ruby-comment"># a= 0  0  0  H  H  0  0  0</span>
                <span class="ruby-identifier">ora</span>  (<span class="ruby-identifier">scraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">scraddr</span>)
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>      <span class="ruby-comment"># h= S  S  S  H  H  0  0  0</span>
                <span class="ruby-identifier">xor</span>  (<span class="ruby-identifier">scraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">scraddr</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">row</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">al</span>         <span class="ruby-comment"># a= 0  0  0  0  0  r  r  r</span>
    <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">row</span>        <span class="ruby-comment"># a= 0  0  0  0  0  r  r  r</span>
    <span class="ruby-keyword">end</span>
                <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> {<span class="ruby-identifier">rrca</span>}  <span class="ruby-comment"># a= r  r  r  0  0  0  0  0</span>
                <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">col</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>      <span class="ruby-comment"># l= r  r  r  c  c  c  c  c</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">scraddr</span>)
            <span class="ruby-identifier">nbit</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">log2</span>(<span class="ruby-identifier">scraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>).<span class="ruby-identifier">to_i</span>
                <span class="ruby-identifier">set</span>  <span class="ruby-identifier">nbit</span>, <span class="ruby-identifier">ah</span>   <span class="ruby-comment"># h= S  S  S  H  H  0  0  0</span>
        <span class="ruby-keyword">end</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-scrtoattr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">scrtoattr</span><span
            class="method-args">(s, o:s, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts a high byte of a pixel address to a high byte of an address of a relevant attribute.</p>

<p>Modifies: <code>af</code>, <code>o</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>A register holding a high byte of an address to convert.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>o</code>
<dd>
<p>A register holding a high byte of a resulting address. <code>o</code> is the same as <code>s</code> by default.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li></ul>

<p>T-states: </p>
<ul><li>
<p>34: when neither <code>s</code> nor <code>o</code> is the <code>a</code> register</p>
</li><li>
<p>30: when <code>s</code> is the <code>a</code> register but not <code>o</code></p>
</li><li>
<p>30: when <code>o</code> is the <code>a</code> register but not <code>s</code></p>
</li><li>
<p>26: when each <code>s</code> and <code>o</code> is the <code>a</code> register</p>
</li></ul>

<p>i &lt; 0  1  0  2a 1a l  l  l, o &gt; 0  1  0  1  1  0  2a 1a</p>
          
          

          
          <div class="method-source-code" id="scrtoattr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 604</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">scrtoattr</span>(<span class="ruby-identifier">s</span>, <span class="ruby-value">o:</span><span class="ruby-identifier">s</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
    <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">s</span>, <span class="ruby-identifier">o</span>].<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) } <span class="ruby-keyword">and</span>
           ((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;scrtoattr: invalid arguments!&quot;</span> 
    <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">attraddr</span> = <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">+</span> <span class="ruby-value">0x1800</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">s</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                        <span class="ruby-comment"># a= S S S H H h h h</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00011000</span> <span class="ruby-comment"># a= 0 0 0 H H 0 0 0</span>
        <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> {<span class="ruby-identifier">rrca</span>}  <span class="ruby-comment"># a= 0 0 0 0 0 0 H H</span>
        <span class="ruby-identifier">ora</span>  (<span class="ruby-identifier">attraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)
                        <span class="ruby-comment"># a= S S S 1 1 0 H H</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">o</span>, <span class="ruby-identifier">a</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-xy_to_attr_addr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">xy_to_attr_addr</span><span
            class="method-args">(x, y, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Calculates a constant screen attribute address from the pixel coordinates.</p>
          
          

          
          <div class="method-source-code" id="xy_to_attr_addr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 60</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">xy_to_attr_addr</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
    ( ( (<span class="ruby-identifier">y</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">3</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">5</span> ) <span class="ruby-operator">|</span> (<span class="ruby-identifier">x</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">3</span>) ) <span class="ruby-operator">+</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">+</span> <span class="ruby-value">0x1800</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-xy_to_pixel_addr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">xy_to_pixel_addr</span><span
            class="method-args">(x, y, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Calculates a constant screen pixel byte address from the pixel coordinates.</p>
          
          

          
          <div class="method-source-code" id="xy_to_pixel_addr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 49</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">xy_to_pixel_addr</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
    (
        (
            (
                ((<span class="ruby-identifier">y</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x07</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">3</span>) <span class="ruby-operator">|</span> ((<span class="ruby-identifier">y</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0b111000</span>) <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">3</span>) <span class="ruby-operator">|</span> ((<span class="ruby-identifier">y</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xffc0</span>))
            ) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">5</span>
        ) <span class="ruby-operator">|</span> ((<span class="ruby-identifier">x</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xff</span>) <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">3</span>)
    ) <span class="ruby-operator">+</span> <span class="ruby-identifier">scraddr</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-xytoscr" class="method-detail method-alias">
        
        <div class="method-heading">
          <span class="method-name">xytoscr</span><span
            class="method-args">(y, x, ah:h, al:l, s:b, t:c, scraddr:0x4000)</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
        </div>

        

        
        <div class="aliases">
          Alias for: <a href="Macros.html#method-i-yxtoscr">yxtoscr</a>
        </div>
        
      </div>

    
      <div id="method-i-ytoattr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ytoattr</span><span
            class="method-args">(y, ah:h, al:l, col:0, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts a vertical pixel coordinate to an address of a color attribute.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>y</code>
<dd>
<p>An 8-bit input register holding a vertical pixel coordinate.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>col</code>
<dd>
<p>An 8-bit register, except <code>accumulator</code>, as a text column [0-31] or an integer or a label. If it&#39;s a register then it must not be the same as <code>ah</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li></ul>

<p>T-states: 49/53/56 for <code>col</code>: <code>0</code>/<code>register</code>/<code>number</code>, T-4 if <code>y</code> is <code>accumulator</code>.</p>

<p>y &lt; 5r 4r 3r 2r 1r 0  0  0 ,  c &lt; 0  0  0  5c 4c 3c 2c 1c, h &gt; 0  1  0  1  1  0  5r 4r,  l &lt; 3r 2r 1r 5c 4c 3c 2c 1c</p>
          
          

          
          <div class="method-source-code" id="ytoattr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 413</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ytoattr</span>(<span class="ruby-identifier">y</span>, <span class="ruby-value">ah:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">al:</span><span class="ruby-identifier">l</span>, <span class="ruby-value">col:</span><span class="ruby-value">0</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">ah</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">ah</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">al</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ah</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">al</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">col</span>, <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">and</span>
         ((<span class="ruby-identifier">address?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">col</span>)) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">ah</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">y</span>)) <span class="ruby-keyword">and</span>
         ((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;ytoattr: invalid arguments!&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">attraddr</span> = <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">+</span> <span class="ruby-value">0x1800</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">y</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
        <span class="ruby-value">2</span>.<span class="ruby-identifier">times</span> {<span class="ruby-identifier">rlca</span>}
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>               <span class="ruby-comment"># h= L L L x x x H H</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11100000</span>          <span class="ruby-comment"># a= L L L 0 0 0 0 0</span>
        <span class="ruby-identifier">add</span>  <span class="ruby-identifier">col</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment"># a= L L L C C C C C</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>               <span class="ruby-comment"># l= L L L C C C C C</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ah</span>               <span class="ruby-comment"># h= L L L x x x H H</span>
        <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000011</span>          <span class="ruby-comment"># h= 0 0 0 0 0 0 H H</span>
        <span class="ruby-identifier">ora</span>  (<span class="ruby-identifier">attraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)       <span class="ruby-comment"># a= S S S 1 1 0 H H</span>
        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>               <span class="ruby-comment"># h= S S S 1 1 0 H H</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ytoscr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ytoscr</span><span
            class="method-args">(y, ah:h, al:l, col:nil, t:c, scraddr:0x4000, hires:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts a vertical pixel coordinate to a screen byte address.</p>

<p>Modifies: <code>af</code>, <code>ah</code>, <code>al</code>, <code>t</code>. <code>col</code> only in <code>hires</code> mode.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>y</code>
<dd>
<p>An 8-bit input register holding a vertical pixel coordinate. It must not be the same as <code>t</code>.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>col</code>
<dd>
<p>An optional column number [0-31] ([0-63] in <code>hires</code> mode) as a unique 8-bit register or an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit register for temporary operations.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>hires</code>
<dd>
<p>Enable SCLD or ULAplus hi-res mode. If enabled, <code>col</code> is interpreted as hi-res screen column and only 2 highest bits of <code>scraddr</code> is being used to establish the primary screen memory address.</p>
</dd></dl>
</li></ul>

<p>T-states: 73/81/97/87 if <code>col</code> is: <code>nil</code>/<code>register</code>/<code>register</code> and <code>hires</code>/<code>number</code>.</p>

<p>y &lt; a1 a2 h3 h2 h1 l3 l2 l1, h &gt; S  S  S  a1 a2 l3 l2 l1,  l &gt; h3 h2 h1 0  0  0  0  0</p>
          
          

          
          <div class="method-source-code" id="ytoscr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 346</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ytoscr</span>(<span class="ruby-identifier">y</span>, <span class="ruby-value">ah:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">al:</span><span class="ruby-identifier">l</span>, <span class="ruby-value">col:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>, <span class="ruby-value">hires:</span><span class="ruby-keyword">false</span>)
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ah</span>,<span class="ruby-identifier">al</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ah</span>,<span class="ruby-identifier">al</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">3</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">y</span> <span class="ruby-keyword">or</span>
            <span class="ruby-operator">!</span>[<span class="ruby-identifier">y</span>, <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) } <span class="ruby-keyword">or</span>
            (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> [<span class="ruby-identifier">y</span>, <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">col</span>)) <span class="ruby-keyword">or</span>
            (<span class="ruby-operator">!</span><span class="ruby-identifier">col</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">address?</span>(<span class="ruby-identifier">col</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">col</span>) <span class="ruby-keyword">or</span>
            <span class="ruby-operator">!</span>((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;ytoscr: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">scraddrhi</span> = (<span class="ruby-identifier">scraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)
    <span class="ruby-identifier">scraddrhi</span> = (<span class="ruby-identifier">scraddrhi</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xC0</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">hires</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">y</span>
        <span class="ruby-keyword">end</span>                       <span class="ruby-comment"># a= H H h h h l l l</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000111</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>         <span class="ruby-comment"># h= 0 0 0 0 0 l l l</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">al</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">y</span>
        <span class="ruby-keyword">end</span>                       <span class="ruby-comment"># a= H H h h h 0 0 0</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">hires</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">col</span>)       <span class="ruby-comment"># col= 0 0 c c c c c p</span>
                <span class="ruby-identifier">srl</span>  <span class="ruby-identifier">col</span>          <span class="ruby-comment"># col= 0 0 0 c c c c c CF=page</span>
                <span class="ruby-identifier">rra</span>               <span class="ruby-comment"># a= p H H h h h 0 0</span>
                <span class="ruby-identifier">rlca</span>              <span class="ruby-comment"># a= H H h h h 0 0 p</span>
          <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">col</span>
                <span class="ruby-identifier">scraddrhi</span> = <span class="ruby-identifier">scraddrhi</span> <span class="ruby-operator">|</span> ((<span class="ruby-identifier">col</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">5</span>)
                <span class="ruby-identifier">col</span> = (<span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">rlca</span>              <span class="ruby-comment"># a= H h h h 0 0 p H</span>
                <span class="ruby-identifier">rlca</span>              <span class="ruby-comment"># a= h h h 0 0 p H H</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># h= h h h 0 0 p H H</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11100000</span>   <span class="ruby-comment"># a= h h h 0 0 0 0 0</span>
                <span class="ruby-identifier">add</span>  <span class="ruby-identifier">col</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">col</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># l= h h h c c c c c</span>
                <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">col</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">col</span>   <span class="ruby-comment"># a= h h h 0 0 0 0 0</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">ah</span>           <span class="ruby-comment"># a= 0 0 0 0 0 p H H</span>
                <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rlca</span> }
                <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">t</span>            <span class="ruby-comment"># a= 0 0 p H H l l l</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">scraddrhi</span>    <span class="ruby-comment"># a= S S p H H l l l</span>
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># h= S S p H H l l l</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-yxtoscr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">yxtoscr</span><span
            class="method-args">(y, x, ah:h, al:l, s:b, t:c, scraddr:0x4000)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that converts y,x coordinates to a screen byte address and a bits shift.</p>

<p>Modifies: <code>af</code>, <code>s</code>, <code>t</code>, <code>ah</code>, <code>al</code>.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>y</code>
<dd>
<p>An 8-bit input register holding a vertical pixel coordinate. It must not be the same as the <code>s</code> output register.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>x</code>
<dd>
<p>An 8-bit input register, except <code>accumulator</code>, holding a horizontal pixel coordinate. It must not be the same as <code>ah</code>, <code>s</code> or <code>t</code>.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>ah</code>
<dd>
<p>A register holding a high byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>al</code>
<dd>
<p>A register holding a low byte of a resulting address.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>s</code>
<dd>
<p>A register holding a resulting bits right shift: [0-7]. This indicates how many bits the most significant bit should be shifted to the right to match the input coordinate x.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>t</code>
<dd>
<p>An 8-bit register for temporary operations.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>A screen memory address which must be a multiple of 0x2000 as an integer or a label.</p>
</dd></dl>
</li></ul>

<p>T-states: 101/104 depending on <code>scraddr</code> (101 for 0x2000, 0x4000, 0x8000)</p>

<p>y &lt; a1 a2 h3 h2 h1 l3 l2 l1,  x &lt; x5 x4 x3 x2 x1 s3 s2 s1, h &gt; S  S  S  a1 a2 l3 l2 l1,  l &gt; h3 h2 h1 x5 x4 x3 x2 x1,  s &gt; 0  0  0  0  0  s3 s2 s1</p>
          
          

          
          <div class="method-source-code" id="yxtoscr-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx.rb, line 266</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">yxtoscr</span>(<span class="ruby-identifier">y</span>, <span class="ruby-identifier">x</span>, <span class="ruby-value">ah:</span><span class="ruby-identifier">h</span>, <span class="ruby-value">al:</span><span class="ruby-identifier">l</span>, <span class="ruby-value">s:</span><span class="ruby-identifier">b</span>, <span class="ruby-value">t:</span><span class="ruby-identifier">c</span>, <span class="ruby-value">scraddr:</span><span class="ruby-value">0x4000</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">x</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">x</span>,<span class="ruby-identifier">ah</span>,<span class="ruby-identifier">al</span>,<span class="ruby-identifier">s</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ah</span>,<span class="ruby-identifier">al</span>,<span class="ruby-identifier">s</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">3</span> <span class="ruby-keyword">or</span> [<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">s</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">t</span>) <span class="ruby-keyword">or</span> 
          [<span class="ruby-identifier">ah</span>, <span class="ruby-identifier">s</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">x</span>) <span class="ruby-keyword">or</span> <span class="ruby-operator">!</span>[<span class="ruby-identifier">y</span>, <span class="ruby-identifier">x</span>, <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">al</span>, <span class="ruby-identifier">s</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">r</span>) } <span class="ruby-keyword">or</span>
          <span class="ruby-operator">!</span>((<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>)) <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">scraddr</span>))
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;yxtoscr: invalid arguments!&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">y</span>
        <span class="ruby-keyword">end</span>                 <span class="ruby-comment"># a= H H h h h l l l</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000111</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span>   <span class="ruby-comment"># s= 0 0 0 0 0 l l l</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">y</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">ah</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">y</span>      <span class="ruby-comment"># a= H H h h h 0 0 0</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">only_one_bit_set_or_zero?</span>(<span class="ruby-identifier">scraddr</span>)
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x2000</span>).<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">rrca</span>        <span class="ruby-comment"># a= 0 H H h h h 0 0</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">scf</span>
                <span class="ruby-identifier">rra</span>         <span class="ruby-comment"># a= 1 H H h h h 0 0</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x4000</span>).<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">rrca</span>        <span class="ruby-comment"># a= 0 S H H h h h 0</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">scf</span>
                <span class="ruby-identifier">rra</span>         <span class="ruby-comment"># a= 1 S H H h h h 0</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0x8000</span>).<span class="ruby-identifier">zero?</span>
                <span class="ruby-identifier">rrca</span>        <span class="ruby-comment"># a= 0 S S H H h h h</span>
            <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">scf</span>
                <span class="ruby-identifier">rra</span>         <span class="ruby-comment"># a= 1 S S H H h h h</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rrca</span> }
                <span class="ruby-identifier">ora</span> (<span class="ruby-identifier">scraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)
        <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>  <span class="ruby-comment"># h= S S S H H h h h</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000111</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">a</span>   <span class="ruby-comment"># t= 0 0 0 0 0 h h h</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">ah</span>     <span class="ruby-comment"># a= S S S H H 0 0 0</span>
                <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">s</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">ah</span>, <span class="ruby-identifier">a</span>  <span class="ruby-comment"># h= S S S H H l l l</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">x</span>   <span class="ruby-comment"># a= x x x x x s s s</span>
                <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000111</span>
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">s</span>, <span class="ruby-identifier">a</span>   <span class="ruby-comment"># s= 0 0 0 0 0 s s s</span>
                <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">x</span>      <span class="ruby-comment"># a= x x x x x 0 0 0</span>
                <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">t</span>      <span class="ruby-comment"># a= x x x x x h h h</span>
                <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rrca</span> }
                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">al</span>, <span class="ruby-identifier">a</span>  <span class="ruby-comment"># l= h h h x x x x x</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        
        <div class="aliases">
          Also aliased as: <a href="Macros.html#method-i-xytoscr">xytoscr</a>
        </div>
        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

