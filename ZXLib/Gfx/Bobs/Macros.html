<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module ZXLib::Gfx::Bobs::Macros - ruby-Z80</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/navigation.js" defer></script>
<script src="../../../js/search.js" defer></script>
<script src="../../../js/search_index.js" defer></script>
<script src="../../../js/searcher.js" defer></script>
<script src="../../../js/darkfish.js" defer></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="Constants.html">ZXLib::Gfx::Bobs::Constants</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-bobs_combine_pixels">#bobs_combine_pixels</a>
    
    <li ><a href="#method-i-bobs_copy_attrs">#bobs_copy_attrs</a>
    
    <li ><a href="#method-i-bobs_copy_attrs_fast">#bobs_copy_attrs_fast</a>
    
    <li ><a href="#method-i-bobs_copy_pixels">#bobs_copy_pixels</a>
    
    <li ><a href="#method-i-bobs_copy_pixels_fast">#bobs_copy_pixels_fast</a>
    
    <li ><a href="#method-i-bobs_draw_pixels_fast">#bobs_draw_pixels_fast</a>
    
    <li ><a href="#method-i-bobs_draw_pixels_fast_jump_table">#bobs_draw_pixels_fast_jump_table</a>
    
    <li ><a href="#method-i-bobs_draw_pixels_fast_routines">#bobs_draw_pixels_fast_routines</a>
    
    <li ><a href="#method-i-bobs_rshift_bitmap_pixels_7times">#bobs_rshift_bitmap_pixels_7times</a>
    
    <li ><a href="#method-i-bobs_rshift_bitmap_pixels_once">#bobs_rshift_bitmap_pixels_once</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-ZXLib::Gfx::Bobs::Macros">
  <h1 id="module-ZXLib::Gfx::Bobs::Macros" class="module">
    module ZXLib::Gfx::Bobs::Macros
  </h1>

  <section class="description">
    
<h2 id="module-ZXLib::Gfx::Bobs::Macros-label-ZXLib-3A-3AGfx-3A-3ABobs+macros."><a href="../Bobs.html"><code>ZXLib::Gfx::Bobs</code></a> macros.<span><a href="#module-ZXLib::Gfx::Bobs::Macros-label-ZXLib-3A-3AGfx-3A-3ABobs+macros.">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="Macros.html"><code>Bobs::Macros</code></a> require:</p>

<pre class="ruby"><span class="ruby-identifier">macro_import</span> <span class="ruby-constant">MathInt</span>
<span class="ruby-identifier">macro_import</span> <span class="ruby-constant">Gfx</span>
</pre>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-bobs_combine_pixels" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_combine_pixels</span><span
            class="method-args">(bitmap=hl, lines=a, cols=c, target:de, mode: :or, scraddr:nil, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that combines bitmap pixel lines as a rectangle of pixels with the ink/paper screen data.</p>

<p>No pixel shifting is performed on a bitmap.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>bitmap</code>
<dd>
<p>A direct or indirect address of a bitmap data containing the pixel lines as a label, an integer or <code>hl</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be copied as an 8-bit register or a label or a pointer. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of 8 pixel columns to be copied as an 8-bit register or a label or a pointer. If an accumulator (<code>a</code>) is given to <code>cols</code> then the value is expected in <code>a&#39;</code>. The number 0 is treated as 65536 and will lead to UNDEFINED BEHAVIOUR, clobbering the whole memory in the process.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Unless <code>cols</code> is one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code> the routine uses self modifying code.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>target</code>
<dd>
<p>A direct or indirect address of the screen memory to be combined with the lines of the</p>
</dd></dl>

<pre>bitmap as a label, an integer or +de+. The starting address of the entire screen memory must be
a multiple of 0x2000.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional entire screen memory address which must be a multiple of 0x2000 as</p>
</dd></dl>

<pre>an integer or an immediate label. If provided, the routine breaks execution when the bottom
of the screen has been reached. +CF+ = 0 (NC) is signalled if the routine terminates prematurely
due to reaching the bottom of the screen. Otherwise +CF+ = 1 if the whole bitmap has been copied.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>A boolean indicating whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>The <code>mode</code> option can be changed at run time in the resulting routine, by storing a new operation under the <code>fx_a</code> sub-label. The following constants can be used for this purpose: <code>COMBINE_FX_NOP</code>, <code>COMBINE_FX_SET</code>, <code>COMBINE_FX_AND</code>, <code>COMBINE_FX_XOR</code>, <code>COMBINE_FX_OR</code>.</p>

<pre class="ruby">                <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-constant">Gfx</span><span class="ruby-operator">::</span><span class="ruby-constant">Bobs</span><span class="ruby-operator">::</span><span class="ruby-constant">COMBINE_FX_AND</span>
                <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">combine_bitmap</span>.<span class="ruby-identifier">fx_a</span>], <span class="ruby-identifier">a</span>
<span class="ruby-comment"># ...</span>
<span class="ruby-identifier">combine_bitmap</span>  <span class="ruby-identifier">bobs_combine_pixels</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:xor</span>, <span class="ruby-value">subroutine:</span> <span class="ruby-keyword">true</span>)
</pre>

<p>Using <code>:set</code> or <code>COMBINE_FX_SET</code> mode has been included for completeness in this routine, but is sub-optimal. For copying bitmaps to the screen, using <a href="Macros.html#method-i-bobs_copy_pixels"><code>bobs_copy_pixels</code></a> is preferable.</p>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>de</code>, <code>hl</code>. Swaps registers unless out of screen.</p>
          
          

          
          <div class="method-source-code" id="bobs_combine_pixels-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 233</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_combine_pixels</span>(<span class="ruby-identifier">bitmap</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">target:</span><span class="ruby-identifier">de</span>, <span class="ruby-value">mode:</span> <span class="ruby-value">:or</span>, <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_combine_pixels: invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span>
                                                              <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">scraddr</span>) <span class="ruby-keyword">or</span>
                                  (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>))
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">target</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_combine_pixels: target should be an address or de&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">bitmap</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_combine_pixels: bitmap should be an address or hl&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_combine_pixels: lines should be an integer, a label or a pointer or a register&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">cols</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_combine_pixels: cols should be an integer, a label or a pointer or a register&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">fx</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">mode</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:or</span>, <span class="ruby-constant">COMBINE_FX_OR</span>   <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">ora</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:xor</span>, <span class="ruby-constant">COMBINE_FX_XOR</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">xor</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:and</span>, <span class="ruby-constant">COMBINE_FX_AND</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">anda</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:nop</span>, <span class="ruby-constant">COMBINE_FX_NOP</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">nop</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:set</span>, <span class="ruby-constant">COMBINE_FX_SET</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_combine_pixels: mode should be one of: :or, :xor, :and, :none, :set&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: lines</span>
    <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">cols_p</span>], <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">e</span>       <span class="ruby-comment"># lo</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">target</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">target</span>)
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">target</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>       <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">d</span>          <span class="ruby-comment"># (h &amp; 0b11111000) - h % 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># 8 - h % 8</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter: 8 - h % 8</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c: lines</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines - 1 - counter</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">start</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = c: lines</span>

    <span class="ruby-identifier">start</span>           <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining lines - 1, CF&#39;: 1 == last batch</span>
    <span class="ruby-identifier">rloop</span>           <span class="ruby-identifier">exx</span>
    <span class="ruby-identifier">loop0</span>           <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># lo</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">cols</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">cols_a</span>        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>       <span class="ruby-comment"># self-modified code</span>
      <span class="ruby-identifier">cols_p</span>        <span class="ruby-identifier">cols_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">cloop</span>           <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">de</span>]
    <span class="ruby-identifier">fx_a</span>            <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">call</span> [<span class="ruby-identifier">hl</span>]    <span class="ruby-comment"># or, xor, and</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">de</span>], <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">cloop</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rloop</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: remaining lines</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop8</span>  <span class="ruby-comment"># b: 8, CF: 0</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># b: remaining lines, CF: 1</span>

    <span class="ruby-identifier">loop8</span>           <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining lines, CF&#39;: 1 == last batch</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># lo</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: lo + 0x20</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c: lo</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_ooscr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x08</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># d: adjusted</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">loop0</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
      <span class="ruby-identifier">check_ooscr</span>   <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_copy_attrs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_copy_attrs</span><span
            class="method-args">(attrs=hl, rows=a, cols=c, screen:nil, copy_back: false, scraddr:nil, subroutine:false, **opts)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies rows of attribute data to (or from) the screen forming a rectangle on the screen.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>attrs</code>
<dd>
<p>A direct or indirect address of attribute rows as a label, an integer or a 16-bit register <code>hl</code> or <code>de</code> depending on the <code>copy_back</code> option.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rows</code>
<dd>
<p>A number of attribute rows to be copied as an 8-bit register or a label or a pointer. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of attribute columns to be copied as an 8-bit register or a label or a pointer. If an accumulator (<code>a</code>) is given to <code>cols</code> then the value is expected in <code>a&#39;</code>. The number 0 is treated as 65536 and will lead to UNDEFINED BEHAVIOUR, clobbering the whole memory in the process.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Unless <code>cols</code> is one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code> the routine uses self modifying code.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>screen</code>
<dd>
<p>A direct or indirect address of the screen attributes memory where the rows of the</p>
</dd></dl>

<pre>attributes will be copied to (or from), as a label, an integer or a 16-bit register +de+ or
+hl+, depending on the +copy_back+ option. The starting address of the entire screen
memory must be a multiple of 0x2000. If this option is +nil+, an appropriate 16-bit register
pair is chosen based on the +copy_back+ option.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>copy_back</code>
<dd>
<p>A boolean indicating whether to copy attributes from the screen (<code>true</code>) or to</p>
</dd></dl>

<pre>the screen (+false+).</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional entire screen memory address which must be a multiple of 0x2000 as</p>
</dd></dl>

<pre>an integer or an immediate label. If provided, the routine breaks execution when the bottom
of the screen has been reached. +CF+ = 0 (NC) is signalled if the routine terminates prematurely
due to reaching the bottom of the screen. Otherwise +CF+ = 1 if all the attributes has been copied.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>A boolean indicating whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>de</code>, <code>hl</code>. Swaps registers unless out of screen.</p>
          
          

          
          <div class="method-source-code" id="bobs_copy_attrs-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 365</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_copy_attrs</span>(<span class="ruby-identifier">attrs</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">rows</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">screen:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">copy_back:</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span>
                                                              <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">scraddr</span>) <span class="ruby-keyword">or</span>
                                  (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>))
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">copy_back</span>
    <span class="ruby-identifier">target</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:target</span>) <span class="ruby-comment"># legacy option</span>
    <span class="ruby-identifier">screen</span> = <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">screen</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">screen</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: screen should be an address, a 16-bit register pair or nil&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">attrs</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">attrs</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: attrs should be an address or a 16-bit register pair&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">rows</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">rows</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: rows should be an integer, a label or a pointer or a register&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">cols</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: cols should be an integer, a label or a pointer or a register&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: invalid option used&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">attrs_tt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">attrs</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">attrs</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">attrs_tt</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: invalid attrs register used&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">scrhi</span>, <span class="ruby-identifier">scrlo</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
    <span class="ruby-identifier">hl</span> <span class="ruby-comment"># source</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">de</span> <span class="ruby-comment"># target</span>
  <span class="ruby-keyword">end</span>.<span class="ruby-identifier">split</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">screen</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">!=</span> (<span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs: invalid screen register used&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">screen</span> = <span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">cols_p</span>], <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">33</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># 32 - cols</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: rows</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">attrs_tt</span>, <span class="ruby-identifier">attrs</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attrs</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">attrs_tt</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span>, <span class="ruby-identifier">screen</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span>)

                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">start0</span>

    <span class="ruby-identifier">rowloop</span>         <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span> <span class="ruby-comment"># 32 - cols</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">adda_to</span> <span class="ruby-identifier">scrhi</span>, <span class="ruby-identifier">scrlo</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scraddr</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x1B</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">NC</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">start0</span>          <span class="ruby-identifier">label</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">cols_a</span>        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">0</span> <span class="ruby-comment"># self-modified code</span>
      <span class="ruby-identifier">cols_p</span>        <span class="ruby-identifier">cols_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ldir</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rowloop</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_copy_attrs_fast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_copy_attrs_fast</span><span
            class="method-args">(attrs, rows=a, cols=32, screen:hl, copy_back:false, disable_intr:true, enable_intr:true, save_sp:true, check_oos:false, subroutine:false, **opts)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies rows of attribute data to (or from) the screen forming a rectangle on the screen using unrolled POP (or PUSH) instructions.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Interrupts must be disabled prior to calling this routine or the <code>disable_intr</code> option must be set to <code>true</code>.</p>
</dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt><code>attrs</code>
<dd>
<p>An address of attributes to be copied from as a label, pointer, an integer or one of the registers: <code>ix</code>, <code>iy</code> or <code>sp</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rows</code>
<dd>
<p>A number of attribute rows to be copied as an 8-bit register or a label, pointer or an integer. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of attribute columns to be copied as an integer.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>screen</code>
<dd>
<p>A direct or indirect address of the screen attributes memory where the attribute rows</p>
</dd></dl>

<pre>will be copied to (or from), as a label, an integer or a 16-bit register +hl+.
The starting address of the entire screen memory must be a multiple of 0x2000.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>disable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should disable interrupts. Provide <code>false</code></p>
</dd></dl>

<pre>only if interrupts are disabled prior to entering this routine.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>enable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should enable interrupts. Provide <code>false</code></p>
</dd></dl>

<pre>if more uninterrupted actions need to performed after this routine completes execution.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>save_sp</code>
<dd>
<p>A boolean flag indicating that the <code>sp</code> register should be saved and restored. Otherwise <code>sp</code> will point behind the end of the last source row.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>check_oos</code>
<dd>
<p>If <code>true</code> reduces number of rows if the bottom of the screen would have been exceeded.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>A boolean indicating whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>If <code>attrs</code> is a direct address, it can be later changed  at run time by storing a new bitmap address at the <code>attrs_p</code> sub-label.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Restoring <code>sp</code> register uses self-modifying code.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>bc</code>, <code>de</code>, <code>hl</code>, optionally: <code>sp</code>.</p>
          
          

          
          <div class="method-source-code" id="bobs_copy_attrs_fast-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 777</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_copy_attrs_fast</span>(<span class="ruby-identifier">attrs</span>, <span class="ruby-identifier">rows</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">32</span>, <span class="ruby-value">screen:</span><span class="ruby-identifier">hl</span>, <span class="ruby-value">copy_back:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">disable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">enable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">save_sp:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">check_oos:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>)
  <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>, <span class="ruby-value">:padded</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">copy_back</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: copy_back should be a boolean or :padded&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">copy_back</span>
    <span class="ruby-identifier">target</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:target</span>) <span class="ruby-comment"># legacy option</span>
    <span class="ruby-identifier">screen</span> = <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: screen should be an address or a pointer or hl&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span>
                                                                                                <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">screen</span>)
  <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">sp</span>,<span class="ruby-identifier">ix</span>,<span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">attrs</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">attrs</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: attrs should be an address or a pointer or ix/iy/sp&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">rows</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">rows</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">rows</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: rows should be an integer or a label or a pointer or a register&quot;</span> 
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: disable_intr should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">disable_intr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: enable_intr should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">enable_intr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: save_sp should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">save_sp</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: save_sp makes no sense if bitmap = sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">save_sp</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: check_oos should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">check_oos</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: subroutine requires save_sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_attrs_fast: interrupts should be disabled if bitmap = sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">disable_intr</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">check_oos</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">rows</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">rows</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">c</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>         <span class="ruby-comment"># llllllll</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">h</span>            <span class="ruby-comment"># xxxxxxxx</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11100000</span>   <span class="ruby-comment"># xxx00000</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">h</span>            <span class="ruby-comment"># lllhhhhh</span>
                    <span class="ruby-value">3</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rlca</span> }  <span class="ruby-comment"># hhhhhlll</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">0xC0</span>
                    <span class="ruby-identifier">cp</span>   <span class="ruby-identifier">c</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">skip_rows</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x28</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">c</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">skip_rows</span>
                    <span class="ruby-identifier">cpl</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">c</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-identifier">skip_rows</span>     <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">rows</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rows</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># check_oos</span>
    <span class="ruby-identifier">next_attr_line</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">32</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
            <span class="ruby-identifier">proc</span> {  <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">hl</span> }
      <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">proc</span> {  <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span> }
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># cols != 32</span>
            <span class="ruby-identifier">proc</span> {  <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bc</span> }
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># cols == 32</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">bc</span>, <span class="ruby-operator">-</span>(<span class="ruby-value">33</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">cols</span>)
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">bc</span>, <span class="ruby-value">33</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">cols</span>
    <span class="ruby-keyword">end</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-value">32</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">screen</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">restore_sp_p</span>], <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
                    <span class="ruby-identifier">di</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">disable_intr</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">attrs</span>)
      <span class="ruby-identifier">attrs_a</span>       <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">attrs</span>
      <span class="ruby-identifier">attrs_p</span>       <span class="ruby-identifier">as</span>   <span class="ruby-identifier">attrs_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">attrs</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attrs</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">start0</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">even?</span>
      <span class="ruby-identifier">rowloop</span>       <span class="ruby-identifier">label</span>
                    <span class="ruby-identifier">next_attr_line</span>.<span class="ruby-identifier">call</span>
      <span class="ruby-identifier">start0</span>        <span class="ruby-identifier">label</span>
      ((<span class="ruby-identifier">cols</span><span class="ruby-value">-2</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">rowloop</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># cols.odd?</span>
      <span class="ruby-identifier">evenloop</span>      <span class="ruby-identifier">label</span>
                    <span class="ruby-identifier">next_attr_line</span>.<span class="ruby-identifier">call</span>
      <span class="ruby-identifier">start0</span>        <span class="ruby-identifier">label</span>
      ((<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># times</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span> <span class="ruby-operator">==</span> <span class="ruby-value">:padded</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">oddloop</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span> <span class="ruby-comment"># last push with clobber</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">quit</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">Z</span>, <span class="ruby-identifier">quit</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-identifier">oddloop</span>       <span class="ruby-identifier">label</span>
                    <span class="ruby-identifier">next_attr_line</span>.<span class="ruby-identifier">call</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      ((<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># times</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">evenloop</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># cols.even?</span>
    <span class="ruby-identifier">quit</span>            <span class="ruby-identifier">label</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
      <span class="ruby-identifier">restore_sp</span>    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">sp</span>, <span class="ruby-value">0</span>
      <span class="ruby-identifier">restore_sp_p</span>  <span class="ruby-identifier">as</span>  <span class="ruby-identifier">restore_sp</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_intr</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_copy_pixels" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_copy_pixels</span><span
            class="method-args">(bitmap=hl, lines=a, cols=c, screen:nil, copy_back:false, scraddr:nil, subroutine:false, **opts)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies bitmap pixel lines to (or from) the ink/paper screen as a rectangle of pixels.</p>

<p>No pixel shifting is performed on a bitmap.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>bitmap</code>
<dd>
<p>A direct or indirect address of a bitmap data containing the pixel lines as a label, an integer or a 16-bit register <code>hl</code> or <code>de</code> depending on the <code>copy_back</code> option.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be copied as an 8-bit register or a label or a pointer. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of 8 pixel columns to be copied as an 8-bit register or a label or a pointer. If an accumulator (<code>a</code>) is given to <code>cols</code> then the value is expected in <code>a&#39;</code>. The number 0 is treated as 65536 and will lead to UNDEFINED BEHAVIOUR, clobbering the whole memory in the process.</p>
</dd></dl>
</li></ul>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Unless <code>cols</code> is one of: <code>ixh</code>, <code>ixl</code>, <code>iyh</code> or <code>iyl</code> the routine uses self modifying code.</p>
</dd></dl>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>screen</code>
<dd>
<p>A direct or indirect address of the screen memory where the lines of the bitmap will</p>
</dd></dl>

<pre>be copied to (or from), as a label, an integer or a 16-bit register +de+ or +hl+ depending on
the +copy_back+ option. The starting address of the entire screen memory must be a multiple
of 0x2000. If this option is +nil+, an appropriate 16-bit register pair is chosen based on the
+copy_back+ option.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>copy_back</code>
<dd>
<p>A boolean indicating whether to copy pixel data from the screen (<code>true</code>) or to</p>
</dd></dl>

<pre>the screen (+false+).</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional entire screen memory address which must be a multiple of 0x2000 as</p>
</dd></dl>

<pre>an integer or an immediate label. If provided the routine breaks execution when the bottom
of the screen has been reached. +CF+ = 0 (NC) is signalled if the routine terminates prematurely
due to reaching the bottom of the screen. Otherwise +CF+ = 1 if the whole bitmap has been copied.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>A boolean indicating whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>The 16-bit registers that can be used for a <code>bitmap</code> argument and a <code>screen</code> option:</p>

<pre>copy_back    bitmap  screen
   false       hl      de
   true        de      hl</pre>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>de</code>, <code>hl</code>. Swaps registers unless out of screen.</p>
          
          

          
          <div class="method-source-code" id="bobs_copy_pixels-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 79</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_copy_pixels</span>(<span class="ruby-identifier">bitmap</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">c</span>, <span class="ruby-value">screen:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">copy_back:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span>
                                                              <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">scraddr</span>) <span class="ruby-keyword">or</span>
                                  (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>))
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">copy_back</span>
    <span class="ruby-identifier">target</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:target</span>) <span class="ruby-comment"># legacy option</span>
    <span class="ruby-identifier">screen</span> = <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: invalid option used&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">screen</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">screen</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: screen should be an address, a 16-bit register pair or nil&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">bitmap</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">bitmap</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: bitmap should be an address or a 16-bit register pair&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: lines should be an integer, a label or a pointer or a register&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">cols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">cols</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: cols should be an integer, a label or a pointer or a register&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">bitmap_tt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">de</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">bitmap</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">bitmap_tt</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: invalid bitmap register used&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">scrhi</span>, <span class="ruby-identifier">scrlo</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
    <span class="ruby-identifier">hl</span> <span class="ruby-comment"># source</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">de</span> <span class="ruby-comment"># target</span>
  <span class="ruby-keyword">end</span>.<span class="ruby-identifier">split</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">screen</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">!=</span> (<span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels: invalid screen register used&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">screen</span> = <span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">screen</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: total lines</span>
    <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">cols_p</span>], <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">0</span>       <span class="ruby-comment"># ldir counter msb</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span>, <span class="ruby-identifier">screen</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">bitmap_tt</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">bitmap_tt</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">screen</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">screen</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">scrlo</span>   <span class="ruby-comment"># screen.lo</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">screen</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">scrhi</span>   <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">scrhi</span>      <span class="ruby-comment"># (h &amp; 0b11111000) - h % 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># 8 - h % 8</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter: 8 - h % 8</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">scrlo</span>   <span class="ruby-comment"># screen.lo</span>
                    <span class="ruby-identifier">exx</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: total lines, a&#39;: screen.lo</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c: total lines</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: total lines - 1 (remaining lines)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: remaining lines - counter</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">start</span>  <span class="ruby-comment"># first batch last?</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = lines (last batch)</span>

    <span class="ruby-identifier">start</span>           <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining rows - 1; CF&#39;: 1 == last batch, a: screen.lo</span>
    <span class="ruby-identifier">rloop</span>           <span class="ruby-identifier">exx</span>
    <span class="ruby-identifier">loop0</span>           <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">scrlo</span>, <span class="ruby-identifier">a</span>   <span class="ruby-comment"># restore screen.lo</span>
    <span class="ruby-identifier">loop1</span>           <span class="ruby-identifier">label</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">ixh</span>,<span class="ruby-identifier">ixl</span>,<span class="ruby-identifier">iyh</span>,<span class="ruby-identifier">iyl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">cols_a</span>        <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">0</span>       <span class="ruby-comment"># self-modified code</span>
      <span class="ruby-identifier">cols_p</span>        <span class="ruby-identifier">cols_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ldir</span>            <span class="ruby-comment"># copy line</span>
                    <span class="ruby-identifier">dec</span> <span class="ruby-identifier">scrhi</span><span class="ruby-operator">|</span><span class="ruby-identifier">scrlo</span> <span class="ruby-comment"># backup screen address, so it points to the last column (1/3rd screen overflow correction)</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">scrhi</span>      <span class="ruby-comment"># next screen line</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rloop</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: remaining lines, a&#39;: screen.lo</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>                   <span class="ruby-comment"># CF=1 if this was the last batch</span>
                    <span class="ruby-identifier">ret</span>  <span class="ruby-constant">C</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">eoc</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span>       <span class="ruby-comment"># b: counter = 8 lines (next row)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># remaining lines - counter</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop8</span>  <span class="ruby-comment"># next batch last?</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># restore remaining lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># b: counter = remaining lines + 1 (last batch)</span>
                    <span class="ruby-comment"># next row address</span>
    <span class="ruby-identifier">loop8</span>           <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: screen.lo, a&#39;: remaining lines + CF</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: screen.lo + 0x20</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">scrlo</span>, <span class="ruby-identifier">a</span>   <span class="ruby-comment"># screen.lo</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">scrhi</span>   <span class="ruby-comment"># screen.hi</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_ooscr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x08</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">scrhi</span>, <span class="ruby-identifier">a</span>   <span class="ruby-comment"># adjusted screen.hi</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">scrlo</span>   <span class="ruby-comment"># screen.lo</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">loop1</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
      <span class="ruby-identifier">check_ooscr</span>   <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">scrlo</span>   <span class="ruby-comment"># screen.lo</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop1</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_copy_pixels_fast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_copy_pixels_fast</span><span
            class="method-args">(bitmap, lines=c, cols=32, screen:hl, copy_back:false, disable_intr:true, enable_intr:true, save_sp:true, scraddr:nil, subroutine:false, **opts)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that copies bitmap pixel lines to (or from) the ink/paper screen as a rectangle of pixels using unrolled POP (or PUSH) instructions.</p>

<p>No pixel shifting is performed on a texture.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Interrupts must be disabled prior to calling this routine or the <code>disable_intr</code> option must be set to <code>true</code>.</p>
</dd></dl>

<p>Copying back bitmap data from screen memory to bitmap memory is performed backwards - from the last byte of memory to the first one.</p>

<p>Note that when copying back bitmap data from the screen while the bitmap byte size is odd (when both <code>cols</code> and <code>lines</code> are odd), and because a single <code>push</code> instruction modifies 2 bytes the first (odd) bitmap byte will remain in the <code>d</code> register and has to be transfered to the beginning of the bitmap outside of this routine, unless <code>copy_back</code> option is <code>:padded</code>. In this instance the last push will be performed modifying an additional pad byte, preceding in memory the very first address of destination bitmap data. In this instance the bitmap data must be padded by a single byte in front of it.</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>bitmap</code>
<dd>
<p>A direct or indirect address of a bitmap data containing the pixel lines as a label,</p>
</dd></dl>

<pre>an integer or a 16-bit register pair: +ix+, +iy+ or +sp+.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be copied as an 8-bit register, a label, pointer or an integer. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of 8 pixel columns to be copied as an integer.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>screen</code>
<dd>
<p>A direct or indirect address of the screen memory where the lines of the bitmap will</p>
</dd></dl>

<pre>be copied to (or from), as a label, an integer or +hl+. The starting address of the entire screen
memory must be a multiple of 0x2000.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>copy_back</code>
<dd>
<p>A boolean indicating whether to copy pixel data from the screen (<code>true</code>) or to the</p>
</dd></dl>

<pre>screen (+false+). If +copy_back+ is +true+, the +bitmap+ and +screen+ must point to the __last__
byte of both the bitmap data and the screen area (bottom - rightmost corner).</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>disable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should disable interrupts. Provide <code>false</code></p>
</dd></dl>

<pre>only if interrupts are disabled prior to entering this routine.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>enable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should enable interrupts. Provide <code>false</code></p>
</dd></dl>

<pre>if more uninterrupted actions need to performed after this routine completes execution.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>save_sp</code>
<dd>
<p>A boolean flag indicating that the <code>sp</code> register should be saved and restored. Otherwise</p>
</dd></dl>

<pre>+sp+ will point behind the end of the last source line (or before the first if +copy_back+ is +true+).</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional entire screen memory address which must be a multiple of 0x2000 as</p>
</dd></dl>

<pre>an integer or an immediate label. If provided the routine breaks execution when the bottom
of the screen has been reached. +CF+ = 0 (NC) is signalled if the routine terminates prematurely
due to reaching the bottom of the screen. Otherwise +CF+ = 1 if the whole bitmap has been copied.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>A boolean indicating whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>If <code>bitmap</code> is a direct address, it can be later changed  at run time by storing a new bitmap address at the <code>bitmap_p</code> sub-label.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Restoring <code>sp</code> register uses self-modifying code.</p>
</dd></dl>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code>, optionally: <code>sp</code>.</p>
          
          

          
          <div class="method-source-code" id="bobs_copy_pixels_fast-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 494</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_copy_pixels_fast</span>(<span class="ruby-identifier">bitmap</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">32</span>, <span class="ruby-value">screen:</span><span class="ruby-identifier">hl</span>, <span class="ruby-value">copy_back:</span><span class="ruby-keyword">false</span>, <span class="ruby-value">disable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">enable_intr:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">save_sp:</span><span class="ruby-keyword">true</span>, <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>, <span class="ruby-operator">**</span><span class="ruby-identifier">opts</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">scraddr</span>) <span class="ruby-keyword">or</span>
                                                    (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>))
  <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>, <span class="ruby-value">:padded</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">copy_back</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: copy_back should be a boolean or :padded&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">copy_back</span>
    <span class="ruby-identifier">target</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:target</span>) <span class="ruby-comment"># legacy option</span>
    <span class="ruby-identifier">screen</span> = <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: screen should be an address or a pointer or hl&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span>
                                                                                                <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">screen</span>)
  <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">sp</span>,<span class="ruby-identifier">ix</span>,<span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bitmap</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">bitmap</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: bitmap should be an address or a pointer or ix/iy/sp&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: lines should be an integer or a label or a pointer or a register&quot;</span> 
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: disable_intr should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">disable_intr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: enable_intr should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">enable_intr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: save_sp should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">save_sp</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: save_sp makes no sense if bitmap = sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">save_sp</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: subroutine requires save_sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_copy_pixels_fast: interrupts should be disabled if bitmap = sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">disable_intr</span>
  <span class="ruby-identifier">fits_single_row</span> = <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
      <span class="ruby-identifier">lines</span> <span class="ruby-operator">&lt;=</span> (<span class="ruby-value">1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">screen</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">lines</span> <span class="ruby-operator">&lt;=</span> (<span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">screen</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">next_row</span> = <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">loop0</span>, <span class="ruby-identifier">quit</span>=<span class="ruby-keyword">nil</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">quit</span> = <span class="ruby-identifier">eoc</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">quit</span>.<span class="ruby-identifier">nil?</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: screen.lo; a: remaining lines - 1; CF: 1 == last batch</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">quit</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># 8</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">not_last</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>

      <span class="ruby-identifier">not_last</span>      <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining lines - 1; CF&#39;: 1 == last batch, a: screen.lo</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: screen.lo - 0x20</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: screen.lo + 0x20</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># l: screen.lo</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_oos</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">c</span>          <span class="ruby-comment"># +8</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">c</span>          <span class="ruby-comment"># -8</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># h: adjusted</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">loop0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">quit</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
        <span class="ruby-identifier">scrhiaddr</span> = (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)
        <span class="ruby-identifier">scrhiaddr</span> = <span class="ruby-identifier">scrhiaddr</span><span class="ruby-operator">|</span><span class="ruby-value">0x18</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">copy_back</span>
        <span class="ruby-identifier">check_oos</span>   <span class="ruby-identifier">cp</span>   <span class="ruby-identifier">scrhiaddr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">loop0</span>
                    <span class="ruby-identifier">ccf</span>  <span class="ruby-comment"># flip C to signal oos</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-identifier">quit</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">quit</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">eoc</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">c</span>          
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">screen</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">screen</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">screen</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">1</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">screen</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span> <span class="ruby-comment"># first row count: [1, 8]</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">8</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">screen</span><span class="ruby-operator">&gt;&gt;</span><span class="ruby-value">8</span>) <span class="ruby-operator">%</span> <span class="ruby-value">8</span> <span class="ruby-comment"># first row count: [1, 8]</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">screen</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">screen</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>       <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b00000111</span> <span class="ruby-comment"># (h &amp; 0b00000111) h % 8</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># (1 + h % 8)</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">h</span>          <span class="ruby-comment"># (h &amp; 0b11111000) - h % 8</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># (8 - h % 8)</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter: (8 - h % 8) or (1 + h % 8)</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># a: lines</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1 (remaining lines)</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines - 1 - counter</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">8</span>
        <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eoc</span><span class="ruby-operator">|</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">eoc</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = dy</span>
          <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">lines</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: remaining lines - 1; CF&#39;: 1 == last batch</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-value">8</span>       <span class="ruby-comment"># constant = 8</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>       <span class="ruby-comment"># a: screen.lo</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">restore_sp_p</span>], <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
                    <span class="ruby-identifier">di</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">disable_intr</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">bitmap</span>)
      <span class="ruby-identifier">bitmap_a</span>      <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">bitmap</span>
      <span class="ruby-identifier">bitmap_p</span>      <span class="ruby-identifier">as</span>   <span class="ruby-identifier">bitmap_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">even?</span>
      <span class="ruby-identifier">rowloop</span>       <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-identifier">loop0</span>         <span class="ruby-identifier">label</span>
      ((<span class="ruby-identifier">cols</span><span class="ruby-value">-2</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># times</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">push</span>  <span class="ruby-identifier">de</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rowloop</span>
                    <span class="ruby-identifier">next_row</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">loop0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># cols.odd?</span>
      <span class="ruby-identifier">evenline</span>      <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-identifier">evenloop</span>      <span class="ruby-identifier">label</span>
      ((<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># times</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">oddline</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span> <span class="ruby-operator">==</span> <span class="ruby-value">:padded</span>
                    <span class="ruby-identifier">next_row</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">oddloop</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span> <span class="ruby-comment"># last push with clobber</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">quit</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">fits_single_row</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">quit</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">next_row</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">oddloop</span>, <span class="ruby-identifier">quit</span>
                    <span class="ruby-comment"># might fall thru here instead of jp oddloop</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-identifier">oddline</span>       <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>
      <span class="ruby-identifier">oddloop</span>       <span class="ruby-identifier">label</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      ((<span class="ruby-identifier">cols</span><span class="ruby-value">-1</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">d</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># times</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">copy_back</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># copy_back</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">evenline</span>
                    <span class="ruby-identifier">next_row</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">evenloop</span>
      <span class="ruby-identifier">quit</span>          <span class="ruby-identifier">label</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># cols.even?|odd?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
      <span class="ruby-identifier">restore_sp</span>    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">sp</span>, <span class="ruby-value">0</span>
      <span class="ruby-identifier">restore_sp_p</span>  <span class="ruby-identifier">as</span>  <span class="ruby-identifier">restore_sp</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_intr</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_draw_pixels_fast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_draw_pixels_fast</span><span
            class="method-args">(bitmap, lines=a, cols=2, target:hl, bshift:b, mode: :set, skip_cols: nil, lclip: false, rclip: false, no0shift: false, tx:ix, disable_intr:true, enable_intr:true, save_sp:true, scraddr:nil, jump_table:nil, subroutine:false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that draws bitmap pixel lines to the ink/paper screen as a rectangle object using unrolled POP instructions.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Interrupts must be disabled prior to calling this routine or the <code>disable_intr</code> option must be set to <code>true</code>.</p>
</dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt><code>bitmap</code>
<dd>
<p>A direct or indirect address of a bitmap data containing the pixel lines as a label, an integer or a 16-bit register pair: <code>hl&#39;</code>, <code>ix</code>, <code>iy</code> or <code>sp</code>. If <code>hl</code> is specified the actual value will be read from alternative register <code>hl&#39;</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of pixel lines to be drawn as an 8-bit register or a label, a pointer or an integer. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of 8 pixel columns to be drawn as an integer from 1 to 32.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>target</code>
<dd>
<p>An address of a screen memory area to be copied to as a label, pointer, an integer or <code>hl</code>. The starting address of the whole screen area must be a multiple of 0x2000.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>bshift</code>
<dd>
<p>One of 8-bit registers: <code>b</code>, <code>c</code>, <code>d</code>, <code>e</code>. The value of the register specifies how many pixels to the right the bitmap must be shifted before drawing the bitmap on the screen. The actual value must be in the range from 0 up to 7. Values outside of the allowed range will resolve in UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>mode</code>
<dd>
<p>Drawing mode, one of: <code>:copy</code>, <code>:set</code>, <code>:or</code>, <code>:xor</code>, <code>:and</code>, <code>:nand</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>skip_cols</code>
<dd>
<p>If set, the number of bitmap 8-bit columns will be skipped after each line is drawn. Set as an address, an integer or an 8-bit register from alternative set, e.g. <code>e</code> specifies <code>e&#39;</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lclip</code>
<dd>
<p>Skips drawing the leftmost screen column for non zero <code>bshift</code> values if enabled.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rclip</code>
<dd>
<p>Skips drawing the rightmost screen column for non zero <code>bshift</code> values if enabled.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>no0shift</code>
<dd>
<p>Skips creating the drawing routine for <code>bshift</code> zero if enabled. Calling such a routine with <code>bshift</code> register holding zero is safe but nothing will be drawn and CF flag will be reset upon return.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>tx</code>
<dd>
<p>A temporary jump address register: <code>ix</code> or <code>iy</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>disable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should disable interrupts. Provide <code>false</code></p>
</dd></dl>

<pre>only if interrupts are disabled prior to entering this routine.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>enable_intr</code>
<dd>
<p>A boolean flag indicating that the routine should enable interrupts. Provide <code>false</code></p>
</dd></dl>

<pre>if more uninterrupted actions need to performed after this routine completes execution.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>save_sp</code>
<dd>
<p>A boolean flag indicating that the <code>sp</code> register should be saved and restored. Otherwise <code>sp</code> will point behind the end of the last source line.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>scraddr</code>
<dd>
<p>An optional entire screen memory address which must be a multiple of 0x2000 as</p>
</dd></dl>

<pre>an integer or an immediate label. If provided the routine breaks execution when the bottom
of the screen has been reached. +CF+ = 0 (NC) is signalled if the routine terminates prematurely
due to reaching the bottom of the screen. Otherwise +CF+ = 1 if the whole bitmap has been drawn.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>jump_table</code>
<dd>
<p>A label, a pointer address or one of <code>de</code>/<code>bc</code>/<code>ix</code>/<code>iy</code> register pairs referencing</p>
</dd></dl>

<pre>an external jump table created with Macros#bobs_draw_pixels_fast_jump_table. If not provided an
internal jump table will be created instead. In this instance a +jump_table+ can be later changed
at run time by storing a new jump table address at the +jump_table_p+ sub-label.</pre>
</li><li><dl class="rdoc-list note-list"><dt><code>subroutine</code>
<dd>
<p>A boolean indicating whether to create a subroutine.</p>
</dd></dl>
</li></ul>

<p>If <code>bitmap</code> is a direct address, it can be later changed  at run time by storing a new bitmap address at the <code>bitmap_p</code> sub-label.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>Restoring <code>sp</code> register uses self-modifying code.</p>
</dd></dl>

<p>Drawing modes:</p>

<pre>Bitmap                 Screen (cols = 2, bshift = 4)
76543210 76543210      76543210 76543210 76543210
                           (original screen data)
  -&gt;&gt;      :copy
  -&gt;&gt;      :set
  -&gt;&gt;      :or
  -&gt;&gt;      :xor
  -&gt;&gt;      :and
  -&gt;&gt;      :nand</pre>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>bc&#39;</code>, <code>de</code>, <code>d&#39;</code>, <code>hl</code>, (<code>hl&#39;</code>, <code>e&#39;</code> if skip_cols is given). Swaps registers unless out of screen.</p>
          
          

          
          <div class="method-source-code" id="bobs_draw_pixels_fast-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 1389</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_draw_pixels_fast</span>(<span class="ruby-identifier">bitmap</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-value">2</span>,
                          <span class="ruby-value">target:</span><span class="ruby-identifier">hl</span>,
                          <span class="ruby-value">bshift:</span><span class="ruby-identifier">b</span>,
                          <span class="ruby-value">mode:</span> <span class="ruby-value">:set</span>,
                          <span class="ruby-value">skip_cols:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-comment"># e</span>
                          <span class="ruby-value">lclip:</span> <span class="ruby-keyword">false</span>,
                          <span class="ruby-value">rclip:</span> <span class="ruby-keyword">false</span>,
                          <span class="ruby-value">no0shift:</span> <span class="ruby-keyword">false</span>,
                          <span class="ruby-value">tx:</span><span class="ruby-identifier">ix</span>,
                          <span class="ruby-value">disable_intr:</span><span class="ruby-keyword">true</span>,
                          <span class="ruby-value">enable_intr:</span><span class="ruby-keyword">true</span>,
                          <span class="ruby-value">save_sp:</span><span class="ruby-keyword">true</span>,
                          <span class="ruby-value">scraddr:</span><span class="ruby-keyword">nil</span>,
                          <span class="ruby-value">jump_table:</span><span class="ruby-keyword">nil</span>,
                          <span class="ruby-value">subroutine:</span><span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: invalid scraddr argument&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span>
                  <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">scraddr</span>) <span class="ruby-keyword">or</span> (<span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">scraddr</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xE000</span>))
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: target should be an address or a pointer or hl&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">target</span>)
  <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">sp</span>,<span class="ruby-identifier">ix</span>,<span class="ruby-identifier">iy</span>,<span class="ruby-identifier">hl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bitmap</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">bitmap</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: bitmap should be an address or a pointer or ix/iy/sp/hl&#39;&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: bitmap should not be the same as jump_table&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">jump_table</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">bit8?</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: lines should be a label or a pointer or an integer or a register&quot;</span> 
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: disable_intr should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">disable_intr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: enable_intr should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">enable_intr</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: save_sp should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">save_sp</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: save_sp makes no sense if bitmap = sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">save_sp</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: subroutine requires save_sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">save_sp</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: interrupts should be disabled if bitmap = sp&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">disable_intr</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: bshift should be one of: b, c, d or e&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">b</span>,<span class="ruby-identifier">c</span>,<span class="ruby-identifier">d</span>,<span class="ruby-identifier">e</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bshift</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: tx should be one of: ix or iy&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-identifier">ix</span>, <span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tx</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: lclip should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">lclip</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: rclip should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rclip</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: no0shift should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">no0shift</span>)
  <span class="ruby-identifier">txh</span>, <span class="ruby-identifier">txl</span> = <span class="ruby-identifier">tx</span>.<span class="ruby-identifier">split</span>
  <span class="ruby-identifier">t</span> = <span class="ruby-identifier">b</span>
  <span class="ruby-identifier">m</span> = <span class="ruby-identifier">c</span>
  <span class="ruby-identifier">fx</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">mode</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:or</span>  <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">ora</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:xor</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">xor</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:and</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">anda</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:nand</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">cpl</span>; <span class="ruby-identifier">anda</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:set</span>, <span class="ruby-value">:copy</span> <span class="ruby-keyword">then</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: mode should be one of: :or, :xor, :and, :set or :copy&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ncols</span> = <span class="ruby-identifier">skip_cols</span>
  <span class="ruby-identifier">skip_cols</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">ncols</span> <span class="ruby-comment"># modifies: hl, sp (e: skip)</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">0</span> <span class="ruby-keyword">then</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Integer</span> <span class="ruby-keyword">then</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">ncols</span>) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">ncols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">ncols</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ncols</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: skip_cols should be one of: nil, an integer, an address or an 8-bit alt register except an accumulator&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ncols</span>
  <span class="ruby-identifier">local_jump_table</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">jump_table</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">elsif</span> [<span class="ruby-identifier">de</span>, <span class="ruby-identifier">bc</span>, <span class="ruby-identifier">ix</span>, <span class="ruby-identifier">iy</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">jump_table</span>)
    <span class="ruby-identifier">jh</span>, <span class="ruby-identifier">jl</span> = <span class="ruby-identifier">jump_table</span>.<span class="ruby-identifier">split</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">jh</span>, <span class="ruby-identifier">jl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-keyword">or</span> [<span class="ruby-identifier">jh</span>, <span class="ruby-identifier">jl</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bshift</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: lines, bshift and jump_table should use different registers&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;bobs_draw_pixels_fast: jump_table is not a label&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">label?</span>(<span class="ruby-identifier">jump_table</span>)
    <span class="ruby-identifier">jump_table</span> = <span class="ruby-identifier">unwrap_pointer</span>(<span class="ruby-identifier">jump_table</span>).<span class="ruby-identifier">to_label</span>(<span class="ruby-keyword">self</span>) <span class="ruby-comment"># in case a symbol was given</span>
    <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">jump_table</span> = <span class="ruby-identifier">define_label</span>(<span class="ruby-value">:jump_table</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_jump_table</span> <span class="ruby-comment"># normalize in isolated ns</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: lines</span>

                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
    <span class="ruby-comment"># calculate 1st row counter and remaining lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>       <span class="ruby-comment"># calculate counter based on screen address modulo 8</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-value">0b11111000</span> <span class="ruby-comment"># (h &amp; 0b11111000)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">h</span>          <span class="ruby-comment"># = - h % 8  [-7, 0]</span>
                    <span class="ruby-identifier">exx</span>             <span class="ruby-comment"># regs&#39;</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_cols</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">ncols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">ncols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ncols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, <span class="ruby-value">8</span>       <span class="ruby-comment"># d: 8 (const)</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">d</span>          <span class="ruby-comment"># = 8 - h % 8  [1, 8]</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: counter = 8 - h % 8  [1, 8]</span>

                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: lines, a&#39;: ...</span>

                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c: lines</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">a</span>          <span class="ruby-comment"># a: lines - 1</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines - 1 - counter</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">more_rows</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># b: counter = c: lines</span>
      <span class="ruby-identifier">more_rows</span>     <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: lines left - 1, CF&#39;: last row?</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_cols</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">ncols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">ncols</span>)
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">ncols</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># calculate routine address in jump_table from bshift</span>
                    <span class="ruby-identifier">exx</span>             <span class="ruby-comment"># regs</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">bshift</span>  <span class="ruby-comment"># rshift</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">a</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># a: rshift * 2</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">bshift</span>     <span class="ruby-comment"># a: rshift * 3</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">register?</span>(<span class="ruby-identifier">jump_table</span>)
                    <span class="ruby-identifier">ld16</span> <span class="ruby-identifier">de</span>, <span class="ruby-identifier">jump_table</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">jump_table</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
    <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">jump_table_a</span>    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">jump_table</span>
    <span class="ruby-identifier">jump_table_p</span>    <span class="ruby-identifier">jump_table_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">jump_table</span>.<span class="ruby-identifier">pointer?</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># de: -&gt;routine</span>
    <span class="ruby-comment"># get routine address (tx) and bshift mask (m)</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-identifier">sp</span>, <span class="ruby-identifier">tx</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">bitmap</span>)    <span class="ruby-comment"># bitmap already in sp or from tx, can&#39;t use it for jump_table</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">restore_sp_p</span>], <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
                    <span class="ruby-identifier">di</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">disable_intr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sp</span>

                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">de</span>]    <span class="ruby-comment"># a: routine.loop0.lo</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">txl</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">de</span>]    <span class="ruby-comment"># a: routine.loop0.hi</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">txh</span>, <span class="ruby-identifier">a</span>     <span class="ruby-comment"># tx: routine.loop0</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">de</span>]    <span class="ruby-comment"># a: mask</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">m</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># m: mask</span>

                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>       <span class="ruby-comment"># a: screen.lo</span>
                    <span class="ruby-identifier">exx</span>             <span class="ruby-comment"># regs&#39;</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>     <span class="ruby-comment"># hl: jump[], de: screen</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">restore_sp_p</span>], <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
                    <span class="ruby-identifier">di</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">disable_intr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">hl</span>     <span class="ruby-comment"># sp: jump[]</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">hl</span>     <span class="ruby-comment"># hl: screen</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">tx</span>         <span class="ruby-comment"># tx: routine.loop0</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">t</span><span class="ruby-operator">|</span><span class="ruby-identifier">m</span>        <span class="ruby-comment"># m: mask</span>

                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">l</span>       <span class="ruby-comment"># a: screen.lo</span>
                    <span class="ruby-identifier">exx</span>             <span class="ruby-comment"># regs&#39;</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">direct_address?</span>(<span class="ruby-identifier">bitmap</span>)
        <span class="ruby-identifier">bitmap_a</span>    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-comment"># bitmap: address</span>
        <span class="ruby-identifier">bitmap_p</span>    <span class="ruby-identifier">as</span>   <span class="ruby-identifier">bitmap_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-comment"># bitmap: ix/iy/hl&#39; or indirect address (tx != bitmap)</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c&#39;: screen.lo</span>
                    <span class="ruby-identifier">exx</span>             <span class="ruby-comment"># regs</span>
    <span class="ruby-comment"># hl: screen, m: mask, c&#39;: screen lo, b&#39;: counter</span>
    <span class="ruby-comment"># d&#39;: const 8, a&#39;: lines left - 1, CF&#39;: last row</span>
                    <span class="ruby-identifier">jp</span>   (<span class="ruby-identifier">tx</span>)       <span class="ruby-comment"># pc: tx: routine.loop0</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_jump_table</span>
      <span class="ruby-identifier">jump_table</span>    <span class="ruby-identifier">bobs_draw_pixels_fast_jump_table</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment">###########################</span>
    <span class="ruby-comment">##    bshift routines    ##</span>
    <span class="ruby-comment">###########################</span>
    <span class="ruby-identifier">no0shift</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">no0shift</span>
      <span class="ruby-identifier">quit</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">bobs_draw_pixels_fast_routines</span>(<span class="ruby-identifier">next_row</span>, <span class="ruby-identifier">cols</span>,
                                   <span class="ruby-value">mode:</span><span class="ruby-identifier">mode</span>,
                                   <span class="ruby-value">skip_cols:</span><span class="ruby-identifier">ncols</span>,
                                   <span class="ruby-value">lclip:</span><span class="ruby-identifier">lclip</span>,
                                   <span class="ruby-value">rclip:</span><span class="ruby-identifier">rclip</span>,
                                   <span class="ruby-value">no0shift:</span> <span class="ruby-identifier">no0shift</span>,
                                   <span class="ruby-value">merge:</span> <span class="ruby-keyword">true</span>,
                                   <span class="ruby-value">jump_eoc:</span> <span class="ruby-keyword">false</span>)
    <span class="ruby-comment">################################################</span>
    <span class="ruby-comment">##                  next row                  ##</span>
    <span class="ruby-comment">################################################</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-value">:next_row</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># check remaining lines and set up line counter for the next row</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a: lines left - 1, CF: last row?</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">quit</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">d</span>       <span class="ruby-comment"># b: 8 (counter)</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines left - 1 - 8</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">not_last</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># a: lines left - 1, CF: 1</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># b: lines left - 1</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">b</span>          <span class="ruby-comment"># b: lines left (counter)</span>
      <span class="ruby-identifier">not_last</span>      <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>     <span class="ruby-comment"># a&#39;: lines left - 1, CF&#39;: last row?</span>
    <span class="ruby-comment"># calculate next row screen address</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>       <span class="ruby-comment"># a: screen.lo</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-value">0x20</span>       <span class="ruby-comment"># a: screen.lo + 0x20</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># c&#39;: next row (screen.lo)</span>
                    <span class="ruby-identifier">exx</span>             <span class="ruby-comment"># regs</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># l: next row (screen.lo)</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">loop0fw</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">h</span>       <span class="ruby-comment"># a: sreen.hi</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">C</span>, <span class="ruby-identifier">check_oos</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
                    <span class="ruby-identifier">sub</span>  <span class="ruby-value">8</span>          <span class="ruby-comment"># a: sreen.hi - 8</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-identifier">a</span>       <span class="ruby-comment"># h: adjusted sreen.hi</span>
      <span class="ruby-identifier">loop0fw</span>       <span class="ruby-identifier">jp</span>   (<span class="ruby-identifier">tx</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">scraddr</span>
        <span class="ruby-identifier">check_oos</span>   <span class="ruby-identifier">cp</span>   (<span class="ruby-identifier">scraddr</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">8</span>)<span class="ruby-operator">|</span><span class="ruby-value">0x18</span>
        <span class="ruby-identifier">check_oos_p</span> <span class="ruby-identifier">check_oos</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">quit</span>
                    <span class="ruby-identifier">jp</span>   (<span class="ruby-identifier">tx</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">quit</span>            <span class="ruby-identifier">label</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">save_sp</span>
      <span class="ruby-identifier">restore_sp</span>    <span class="ruby-identifier">ld</span>  <span class="ruby-identifier">sp</span>, <span class="ruby-value">0</span>
      <span class="ruby-identifier">restore_sp_p</span>  <span class="ruby-identifier">as</span>  <span class="ruby-identifier">restore_sp</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ei</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">enable_intr</span>
                    <span class="ruby-identifier">ret</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">subroutine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_draw_pixels_fast_jump_table" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_draw_pixels_fast_jump_table</span><span
            class="method-args">(draw_pixels_fast_label)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a jump table for the <a href="Macros.html#method-i-bobs_draw_pixels_fast"><code>Macros#bobs_draw_pixels_fast</code></a> routine.</p>

<p>Provide a label (or a symbol) referencing a routine created by either <a href="Macros.html#method-i-bobs_draw_pixels_fast"><code>Macros#bobs_draw_pixels_fast</code></a> or <a href="Macros.html#method-i-bobs_draw_pixels_fast_routines"><code>Macros#bobs_draw_pixels_fast_routines</code></a>.</p>

<p>Returns a label addressing the created jump table.</p>

<p>Provide an address of a jump table as a <code>jump_table:</code> option to <code>bobs_draw_pixels_fast</code>.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p>The jump table must be aligned in memory so it does not cross 256-byte address pages. In other words, the high 8 bits of addresses of each jump table byte must be the same. Otherwise an error will be raised when trying to instanciate code.</p>
</dd></dl>

<p>The jump table occupies 24 bytes of code.</p>

<p>The content is lazy evaluated so the order of creating a table and a routine doesn&#39;t matter.</p>
          
          

          
          <div class="method-source-code" id="bobs_draw_pixels_fast_jump_table-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 1064</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_draw_pixels_fast_jump_table</span>(<span class="ruby-identifier">draw_pixels_fast_label</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">draw_pixels_fast_label</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;draw_pixels_fast_label must be a label&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">draw_pixels_fast_label</span>)
    <span class="ruby-identifier">draw_pixels_fast_label</span> = <span class="ruby-identifier">draw_pixels_fast_label</span>.<span class="ruby-identifier">to_label</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ns</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">size</span> = <span class="ruby-value">8</span><span class="ruby-operator">*</span><span class="ruby-value">3</span><span class="ruby-value">-1</span> <span class="ruby-comment"># correction, jump_table may reside on the far end of the page</span>
    <span class="ruby-identifier">select</span>((<span class="ruby-identifier">label</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">size</span>) <span class="ruby-operator">&amp;</span> <span class="ruby-value">0xFF</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">size</span> }.<span class="ruby-identifier">else</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;jump_table data must fit on a single 256-byte page of memory&quot;</span>
    <span class="ruby-keyword">end</span>
    (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">7</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">line_rshiftN</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">draw_pixels_fast_label</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">define_label</span> <span class="ruby-value">:&quot;line_rshift#{index}&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">draw_pixels_fast_label</span>.<span class="ruby-identifier">send</span> <span class="ruby-value">:&quot;line_rshift#{index}&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">define_label</span> <span class="ruby-value">:&quot;jump#{index}&quot;</span>,  <span class="ruby-identifier">dw</span>( <span class="ruby-identifier">line_rshiftN</span>.<span class="ruby-identifier">loop0</span> )
      <span class="ruby-identifier">define_label</span> <span class="ruby-value">:&quot;mask#{index}&quot;</span>,  <span class="ruby-identifier">db</span>( <span class="ruby-value">0xff</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-identifier">index</span> )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_draw_pixels_fast_routines" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_draw_pixels_fast_routines</span><span
            class="method-args">(next_row, cols, mode: :set, skip_cols: nil, lclip: false, rclip: false, no0shift: nil, merge: false, jump_eoc: true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates specialized routines for <a href="Macros.html#method-i-bobs_draw_pixels_fast"><code>Macros#bobs_draw_pixels_fast</code></a> that can be used externally via jump table.</p>
<dl class="rdoc-list note-list"><dt><em>NOTE</em>
<dd>
<p><code>skip_cols</code> option should match <code>skip_cols</code> given to <a href="Macros.html#method-i-bobs_draw_pixels_fast"><code>Macros#bobs_draw_pixels_fast</code></a> if an 8-bit register (other than <code>e&#39;</code>) or an indirect (a pointer) address is specified.</p>
</dd></dl>
<ul><li><dl class="rdoc-list note-list"><dt><code>next_row</code>
<dd>
<p>An address of <code>next_row</code> routine. Usually: <code>draw_pixels_fast_label.next_row</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A constant number of 8 pixel columns to be drawn as an integer from 1 to 32.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>mode</code>
<dd>
<p>Drawing mode, one of: <code>:copy</code>, <code>:set</code>, <code>:or</code>, <code>:xor</code>, <code>:and</code>, <code>:nand</code>. See <a href="Macros.html#method-i-bobs_draw_pixels_fast"><code>Macros#bobs_draw_pixels_fast</code></a>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>skip_cols</code>
<dd>
<p>If set, the number of bitmap 8-bit columns will be skipped after each line is drawn. Set as an address, an integer or an 8-bit register from alternative set, e.g. <code>e</code> specifies <code>e&#39;</code>. Also see the note above.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lclip</code>
<dd>
<p>Skips drawing the leftmost screen column for non zero <code>bshift</code> values if enabled.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>rclip</code>
<dd>
<p>Skips drawing the rightmost screen column for non zero <code>bshift</code> values if enabled.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>no0shift</code>
<dd>
<p>If this option is not <code>nil</code> skips creating the drawing routine for <code>bshift</code> equal</p>
</dd></dl>

<p>to 0. Provide a label to <code>draw_pixels_fast_label.quit</code> or to an existing implementation, e.g.: <code>draw_pixels_fast_routines.line_rshift0.loop0</code>. Calling such a routine with <code>bshift</code> register holding zero is safe but nothing will be drawn and CF flag will be reset upon return if <code>quit</code> was provided.</p>
</li><li><dl class="rdoc-list note-list"><dt><code>merge</code>
<dd>
<p>Whether the <code>line_rshift{0-7}</code> labels should be merged with the current context.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>jump_eoc</code>
<dd>
<p>Whether the <code>jp next_row</code> should be appended at the end of the generated code.</p>
</dd></dl>
</li></ul>
          
          

          
          <div class="method-source-code" id="bobs_draw_pixels_fast_routines-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 1110</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_draw_pixels_fast_routines</span>(<span class="ruby-identifier">next_row</span>, <span class="ruby-identifier">cols</span>,
                                   <span class="ruby-value">mode:</span> <span class="ruby-value">:set</span>,
                                   <span class="ruby-value">skip_cols:</span> <span class="ruby-keyword">nil</span>,
                                   <span class="ruby-value">lclip:</span> <span class="ruby-keyword">false</span>,
                                   <span class="ruby-value">rclip:</span> <span class="ruby-keyword">false</span>,
                                   <span class="ruby-value">no0shift:</span> <span class="ruby-keyword">nil</span>,
                                   <span class="ruby-value">merge:</span> <span class="ruby-keyword">false</span>,
                                   <span class="ruby-value">jump_eoc:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">throw</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;next_row must be a label&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">next_row</span>)
  <span class="ruby-identifier">cols</span> = <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be less than or equal to 32&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">32</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;cols must be greater than or equal to 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;lclip should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">lclip</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;rclip should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rclip</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;merge should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">merge</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;jump_eoc should be a boolean&quot;</span> <span class="ruby-keyword">unless</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">jump_eoc</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;no0shift should be a nil or a label (quit)&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">no0shift</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span>
                                                                      <span class="ruby-identifier">direct_label?</span>(<span class="ruby-identifier">no0shift</span>)
  <span class="ruby-identifier">next_row</span> = <span class="ruby-identifier">next_row</span>.<span class="ruby-identifier">to_label</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-identifier">t</span> = <span class="ruby-identifier">b</span>
  <span class="ruby-identifier">m</span> = <span class="ruby-identifier">c</span>
  <span class="ruby-identifier">fx</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">mode</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:or</span>   <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">ora</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:xor</span>  <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">xor</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:and</span>  <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">anda</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:nand</span> <span class="ruby-keyword">then</span> <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">tgt</span>) { <span class="ruby-identifier">cpl</span>; <span class="ruby-identifier">anda</span> <span class="ruby-identifier">tgt</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-value">:set</span>, <span class="ruby-value">:copy</span> <span class="ruby-keyword">then</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;mode should be one of: :or, :xor, :and, :set or :copy&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">skip_cols</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">label_immediate?</span>(<span class="ruby-identifier">skip_cols</span>)
    <span class="ruby-identifier">ncols</span> = <span class="ruby-identifier">skip_cols</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">ncols</span> = <span class="ruby-identifier">skip_cols</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;skip_cols must not be negative&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">ncols</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ncols</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">skip_cols</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">ncols</span> <span class="ruby-comment"># modifies: hl, sp (e: skip)</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">0</span> <span class="ruby-keyword">then</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">5</span>
      <span class="ruby-identifier">n</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">ncols</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">ncols</span> <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span>
        (<span class="ruby-identifier">n</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">pop</span> <span class="ruby-identifier">hl</span> }
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">sp</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">odd?</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">ncols</span>) <span class="ruby-keyword">or</span> (<span class="ruby-identifier">register?</span>(<span class="ruby-identifier">ncols</span>) <span class="ruby-keyword">and</span> <span class="ruby-identifier">ncols</span>.<span class="ruby-identifier">bit8?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">ncols</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">a</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;skip_cols should be one of: nil, an integer, an address or an 8-bit alt register except an accumulator&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">ncols</span>) <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">ncols</span>)
          <span class="ruby-keyword">if</span> <span class="ruby-constant">Integer</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">ncols</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">ncols</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">ncols</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">h</span>, <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">add</span>  <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">sp</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">sp</span>, <span class="ruby-identifier">hl</span>
      <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ncols</span>
  <span class="ruby-identifier">rotate_bits</span> = <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">rshift</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">4</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rshift</span>)
                <span class="ruby-identifier">rshift</span>.<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rrca</span> }
    <span class="ruby-keyword">elsif</span> (<span class="ruby-value">5</span><span class="ruby-operator">..</span><span class="ruby-value">7</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rshift</span>)
                (<span class="ruby-value">8</span><span class="ruby-operator">-</span><span class="ruby-identifier">rshift</span>).<span class="ruby-identifier">times</span> { <span class="ruby-identifier">rlca</span> }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">isolate</span> <span class="ruby-value">merge:</span><span class="ruby-identifier">merge</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># hl: screen, c&#39;: screen lo, b&#39;: counter, d&#39;: const 8, a&#39;: lines left - 1, CF&#39;: last row</span>
    <span class="ruby-comment"># e&#39;: ncols if skip_cols</span>
    <span class="ruby-identifier">ns</span> <span class="ruby-value">:line_rshift0</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">no0shift</span>
          <span class="ruby-identifier">loop0</span>     <span class="ruby-identifier">as</span>   <span class="ruby-identifier">no0shift</span>    <span class="ruby-comment"># created jump table will forward to this address</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">fx0</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">fx</span>
          <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">r</span>) <span class="ruby-keyword">do</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">r</span>
                    <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">call</span> [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-operator">-&gt;</span>(<span class="ruby-identifier">r</span>) {   <span class="ruby-identifier">ld</span> [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">r</span>   }
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">rowloop</span>     <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>        <span class="ruby-comment"># a: screen.lo</span>
                    <span class="ruby-identifier">exx</span>              <span class="ruby-comment"># regs</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># l: screen.lo (restore)</span>
        <span class="ruby-identifier">loop0</span>       <span class="ruby-identifier">label</span>
        (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">cols</span>).<span class="ruby-identifier">step</span>(<span class="ruby-value">2</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">col</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">last_column</span> = (<span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>)
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">fx0</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">e</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_column</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">sp</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">skip_cols</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ncols</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-comment"># offset last column</span>
          <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>
                    <span class="ruby-identifier">fx0</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">d</span>
          <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">last_column</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>
                    <span class="ruby-identifier">exx</span>
                    <span class="ruby-identifier">skip_cols</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_cols</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rowloop</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">next_row</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># hl: screen, m: mask, c&#39;: screen lo, b&#39;: counter, d&#39;: const 8, a&#39;: lines left - 1, CF&#39;: last row</span>
    <span class="ruby-comment"># e&#39;: ncols if skip_cols</span>
    [<span class="ruby-value">1</span>,<span class="ruby-value">7</span>,<span class="ruby-value">2</span>,<span class="ruby-value">6</span>,<span class="ruby-value">3</span>,<span class="ruby-value">5</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rshift</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">ns</span> <span class="ruby-value">:&quot;line_rshift#{rshift}&quot;</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">rowloop</span>     <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">c</span>        <span class="ruby-comment"># a: screen.lo (from c&#39;)</span>
                    <span class="ruby-identifier">exx</span>              <span class="ruby-comment"># regs</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">l</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># l: screen.lo (restore)</span>
        <span class="ruby-identifier">loop0</span>       <span class="ruby-identifier">label</span>
        (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">cols</span>).<span class="ruby-identifier">step</span>(<span class="ruby-value">2</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">col</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">last_column</span> = (<span class="ruby-identifier">col</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>)
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">de</span>          <span class="ruby-comment"># de: FEDCBA98 76543210</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>        <span class="ruby-comment"># a: 76543210</span>
                    <span class="ruby-identifier">rotate_bits</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">rshift</span>
          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">last_column</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">rclip</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">e</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># e: 32107654 (e.g. rshift=4)</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">lclip</span>
            <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span>            <span class="ruby-comment"># t: BA98FEDC</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">t</span>           <span class="ruby-comment"># a: xxxxxxxx (32107654 ^ BA98FEDC) t: BA98FEDC</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____xxxx (____7654 ^ ____FEDC) m: mask 00001111</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">t</span>           <span class="ruby-comment"># a: BA987654 (____7654 ^ ____FEDC ^ BA98FEDC) t: BA98FEDC</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:set</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, [<span class="ruby-identifier">hl</span>]     <span class="ruby-comment"># t: ssssssss</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">t</span>           <span class="ruby-comment"># a: xxxxxxxx (32107654 ^ ssssssss) t: ssssssss</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____xxxx (____7654 ^ ____ssss) m: mask 00001111</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">t</span>           <span class="ruby-comment"># a: ssss7654 (____7654 ^ ____ssss ^ ssssssss) t: ssssssss</span>
            <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____7654 m: mask 00001111</span>
            <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">call</span> [<span class="ruby-identifier">hl</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">nil?</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>     <span class="ruby-comment"># [hl]: ____7654(fx)[hl] (col=0)</span>
                                     <span class="ruby-comment">#    or ssss7654         (col=0 and :set)</span>
                                     <span class="ruby-comment">#    or BA987654(fx)[hl] (col&gt;0)</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-identifier">cut_left</span>  <span class="ruby-identifier">label</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_column</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">cols</span>.<span class="ruby-identifier">odd?</span>
                    <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">sp</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">skip_cols</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ncols</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>) <span class="ruby-comment"># offset last column</span>
            <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rclip</span>
              <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">lclip</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>           <span class="ruby-comment"># l: screen.lo (next column)</span>
              <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">if</span> <span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:set</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">lclip</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>        <span class="ruby-comment"># a: 32107654</span>
                <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">xor</span>  [<span class="ruby-identifier">hl</span>]        <span class="ruby-comment"># a: xxxxxxxx (32107654 ^ ssssssss)</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____xxxx (____7654 ^ ____ssss) m: 00001111</span>
              <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:copy</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">lclip</span>
                  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">lclip</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">e</span>        <span class="ruby-comment"># a: 32107654</span>
                  <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____7654 m: 00001111</span>
                <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">end</span>
                                     <span class="ruby-comment"># a: ____7654 (or ____7654 ^ ____ssss)</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">e</span>           <span class="ruby-comment"># a: 3210____ (or 3210ssss) e: 32107654</span>
                    <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">call</span> [<span class="ruby-identifier">hl</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">nil?</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>     <span class="ruby-comment"># [hl]: 3210____(fx)[hl]</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>        <span class="ruby-comment"># a: FEDCBA98</span>
                    <span class="ruby-identifier">rotate_bits</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">rshift</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">d</span>, <span class="ruby-identifier">a</span>        <span class="ruby-comment"># d: BA98FEDC (e.g. rshift=4)</span>

                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">e</span>           <span class="ruby-comment"># a: xxxxxxxx (BA98FEDC ^ 32107654) e: 32107654</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____xxxx (____FEDC ^ ____7654) m: mask 00001111</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">e</span>           <span class="ruby-comment"># a: 3210FEDC (____FEDC ^ ____7654 ^ 32107654) e: 32107654</span>
            <span class="ruby-keyword">unless</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">lclip</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>           <span class="ruby-comment"># l: screen.lo (next column)</span>
            <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">call</span> [<span class="ruby-identifier">hl</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">nil?</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>     <span class="ruby-comment"># [hl]: 3210FEDC(fx)[hl]</span>

            <span class="ruby-keyword">unless</span> <span class="ruby-identifier">last_column</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">rclip</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">l</span>           <span class="ruby-comment"># l: screen.lo (next column)</span>

              <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_column</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">d</span>        <span class="ruby-comment"># a: BA98FEDC (e.g. rshift=4)</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-value">:set</span>
                    <span class="ruby-identifier">xor</span>  [<span class="ruby-identifier">hl</span>]        <span class="ruby-comment"># a: xxxxxxxx (BA98FEDC ^ ssssssss)</span>
                <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">anda</span> <span class="ruby-identifier">m</span>           <span class="ruby-comment"># a: ____xxxx (____FEDC [^ ____ssss]) m: mask 00001111</span>
                    <span class="ruby-identifier">xor</span>  <span class="ruby-identifier">d</span>           <span class="ruby-comment"># a: BA98ssss (____FEDC [^ ____ssss] ^ BA98FEDC) d: BA98FEDC</span>
                    <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">call</span> [<span class="ruby-identifier">hl</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">fx</span>.<span class="ruby-identifier">nil?</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">hl</span>], <span class="ruby-identifier">a</span>     <span class="ruby-comment"># [hl]: BA98____(fx)[hl]</span>
              <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">t</span>, <span class="ruby-identifier">d</span>        <span class="ruby-comment"># t: BA98FEDC</span>
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">h</span>           <span class="ruby-comment"># h: screen.hi (next line)</span>
                    <span class="ruby-identifier">exx</span>              <span class="ruby-comment"># regs&#39;</span>
                    <span class="ruby-identifier">skip_cols</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">skip_cols</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">rowloop</span>     <span class="ruby-comment"># b&#39;: line counter</span>
                    <span class="ruby-identifier">jp</span>   <span class="ruby-identifier">next_row</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">jump_eoc</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">rshift</span> <span class="ruby-operator">!=</span> <span class="ruby-value">4</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_rshift_bitmap_pixels_7times" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_rshift_bitmap_pixels_7times</span><span
            class="method-args">(bitmap=hl, lines=c, cols=a, target:de)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that renders 7 bitmap textures by shifting 7 times each source bitmap lines by 1 bit to the right.</p>

<p>Rendered bitmaps are extended to the right by 1 column (an octet).</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>bitmap</code>
<dd>
<p>An address of a source bitmap or <code>hl</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of lines or an 8-bit register holding the number of lines. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of 8-bit columns (octets) per line or an 8-bit register holding the number.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>target</code>
<dd>
<p>A destination address where bitmaps should be rendered or <code>de</code>.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code> and some stack.</p>
          
          

          
          <div class="method-source-code" id="bobs_rshift_bitmap_pixels_7times-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 971</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_rshift_bitmap_pixels_7times</span>(<span class="ruby-identifier">bitmap</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">target:</span><span class="ruby-identifier">de</span>)
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">c</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-value">7</span>
                    <span class="ruby-identifier">scf</span>
    <span class="ruby-identifier">bitloop</span>         <span class="ruby-identifier">push</span> <span class="ruby-identifier">bc</span>
                    <span class="ruby-identifier">push</span> <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">bobs_rshift_bitmap_pixels_once</span>
                    <span class="ruby-identifier">adc</span>  <span class="ruby-identifier">a</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">pop</span>  <span class="ruby-identifier">bc</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">bitloop</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bobs_rshift_bitmap_pixels_once" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bobs_rshift_bitmap_pixels_once</span><span
            class="method-args">(bitmap=hl, lines=c, cols=a, target:de)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Creates a routine that renders a bitmap texture by shifting each source bitmap lines by 1 bit to the right.</p>
<ul><li><dl class="rdoc-list note-list"><dt>Carry Flag
<dd>
<p>If set (CF=1) indicates that the target bitmap should be extended by one additional column holding the bits right-shifted out of the last source bitmap column. Otherwise (if CF=0) the carried out bits are lost. The Carry Flag value is preserved when the routine exits.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>bitmap</code>
<dd>
<p>An address of a source bitmap or <code>hl</code>.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>lines</code>
<dd>
<p>A number of lines or an 8-bit register holding the number of lines. The number 0 is treated as 256 and most likely will lead to UNDEFINED BEHAVIOUR.</p>
</dd></dl>
</li><li><dl class="rdoc-list note-list"><dt><code>cols</code>
<dd>
<p>A number of 8-bit columns (octets) per line or an 8-bit register holding the number.</p>
</dd></dl>
</li></ul>

<p>Options:</p>
<ul><li><dl class="rdoc-list note-list"><dt><code>target</code>
<dd>
<p>A destination address where bitmap should be rendered or <code>de</code>.</p>
</dd></dl>
</li></ul>

<p>Modifies: <code>af</code>, <code>af&#39;</code>, <code>bc</code>, <code>de</code>, <code>hl</code>.</p>
          
          

          
          <div class="method-source-code" id="bobs_rshift_bitmap_pixels_once-source">
            <pre><span class="ruby-comment"># File lib/zxlib/gfx/bobs.rb, line 1013</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bobs_rshift_bitmap_pixels_once</span>(<span class="ruby-identifier">bitmap</span>=<span class="ruby-identifier">hl</span>, <span class="ruby-identifier">lines</span>=<span class="ruby-identifier">c</span>, <span class="ruby-identifier">cols</span>=<span class="ruby-identifier">a</span>, <span class="ruby-value">target:</span><span class="ruby-identifier">de</span>)
  <span class="ruby-identifier">isolate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">address?</span>(<span class="ruby-identifier">lines</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pointer?</span>(<span class="ruby-identifier">lines</span>)
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">lines</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
    <span class="ruby-keyword">else</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">c</span>, <span class="ruby-identifier">lines</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">c</span>
    <span class="ruby-keyword">end</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-identifier">cols</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cols</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">hl</span>, <span class="ruby-identifier">bitmap</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bitmap</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">de</span>, <span class="ruby-identifier">target</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">de</span>
    <span class="ruby-identifier">line_start</span>      <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">b</span>, <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>        <span class="ruby-comment"># a&#39;: cols, CF&#39;: 1 extend cols (right margin)</span>
                    <span class="ruby-identifier">ora</span>  <span class="ruby-identifier">a</span>             <span class="ruby-comment"># CF: 0</span>
    <span class="ruby-identifier">line_loop</span>       <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, [<span class="ruby-identifier">hl</span>]
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">hl</span>
                    <span class="ruby-identifier">rra</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">de</span>], <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">djnz</span> <span class="ruby-identifier">line_loop</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NC</span>, <span class="ruby-identifier">skip_last</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
                    <span class="ruby-identifier">ld</span>   <span class="ruby-identifier">a</span>, <span class="ruby-value">0</span>
                    <span class="ruby-identifier">rra</span>
                    <span class="ruby-identifier">ld</span>   [<span class="ruby-identifier">de</span>], <span class="ruby-identifier">a</span>
                    <span class="ruby-identifier">inc</span>  <span class="ruby-identifier">de</span>
                    <span class="ruby-identifier">ex</span>   <span class="ruby-identifier">af</span>, <span class="ruby-identifier">af</span>
    <span class="ruby-identifier">skip_last</span>       <span class="ruby-identifier">dec</span>  <span class="ruby-identifier">c</span>
                    <span class="ruby-identifier">jr</span>   <span class="ruby-constant">NZ</span>, <span class="ruby-identifier">line_start</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

